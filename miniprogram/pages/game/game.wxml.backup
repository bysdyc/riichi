<!-- pages/game/game.wxml -->
<view class="game-container">
  <!-- æ¸¸æˆçŠ¶æ€æ  -->
  <view class="game-status">
    <view class="status-item">
      <text class="status-label">åœºå†µï¼š</text>
      <text class="status-value">{{windText}}{{gameState.round}}å±€</text>
    </view>
    <view class="status-item">
      <text class="status-label">æœ¬åœºï¼š</text>
      <text class="status-value">{{gameState.honba}}</text>
    </view>
    <view class="status-item">
      <text class="status-label">ç«‹ç›´æ£’ï¼š</text>
      <text class="status-value">{{gameState.riichiSticks}}</text>
    </view>
  </view>

  <!-- ç©å®¶ä¿¡æ¯å¡ç‰‡ -->
  <view class="players-section">
    <view 
      wx:for="{{players}}" 
      wx:key="id" 
      class="player-card {{item.isDealer ? 'dealer' : ''}} {{item.isRiichi ? 'riichi' : ''}}"
    >
      <view class="player-header">
        <view class="player-wind">{{item.wind}}</view>
        <view class="player-name">{{item.name}}</view>
        <view wx:if="{{item.isDealer}}" class="dealer-badge">åº„</view>
        <view wx:if="{{item.isRiichi}}" class="riichi-badge">ç«‹</view>
      </view>
      <view class="player-score">{{item.score}}</view>
      <button 
        class="btn-riichi-toggle" 
        size="mini"
        bindtap="toggleRiichi" 
        data-index="{{index}}"
      >
        {{item.isRiichi ? 'å–æ¶ˆç«‹ç›´' : 'ç«‹ç›´'}}
      </button>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’®åŒº -->
  <view class="actions-section">
    <button class="btn-action btn-win" bindtap="showWinDialog">å’Œç‰Œ</button>
    <button class="btn-action btn-draw" bindtap="showDrawDialog">æµå±€</button>
    <button class="btn-action btn-history" bindtap="showHistory">å†å²</button>
    <button class="btn-action btn-settings" bindtap="showSettings">è®¾ç½®</button>
  </view>

  <!-- å’Œç‰Œå¯¹è¯æ¡† -->
  <view wx:if="{{showWinDialog}}" class="dialog-mask" bindtap="closeWinDialog">
    <view class="dialog-content large" catchtap="stopPropagation">
      <view class="dialog-title">è®°å½•å’Œç‰Œ</view>
      
      <!-- è¾“å…¥æ¨¡å¼åˆ‡æ¢ -->
      <view class="mode-switch">
        <button 
          class="btn-mode {{inputMode === 'hand' ? 'active' : ''}}" 
          size="mini"
          bindtap="switchInputMode" 
          data-mode="hand"
        >
          æ‰‹ç‰Œè¾“å…¥
        </button>
        <button 
          class="btn-mode {{inputMode === 'manual' ? 'active' : ''}}" 
          size="mini"
          bindtap="switchInputMode" 
          data-mode="manual"
        >
          æ‰‹åŠ¨è¾“å…¥
        </button>
        <button 
          class="btn-mode {{inputMode === 'multi' ? 'active' : ''}}" 
          size="mini"
          bindtap="switchInputMode" 
          data-mode="multi"
        >
          å¤šäººå’Œç‰Œ
        </button>
      </view>
      
      <!-- é€‰æ‹©å’Œç‰Œæ–¹å¼ -->
      <view wx:if="{{inputMode !== 'multi'}}" class="win-type-section">
        <button 
          class="btn-win-type {{isTsumo ? 'active' : ''}}" 
          bindtap="setWinType" 
          data-type="tsumo"
        >
          è‡ªæ‘¸
        </button>
        <button 
          class="btn-win-type {{!isTsumo ? 'active' : ''}}" 
          bindtap="setWinType" 
          data-type="ron"
        >
          è£å’Œ
        </button>
      </view>

      <!-- é€‰æ‹©å’Œç‰Œè€… -->
      <view class="player-selection">
        <text class="selection-label">å’Œç‰Œè€…ï¼š</text>
        <view class="player-buttons">
          <button 
            wx:for="{{players}}" 
            wx:key="id"
            class="btn-player {{winnerIndex === index ? 'active' : ''}}"
            bindtap="selectWinner"
            data-index="{{index}}"
          >
            {{item.name}}
          </button>
        </view>
      </view>

      <!-- é€‰æ‹©æ”¾é“³è€…ï¼ˆè£å’Œæ—¶ï¼‰ -->
      <view wx:if="{{!isTsumo}}" class="player-selection">
        <text class="selection-label">æ”¾é“³è€…ï¼š</text>
        <view class="player-buttons">
          <button 
            wx:for="{{players}}" 
            wx:key="id"
            wx:if="{{index !== winnerIndex}}"
            class="btn-player {{loserIndex === index ? 'active' : ''}}"
            bindtap="selectLoser"
            data-index="{{index}}"
          >
            {{item.name}}
          </button>
        </view>
      </view>

      <!-- æ‰‹ç‰Œè¾“å…¥æ¨¡å¼ -->
      <view wx:if="{{inputMode === 'hand'}}" class="hand-input-section">
        <!-- æ‰‹ç‰Œæ˜¾ç¤ºåŒº -->
        <view class="current-hand">
          <text class="hand-label">å½“å‰æ‰‹ç‰Œï¼ˆ{{handTiles.length}}å¼ ï¼‰ï¼š</text>
          <view class="hand-display">
            <view wx:for="{{handTiles}}" wx:key="index" class="hand-tile">
              {{getTileDisplay(item)}}
            </view>
            <button 
              wx:if="{{handTiles.length < 13}}" 
              class="btn-add-tile" 
              size="mini"
              bindtap="showTileSelector"
              data-type="hand"
            >
              +é€‰æ‹©æ‰‹ç‰Œ
            </button>
          </view>
        </view>

        <!-- å‰¯éœ²åŒº -->
        <view class="meld-section">
          <text class="hand-label">å‰¯éœ²ï¼ˆ{{melds.length}}ç»„ï¼‰ï¼š</text>
          <view class="meld-display">
            <view wx:for="{{melds}}" wx:key="index" class="meld-group">
              <text class="meld-type">{{item.typeName}}</text>
              <view class="meld-tiles">
                <text wx:for="{{item.tiles}}" wx:for-item="tile" wx:key="tile" class="meld-tile">
                  {{getTileDisplay(tile)}}
                </text>
              </view>
              <text class="btn-remove-meld" bindtap="removeMeld" data-index="{{index}}">Ã—</text>
            </view>
            <button 
              wx:if="{{melds.length < 4}}" 
              class="btn-add-meld" 
              size="mini"
              bindtap="showMeldDialog"
            >
              +æ·»åŠ å‰¯éœ²
            </button>
          </view>
        </view>

        <!-- å’Œç‰Œ -->
        <view class="win-tile-section">
          <text class="hand-label">å’Œç‰Œï¼š</text>
          <view class="win-tile-display">
            <view wx:if="{{winTile}}" class="win-tile-item">
              {{getTileDisplay(winTile)}}
              <text class="btn-remove-win" bindtap="clearWinTile">Ã—</text>
            </view>
            <button 
              wx:else
              class="btn-select-win" 
              size="mini"
              bindtap="showTileSelector"
              data-type="win"
            >
              é€‰æ‹©å’Œç‰Œ
            </button>
          </view>
        </view>

        <!-- çŠ¶å†µå½¹ -->
        <view class="yaku-conditions">
          <text class="hand-label">çŠ¶å†µå½¹ï¼š</text>
          <view class="condition-checks">
            <checkbox-group bindchange="conditionChange">
              <label><checkbox value="riichi" checked="{{isRiichi}}"/>ç«‹ç›´</label>
              <label><checkbox value="ippatsu" checked="{{isIppatsu}}"/>ä¸€å‘</label>
              <label><checkbox value="doubleRiichi" checked="{{isDoubleRiichi}}"/>åŒç«‹ç›´</label>
              <label><checkbox value="haitei" checked="{{isHaitei}}"/>æµ·åº•</label>
              <label><checkbox value="houtei" checked="{{isHoutei}}"/>æ²³åº•</label>
              <label><checkbox value="rinshan" checked="{{isRinshan}}"/>å²­ä¸Š</label>
              <label><checkbox value="chankan" checked="{{isChankan}}"/>æŠ¢æ </label>
            </checkbox-group>
          </view>
        </view>

        <!-- åˆ†æç»“æœ -->
        <view wx:if="{{analysisResult}}" class="analysis-result">
          <view class="result-header">
            <text class="result-title">åˆ†æç»“æœ</text>
            <button class="btn-reanalyze" size="mini" bindtap="analyzeHand">é‡æ–°åˆ†æ</button>
          </view>
          <view class="result-yaku">
            <text class="yaku-label">å½¹ç§ï¼š</text>
            <text class="yaku-list">{{analysisResult.yaku}}</text>
          </view>
          <view class="result-han-fu">
            <text>{{analysisResult.han}}ç•ª{{analysisResult.fu}}ç¬¦</text>
          </view>
        </view>

        <view wx:if="{{analysisError}}" class="analysis-error">
          <text>{{analysisError}}</text>
        </view>

        <!-- åˆ†ææŒ‰é’® -->
        <button 
          wx:if="{{handTiles.length + melds.length * 3 === 13 && winTile}}"
          class="btn-analyze" 
          bindtap="analyzeHand"
        >
          åˆ†æç‰Œå‹
        </button>
      </view>

      <!-- æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ï¼ˆåŸæœ‰çš„ç•ªç¬¦è¾“å…¥ï¼‰ -->
      <view wx:if="{{inputMode === 'manual'}}" class="manual-input-section">
        <view class="han-fu-input">
          <view class="input-group">
            <text class="input-label">ç•ªæ•°ï¼š</text>
            <input 
              class="input-field" 
              type="number" 
              value="{{han}}" 
              bindinput="inputHan"
              placeholder="1"
            />
          </view>
          <view class="input-group">
            <text class="input-label">ç¬¦æ•°ï¼š</text>
            <input 
              class="input-field" 
              type="number" 
              value="{{fu}}" 
              bindinput="inputFu"
              placeholder="30"
            />
          </view>
        </view>
      </view>

      <!-- å¤šäººå’Œç‰Œæ¨¡å¼ -->
      <view wx:if="{{inputMode === 'multi'}}" class="multi-win-section">
        <view class="multi-win-notice">
          <text>âš ï¸ ä¸‰å®¶å’Œï¼ˆä¸‰éº»ï¼‰ï¼šåŒæ—¶å¤šäººè£å’Œ</text>
        </view>

        <!-- é€‰æ‹©æ”¾é“³è€… -->
        <view class="player-selection">
          <text class="selection-label">æ”¾é“³è€…ï¼š</text>
          <view class="player-buttons">
            <button 
              wx:for="{{players}}" 
              wx:key="id"
              class="btn-player {{multiLoserIndex === index ? 'active' : ''}}"
              bindtap="selectMultiLoser"
              data-index="{{index}}"
            >
              {{item.name}}
            </button>
          </view>
        </view>

        <!-- å’Œç‰Œè€…åˆ—è¡¨ -->
        <view class="multi-winners">
          <text class="selection-label">å’Œç‰Œè€…ï¼ˆå¯å¤šé€‰ï¼‰ï¼š</text>
          <view wx:for="{{players}}" wx:key="id" class="multi-winner-item">
            <checkbox-group bindchange="toggleMultiWinner" data-index="{{index}}">
              <label class="multi-winner-label">
                <checkbox 
                  value="{{index}}" 
                  checked="{{multiWinners[index]}}"
                  disabled="{{multiLoserIndex === index}}"
                />
                <text>{{item.name}}</text>
              </label>
            </checkbox-group>
            
            <!-- å¦‚æœé€‰ä¸­ï¼Œæ˜¾ç¤ºç•ªç¬¦è¾“å…¥ -->
            <view wx:if="{{multiWinners[index]}}" class="winner-han-fu">
              <input 
                class="mini-input" 
                type="number" 
                placeholder="ç•ª"
                value="{{multiHanFu[index].han}}"
                bindinput="inputMultiHan"
                data-index="{{index}}"
              />
              <text>ç•ª</text>
              <input 
                class="mini-input" 
                type="number" 
                placeholder="ç¬¦"
                value="{{multiHanFu[index].fu}}"
                bindinput="inputMultiFu"
                data-index="{{index}}"
              />
              <text>ç¬¦</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å®ç‰Œè¾“å…¥ï¼ˆéå¤šäººå’Œç‰Œæ¨¡å¼ï¼‰ -->
      <view wx:if="{{inputMode !== 'multi'}}" class="dora-input">
        <view class="input-group">
          <text class="input-label">å®ç‰Œï¼š</text>
          <input 
            class="input-field" 
            type="number" 
            value="{{dora}}" 
            bindinput="inputDora"
            placeholder="0"
          />
        </view>
        <view class="input-group">
          <text class="input-label">é‡Œå®ï¼š</text>
          <input 
            class="input-field" 
            type="number" 
            value="{{uraDora}}" 
            bindinput="inputUraDora"
            placeholder="0"
          />
        </view>
        <view class="input-group">
          <text class="input-label">çº¢å®ï¼š</text>
          <input 
            class="input-field" 
            type="number" 
            value="{{redDora}}" 
            bindinput="inputRedDora"
            placeholder="0"
          />
        </view>
      </view>

      <!-- æ˜¾ç¤ºè®¡ç®—ç»“æœ -->
      <view wx:if="{{pointsPreview}}" class="points-preview">
        <text class="preview-label">ç‚¹æ•°é¢„è§ˆï¼š</text>
        <text class="preview-value">{{pointsPreview}}</text>
      </view>

      <!-- å¯¹è¯æ¡†æŒ‰é’® -->
      <view class="dialog-actions">
        <button class="btn-dialog-cancel" bindtap="closeWinDialog">å–æ¶ˆ</button>
        <button class="btn-dialog-confirm" bindtap="confirmWin">ç¡®è®¤</button>
      </view>
    </view>
  </view>

  <!-- æµå±€å¯¹è¯æ¡† -->
  <view wx:if="{{showDrawDialog}}" class="dialog-mask" bindtap="closeDrawDialog">
    <view class="dialog-content" catchtap="stopPropagation">
      <view class="dialog-title">è®°å½•æµå±€</view>
      
      <view class="tenpai-selection">
        <text class="selection-label">å¬ç‰Œç©å®¶ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰ï¼š</text>
        <view class="player-buttons">
          <button 
            wx:for="{{players}}" 
            wx:key="id"
            class="btn-player {{tenpaiedPlayers[index] ? 'active' : ''}}"
            bindtap="toggleTenpai"
            data-index="{{index}}"
          >
            {{item.name}}
          </button>
        </view>
      </view>

      <view class="dialog-actions">
        <button class="btn-dialog-cancel" bindtap="closeDrawDialog">å–æ¶ˆ</button>
        <button class="btn-dialog-confirm" bindtap="confirmDraw">ç¡®è®¤æµå±€</button>
      </view>
    </view>
  </view>

  <!-- ç‰Œé€‰æ‹©å™¨å¯¹è¯æ¡† -->
  <view wx:if="{{showTileSelectorDialog}}" class="dialog-mask" bindtap="closeTileSelector">
    <view class="dialog-content large" catchtap="stopPropagation">
      <tile-selector 
        title="{{tileSelectorTitle}}"
        maxTiles="{{tileSelectorMax}}"
        initialTiles="{{tileSelectorInitial}}"
        bind:confirm="onTileSelected"
        bind:change="onTileChange"
      ></tile-selector>
    </view>
  </view>

  <!-- å‰¯éœ²å¯¹è¯æ¡† -->
  <view wx:if="{{showMeldDialog}}" class="dialog-mask" bindtap="closeMeldDialog">
    <view class="dialog-content" catchtap="stopPropagation">
      <view class="dialog-title">æ·»åŠ å‰¯éœ²</view>
      
      <view class="meld-type-selection">
        <button 
          wx:for="{{meldTypes}}" 
          wx:key="id"
          class="btn-meld-type {{selectedMeldType === item.id ? 'active' : ''}}"
          bindtap="selectMeldType"
          data-type="{{item.id}}"
        >
          {{item.name}}
        </button>
      </view>

      <view class="meld-tiles-selection">
        <text class="selection-label">é€‰æ‹©ç‰Œï¼ˆ{{meldTileCount[selectedMeldType]}}å¼ ï¼‰ï¼š</text>
        <tile-selector 
          title=""
          maxTiles="{{meldTileCount[selectedMeldType]}}"
          bind:confirm="confirmMeld"
        ></tile-selector>
      </view>
    </view>
  </view>

  <!-- æ¸¸æˆç»“æŸå¯¹è¯æ¡† -->
  <view wx:if="{{isGameOver}}" class="dialog-mask">
    <view class="dialog-content game-over">
      <view class="dialog-title">ğŸ‰ æ¸¸æˆç»“æŸ</view>
      
      <view class="final-ranking">
        <view wx:for="{{finalRanking}}" wx:key="id" class="ranking-item">
          <text class="rank">{{index + 1}}ä½</text>
          <text class="player-name">{{item.name}}</text>
          <text class="score">{{item.score}}</text>
        </view>
      </view>

      <view class="dialog-actions">
        <button class="btn-dialog-confirm" bindtap="backToHome">è¿”å›é¦–é¡µ</button>
      </view>
    </view>
  </view>
</view>
