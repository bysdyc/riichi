<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—¥æœ¬éº»å°†è®°å½•å™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.js"></script>
  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -20px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-emerald-100">

  <div id="root"></div>
  
  <!-- Toastæç¤ºå®¹å™¨ -->
  <div id="toast-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // ====================================================================
      // 1. STATE
      // ====================================================================
      
      let gameSettings = null; // { type: 'tonpuu' | 'hanchan' | 'yonchan', tobu: boolean }
      let isGameOver = false;
      let players = [
        { id: 1, name: 'ä¸œå®¶', score: 25000, wind: 'æ±', isRiichi: false },
        { id: 2, name: 'å—å®¶', score: 25000, wind: 'å—', isRiichi: false },
        { id: 3, name: 'è¥¿å®¶', score: 25000, wind: 'è¥¿', isRiichi: false },
        { id: 4, name: 'åŒ—å®¶', score: 25000, wind: 'åŒ—', isRiichi: false }
      ];
      
      let gameState = {
        wind: 'east', // 'east' | 'south' | 'west' | 'north'
        round: 1,    // 1-4
        honba: 0,    // æœ¬åœº
        riichiSticks: 0 // ç«‹ç›´æ£’
      };
      
      let currentDealerIndex = 0;
      let roundHistory = [];
      let showScoreInput = false;
      let showHistory = false;
      let multiWinType = null; // 'multi' è¡¨ç¤ºå¤šäººå’Œç‰Œ
      let multiWinScores = [0, 0, 0, 0]; // å¤šäººå’Œç‰Œæ—¶æ¯ä¸ªäººçš„åˆ†æ•°å˜åŒ–
      // å¤šäººå’Œç‰Œæ€»æ˜¯è£å’Œ(ä¸‰å®¶å’Œä¸å¯èƒ½è‡ªæ‘¸)
      let multiWinners = []; // å¤šäººå’Œç‰Œæ—¶çš„å’Œç‰Œè€…ç´¢å¼•æ•°ç»„
      let multiWinLoser = null; // å¤šäººå’Œç‰Œæ—¶çš„æ”¾é“³è€…
      let multiWinHanFu = {}; // å¤šäººå’Œç‰Œæ—¶æ¯ä¸ªå’Œç‰Œè€…çš„ç•ªæ•°ç¬¦æ•° { [winnerIndex]: { han: 1, fu: 30 } }
      
      let winnerIndex = null;
      let loserIndex = null;
      let isTsumo = true;
      let selectedTiles = [];
      let melds = []; // å‰¯éœ²åŒºï¼š[{ type: 'shuntsu'|'pon'|'minkan'|'ankan', tiles: [...] }]
      let winTile = null;
      let isMenzen = true;
      let isRiichi = false;
      let isIppatsu = false;
      let isDoubleRiichi = false; // åŒç«‹ç›´/äºŒç«‹ç›´
      let isTenhou = false; // å¤©å’Œ
      let isChiihou = false; // åœ°å’Œ
      let isRenhou = false; // äººå’Œ
      let isHaitei = false; // æµ·åº•ææœˆ
      let isHoutei = false; // æ²³åº•æ‘¸é±¼
      let isRinshan = false; // å²­ä¸Šå¼€èŠ±
      let isChankan = false; // æŠ¢æ 
      let dora = 0;
      let uraDora = 0;
      let redDora = 0;
      
      let tenpaiWaits = [];
      let analysisError = null;
      
      let isManualMode = false; // æ‰‹åŠ¨é€‰æ‹©å½¹ç§æ¨¡å¼
      let manualYaku = []; // æ‰‹åŠ¨é€‰æ‹©çš„å½¹ç§åˆ—è¡¨
      let manualFu = 40; // æ‰‹åŠ¨æ¨¡å¼ä¸‹çš„ç¬¦æ•°
      let isManualFuro = false; // æ‰‹åŠ¨æ¨¡å¼ä¸‹çš„å‰¯éœ²çŠ¶æ€ï¼ˆä»…å½±å“ç•ªæ•°è®¡ç®—ï¼Œä¸å½±å“æ‰‹ç‰Œï¼‰
      let isExpertMode = false; // è€æ‰‹æ¨¡å¼ï¼šç›´æ¥è¾“å…¥ç•ªæ•°å’Œç¬¦æ•°
      let expertHan = 1; // è€æ‰‹æ¨¡å¼ä¸‹çš„ç•ªæ•°
      let expertFu = 30; // è€æ‰‹æ¨¡å¼ä¸‹çš„ç¬¦æ•°
      
      let showDrawDialog = false;
      let tenpaiedPlayers = [];
      let drawRiichiPlayers = []; // æµå±€æ—¶ç«‹ç›´çš„ç©å®¶
      let isStartingHandDraw = false; // æ˜¯å¦æ˜¯å¼€å±€æµå±€ï¼ˆç‚¹æ•°ä¸å˜ï¼Œä½†å±€æ•°å¢åŠ ï¼‰
      
      // æµå±€æ»¡è´¯ç›¸å…³
      let showNagashiMangan = false; // æ˜¯å¦å±•å¼€æµå±€æ»¡è´¯é€‰é¡¹
      let nagashiManganPlayers = []; // æµå±€æ»¡è´¯çš„ç©å®¶

      // æ–°å¢ï¼šç‰Œé€‰æ‹©å™¨çš„æ¿€æ´»åŒºåŸŸ
      let activeTileArea = 'hand'; // 'hand' | 'meld' | 'win'
      let pendingMeldType = null; // ç­‰å¾…æ·»åŠ çš„å‰¯éœ²ç±»å‹
      
      // æ–°å¢ï¼šçŠ¶å†µå½¹å±•å¼€/æŠ˜å çŠ¶æ€
      let isYakuExpanded = false; // é»˜è®¤æŠ˜å 

      // æ–°å¢ï¼šToastæç¤ºç³»ç»Ÿ
      let toastMessage = '';
      let toastVisible = false;
      let toastTimer = null;

      // ====================================================================
      // 1.5 æœ¬åœ°å­˜å‚¨ (LocalStorage)
      // ====================================================================

      const STORAGE_KEY = 'mahjong_game_state';

      // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ° localStorageï¼ˆä»…åœ¨ç»“ç®—åè°ƒç”¨ï¼‰
      // åªä¿å­˜å¿…è¦çš„æ¸¸æˆè¿›åº¦ä¿¡æ¯ï¼Œä¸ä¿å­˜ä¸´æ—¶UIçŠ¶æ€
      const saveGameState = () => {
        try {
          const state = {
            gameSettings,           // æ¸¸æˆç±»å‹ï¼ˆä¸œé£/åŠåº„/å…¨åº„ï¼‰
            isGameOver,             // æ˜¯å¦ç»“æŸ
            players,                // ç©å®¶ä¿¡æ¯ï¼ˆå§“åã€åˆ†æ•°ã€ç«‹ç›´çŠ¶æ€ï¼‰
            gameState,              // å½“å‰å±€æ•°ä¿¡æ¯ï¼ˆé£ä½ã€å±€æ•°ã€æœ¬åœºã€ç«‹ç›´æ£’ï¼‰
            currentDealerIndex,     // å½“å‰åº„å®¶ç´¢å¼•
            roundHistory,           // å¯¹å±€å†å²è®°å½•
            savedAt: new Date().toISOString()
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          // console.log('ğŸ’¾ æ¸¸æˆçŠ¶æ€å·²ä¿å­˜ (ç»“ç®—åä¿å­˜)');
        } catch (error) {
          console.error('âŒ ä¿å­˜æ¸¸æˆçŠ¶æ€å¤±è´¥:', error);
        }
      };

      // ä» localStorage åŠ è½½æ¸¸æˆçŠ¶æ€
      const loadGameState = () => {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (!saved) {
            // console.log('ğŸ“­ æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ¸¸æˆçŠ¶æ€');
            return false;
          }

          const state = JSON.parse(saved);
          // console.log('ğŸ“¦ è¯»å–åˆ°ä¿å­˜çš„çŠ¶æ€:', state);
          
          // åªæ¢å¤å¿…è¦çš„æ¸¸æˆè¿›åº¦æ•°æ®
          gameSettings = state.gameSettings;
          isGameOver = state.isGameOver || false;
          players = state.players || players;
          gameState = state.gameState || gameState;
          currentDealerIndex = state.currentDealerIndex || 0;
          roundHistory = state.roundHistory || [];

          // console.log('âœ… æ¸¸æˆçŠ¶æ€å·²æ¢å¤ (ä¿å­˜æ—¶é—´:', state.savedAt, ')');
          // console.log('âœ… gameSettings å·²æ¢å¤ä¸º:', gameSettings);
          return true;
        } catch (error) {
          console.error('âŒ åŠ è½½æ¸¸æˆçŠ¶æ€å¤±è´¥:', error);
          return false;
        }
      };

      // æ¸…é™¤ä¿å­˜çš„æ¸¸æˆçŠ¶æ€
      const clearGameState = () => {
        try {
          localStorage.removeItem(STORAGE_KEY);
          // console.log('æ¸¸æˆçŠ¶æ€å·²æ¸…é™¤');
        } catch (error) {
          console.error('æ¸…é™¤æ¸¸æˆçŠ¶æ€å¤±è´¥:', error);
        }
      };

      // ====================================================================
      // 2. æ•°æ®å®šä¹‰ (Tiles Definition)
      // ====================================================================
      
      const tileTypes = {
        man: ['ä¸€ä¸‡', 'äºŒä¸‡', 'ä¸‰ä¸‡', 'å››ä¸‡', 'äº”ä¸‡', 'å…­ä¸‡', 'ä¸ƒä¸‡', 'å…«ä¸‡', 'ä¹ä¸‡'],
        pin: ['ä¸€ç­’', 'äºŒç­’', 'ä¸‰ç­’', 'å››ç­’', 'äº”ç­’', 'å…­ç­’', 'ä¸ƒç­’', 'å…«ç­’', 'ä¹ç­’'],
        // (ä¿®å¤ 1) ä¿®æ­£ 6ç´¢
        sou: ['ä¸€ç´¢', 'äºŒç´¢', 'ä¸‰ç´¢', 'å››ç´¢', 'äº”ç´¢', 'å…­ç´¢', 'ä¸ƒç´¢', 'å…«ç´¢', 'ä¹ç´¢'],
        honor: ['ä¸œ', 'å—', 'è¥¿', 'åŒ—', 'ç™½', 'å‘', 'ä¸­']
      };
      
      const internalTiles = [
        '1m', '2m', '3m', '4m', '5m', '6m', '7m', '8m', '9m',
        '1p', '2p', '3p', '4p', '5p', '6p', '7p', '8p', '9p',
        '1s', '2s', '3s', '4s', '5s', '6s', '7s', '8s', '9s',
        '1z', '2z', '3z', '4z', '5z', '6z', '7z'
      ];
      const displayToInternal = {
        'ä¸€ä¸‡': '1m', 'äºŒä¸‡': '2m', 'ä¸‰ä¸‡': '3m', 'å››ä¸‡': '4m', 'äº”ä¸‡': '5m', 'å…­ä¸‡': '6m', 'ä¸ƒä¸‡': '7m', 'å…«ä¸‡': '8m', 'ä¹ä¸‡': '9m',
        'ä¸€ç­’': '1p', 'äºŒç­’': '2p', 'ä¸‰ç­’': '3p', 'å››ç­’': '4p', 'äº”ç­’': '5p', 'å…­ç­’': '6p', 'ä¸ƒç­’': '7p', 'å…«ç­’': '8p', 'ä¹ç­’': '9p',
        'ä¸€ç´¢': '1s', 'äºŒç´¢': '2s', 'ä¸‰ç´¢': '3s', 'å››ç´¢': '4s', 'äº”ç´¢': '5s', 'å…­ç´¢': '6s', 'ä¸ƒç´¢': '7s', 'å…«ç´¢': '8s', 'ä¹ç´¢': '9s',
        'ä¸œ': '1z', 'å—': '2z', 'è¥¿': '3z', 'åŒ—': '4z', 'ç™½': '5z', 'å‘': '6z', 'ä¸­': '7z',
      };
      const internalToDisplay = Object.fromEntries(Object.entries(displayToInternal).map(a => a.reverse()));
      const allDisplayTiles = [...tileTypes.man, ...tileTypes.pin, ...tileTypes.sou, ...tileTypes.honor];
      const allInternalTilesForWait = [...internalTiles];

      const terminals = ['1m', '9m', '1p', '9p', '1s', '9s'];
      const honors = ['1z', '2z', '3z', '4z', '5z', '6z', '7z'];
      const yaochuuhai = [...terminals, ...honors];

      // æ‰‹åŠ¨é€‰æ‹©å½¹ç§çš„å®šä¹‰
      const allYakuList = [
        // å½¹æ»¡
        { id: 'kokushi13', name: 'å›½å£«æ— åŒåä¸‰é¢', han: 26, category: 'yakuman' },
        { id: 'kokushi', name: 'å›½å£«æ— åŒ', han: 13, category: 'yakuman' },
        { id: 'suuankou_tanki', name: 'å››æš—åˆ»å•éª‘', han: 26, category: 'yakuman' },
        { id: 'suuankou', name: 'å››æš—åˆ»', han: 13, category: 'yakuman' },
        { id: 'daisangen', name: 'å¤§ä¸‰å…ƒ', han: 13, category: 'yakuman' },
        { id: 'daisuushii', name: 'å¤§å››å–œ', han: 26, category: 'yakuman' },
        { id: 'shousuushii', name: 'å°å››å–œ', han: 13, category: 'yakuman' },
        { id: 'tsuuiisou', name: 'å­—ä¸€è‰²', han: 13, category: 'yakuman' },
        { id: 'chinroutou', name: 'æ¸…è€å¤´', han: 13, category: 'yakuman' },
        { id: 'ryuuiisou', name: 'ç»¿ä¸€è‰²', han: 13, category: 'yakuman' },
        { id: 'chuuren9', name: 'çº¯æ­£ä¹è²å®ç¯', han: 26, category: 'yakuman' },
        { id: 'chuuren', name: 'ä¹è²å®ç¯', han: 13, category: 'yakuman' },
        { id: 'tenhou', name: 'å¤©å’Œ', han: 13, category: 'yakuman' },
        { id: 'chiihou', name: 'åœ°å’Œ', han: 13, category: 'yakuman' },
        { id: 'renhou', name: 'äººå’Œ', han: 13, category: 'yakuman' },
        
        // 6ç•ª
        { id: 'chinitsu', name: 'æ¸…ä¸€è‰²', han: 6, hanNaki: 5, category: '6han' },
        
        // 3ç•ª
        { id: 'honitsu', name: 'æ··ä¸€è‰²', han: 3, hanNaki: 2, category: '3han' },
        { id: 'junchan', name: 'çº¯å…¨å¸¦å¹ºä¹', han: 3, hanNaki: 2, category: '3han' },
        { id: 'ryanpeikou', name: 'ä¸¤æ¯å£', han: 3, category: '3han' },
        
        // 2ç•ª
        { id: 'chiitoitsu', name: 'ä¸ƒå¯¹å­', han: 2, category: '2han' },
        { id: 'toitoi', name: 'å¯¹å¯¹å’Œ', han: 2, category: '2han' },
        { id: 'sanankou', name: 'ä¸‰æš—åˆ»', han: 2, category: '2han' },
        { id: 'honroutou', name: 'æ··è€å¤´', han: 2, category: '2han' },
        { id: 'shousangen', name: 'å°ä¸‰å…ƒ', han: 2, category: '2han' },
        { id: 'sanshoku_doujun', name: 'ä¸‰è‰²åŒé¡º', han: 2, hanNaki: 1, category: '2han' },
        { id: 'sanshoku_doukou', name: 'ä¸‰è‰²åŒåˆ»', han: 2, category: '2han' },
        { id: 'ittsu', name: 'ä¸€æ°”é€šè´¯', han: 2, hanNaki: 1, category: '2han' },
        { id: 'chanta', name: 'æ··å…¨å¸¦å¹ºä¹', han: 2, hanNaki: 1, category: '2han' },
        { id: 'double_riichi', name: 'åŒç«‹ç›´', han: 2, category: '2han' },
        
        // 1ç•ª
        { id: 'riichi', name: 'ç«‹ç›´', han: 1, category: '1han' },
        { id: 'ippatsu', name: 'ä¸€å‘', han: 1, category: '1han' },
        { id: 'tsumo', name: 'é—¨å‰æ¸…è‡ªæ‘¸å’Œ', han: 1, category: '1han' },
        { id: 'yakuhai_haku', name: 'å½¹ç‰Œ(ç™½)', han: 1, category: '1han' },
        { id: 'yakuhai_hatsu', name: 'å½¹ç‰Œ(å‘)', han: 1, category: '1han' },
        { id: 'yakuhai_chun', name: 'å½¹ç‰Œ(ä¸­)', han: 1, category: '1han' },
        { id: 'yakuhai_ton', name: 'å½¹ç‰Œ(ä¸œ)', han: 1, category: '1han' },
        { id: 'yakuhai_nan', name: 'å½¹ç‰Œ(å—)', han: 1, category: '1han' },
        { id: 'yakuhai_shaa', name: 'å½¹ç‰Œ(è¥¿)', han: 1, category: '1han' },
        { id: 'yakuhai_pei', name: 'å½¹ç‰Œ(åŒ—)', han: 1, category: '1han' },
        { id: 'pinfu', name: 'å¹³å’Œ', han: 1, category: '1han' },
        { id: 'iipeikou', name: 'ä¸€æ¯å£', han: 1, category: '1han' },
        { id: 'tanyao', name: 'æ–­å¹ºä¹', han: 1, category: '1han' },
        { id: 'haitei', name: 'æµ·åº•ææœˆ', han: 1, category: '1han' },
        { id: 'houtei', name: 'æ²³åº•æ‘¸é±¼', han: 1, category: '1han' },
        { id: 'rinshan', name: 'å²­ä¸Šå¼€èŠ±', han: 1, category: '1han' },
        { id: 'chankan', name: 'æŠ¢æ ', han: 1, category: '1han' }
      ];

      // ====================================================================
      // 3. æ ¸å¿ƒéº»å°†é€»è¾‘ (Core Mahjong Logic) - å·²é‡æ„
      // ====================================================================

      const getTileCounts = (tiles) => {
        const counts = {};
        for (const tile of tiles) {
          counts[tile] = (counts[tile] || 0) + 1;
        }
        return counts;
      };

      // (ä¿®å¤ 2) ä¿®æ­£å›½å£«æ— åŒé€»è¾‘
      const checkKokushi = (tiles, winTile) => {
          if (tiles.length !== 14) return null;
          
          // å›½å£«æ— åŒå¿…é¡»åŒ…å«æ‰€æœ‰13ç§å¹ºä¹ç‰Œï¼Œæ¯ç§è‡³å°‘1å¼ 
          const counts = getTileCounts(tiles);
          
          // æ£€æŸ¥æ˜¯å¦åªåŒ…å«å¹ºä¹ç‰Œ
          if (!tiles.every(t => yaochuuhai.includes(t))) return null;
          
          // æ£€æŸ¥æ˜¯å¦åŒ…å«æ‰€æœ‰13ç§å¹ºä¹ç‰Œ
          if (Object.keys(counts).length !== 13) return null;
          
          // æ£€æŸ¥æ¯ç§ç‰Œåªèƒ½æ˜¯1å¼ æˆ–2å¼ 
          if (!Object.values(counts).every(c => c === 1 || c === 2)) return null;
          
          // å¿…é¡»åªæœ‰1ä¸ªå¯¹å­
          if (Object.values(counts).filter(c => c === 2).length !== 1) return null;
          
          // æ­¤æ—¶ï¼Œæ‰‹ç‰Œæ˜¯æœ‰æ•ˆçš„å›½å£«æ— åŒ
          // æ£€æŸ¥æ˜¯å¦ä¸º13é¢å¾…ï¼š13é¢å¾…æ„å‘³ç€å’Œäº†ç‰Œ(winTile)æ˜¯ç»„æˆå¯¹å­çš„é‚£å¼ ç‰Œ
          // å¹¶ä¸”13å¼ æ‰‹ç‰Œä¸­æ²¡æœ‰å¯¹å­
          
          // æ£€æŸ¥13å¼ æ‰‹ç‰Œï¼ˆä¸å«winTileï¼‰æ˜¯å¦æœ‰å¯¹å­
          const hand13 = [...tiles];
          const winTileIndex = hand13.indexOf(winTile);
          if (winTileIndex > -1) hand13.splice(winTileIndex, 1);
          
          const counts13 = getTileCounts(hand13);
          const hasPairInHand13 = Object.values(counts13).some(c => c === 2);

          if (!hasPairInHand13 && counts[winTile] === 2) {
              return { yaku: ['å›½å£«æ— åŒåä¸‰é¢'], han: 26, fu: 0 };
          }
          return { yaku: ['å›½å£«æ— åŒ'], han: 13, fu: 0 };
      };

      const checkChiitoitsu = (tiles) => {
        if (tiles.length !== 14) return null;
        const counts = getTileCounts(tiles);
        if (Object.values(counts).every(c => c === 2) && Object.keys(counts).length === 7) {
          const handTiles = tiles;
          let han = 2;
          const yaku = ['ä¸ƒå¯¹å­'];
          // (ä¸ƒå¯¹å­å¤åˆå½¹... ä¿æŒç®€åŒ–)
          if (handTiles.every(t => yaochuuhai.includes(t))) { yaku.push('æ··è€å¤´'); han += 2; }
          if (handTiles.every(t => honors.includes(t))) { yaku.push('å­—ä¸€è‰²'); han += 13; }
          return { yaku, han, fu: 25 };
        }
        return null;
      };

      const findMelds = (tileCounts) => {
        const tilesStr = JSON.stringify(tileCounts);
        if (tilesStr === '{}') return [[]];

        const results = [];
        const firstTile = Object.keys(tileCounts).sort()[0];
        if (!firstTile) return [[]];
        
        const count = tileCounts[firstTile];
        const [num, suit] = [parseInt(firstTile[0]), firstTile[1]];

        // å°è¯•åˆ»å­
        if (count >= 3) {
          const nextCounts = { ...tileCounts };
          nextCounts[firstTile] -= 3;
          if (nextCounts[firstTile] === 0) delete nextCounts[firstTile];
          
          const subMelds = findMelds(nextCounts);
          for (const melds of subMelds) {
            results.push([{ type: 'pon', tiles: [firstTile, firstTile, firstTile] }, ...melds]);
          }
        }

        // å°è¯•é¡ºå­
        if (suit !== 'z' && num <= 7) {
          const t2 = `${num + 1}${suit}`;
          const t3 = `${num + 2}${suit}`;
          if (tileCounts[t2] > 0 && tileCounts[t3] > 0) {
            const nextCounts = { ...tileCounts };
            nextCounts[firstTile] -= 1;
            nextCounts[t2] -= 1;
            nextCounts[t3] -= 1;
            if (nextCounts[firstTile] === 0) delete nextCounts[firstTile];
            if (nextCounts[t2] === 0) delete nextCounts[t2];
            if (nextCounts[t3] === 0) delete nextCounts[t3];
            
            const subMelds = findMelds(nextCounts);
            for (const melds of subMelds) {
              results.push([{ type: 'shuntsu', tiles: [firstTile, t2, t3] }, ...melds]);
            }
          }
        }
        
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„é¢å­ç»„åˆï¼Œè¿”å›ç©ºæ•°ç»„ï¼ˆè¡¨ç¤ºæ— æ³•åˆ†è§£ï¼‰
        return results;
      };

      const findStandardCombinations = (tiles) => {
        const counts = getTileCounts(tiles);
        const pairs = Object.keys(counts).filter(t => counts[t] >= 2);
        let combinations = [];

        for (const pairTile of pairs) {
          const countsWithoutPair = { ...counts };
          countsWithoutPair[pairTile] -= 2;
          if (countsWithoutPair[pairTile] === 0) delete countsWithoutPair[pairTile];

          const meldCombinations = findMelds(countsWithoutPair);
          for (const melds of meldCombinations) {
            if (melds.length === 4) {
              combinations.push({ pair: pairTile, melds: melds });
            }
          }
        }
        return combinations;
      };
      
      const getYakuhaiTiles = (playerWind, roundWind) => {
          const tiles = ['5z', '6z', '7z']; // ç™½å‘ä¸­
          if (roundWind === 'east') tiles.push('1z');
          if (roundWind === 'south') tiles.push('2z');
          if (playerWind === 'east') tiles.push('1z');
          if (playerWind === 'south') tiles.push('2z');
          if (playerWind === 'west') tiles.push('3z');
          if (playerWind === 'north') tiles.push('4z');
          return [...new Set(tiles)]; // å»é‡
      }

      // (ä¿®å¤ 2) ä¿®æ­£å››æš—åˆ»é€»è¾‘
      const calculateYaku = (combo, winTile, context) => {
        const { isTsumo, isMenzen, isRiichi, isIppatsu, isDoubleRiichi, isTenhou, isChiihou, isRenhou,
                isHaitei, isHoutei, isRinshan, isChankan, playerWind, roundWind } = context;
        const yaku = [];
        let han = 0;

        const allTiles = [...combo.melds.flatMap(m => m.tiles), combo.pair, combo.pair];
        const allMelds = combo.melds;
        const allShuntsu = allMelds.filter(m => m.type === 'shuntsu');
        const allPons = allMelds.filter(m => m.type === 'pon');
        const pair = combo.pair;

        // -- å½¹æ»¡ --
        // å¤©å’Œ/åœ°å’Œ/äººå’Œ (å½¹æ»¡)
        if (isTenhou) { yaku.push('å¤©å’Œ'); han += 13; }
        if (isChiihou) { yaku.push('åœ°å’Œ'); han += 13; }
        if (isRenhou) { yaku.push('äººå’Œ'); han += 13; } // æ³¨: æŸäº›è§„åˆ™ä¸‹äººå’Œä¸ºæ»¡è´¯è€Œéå½¹æ»¡
        
        // å¤§å››å–œ/å°å››å–œ (å½¹æ»¡)
        const windPons = allPons.filter(m => ['1z', '2z', '3z', '4z'].includes(m.tiles[0]));
        if (windPons.length === 4) {
            yaku.push('å¤§å››å–œ'); han += 26; // åŒå€å½¹æ»¡
        } else if (windPons.length === 3 && ['1z', '2z', '3z', '4z'].includes(pair)) {
            yaku.push('å°å››å–œ'); han += 13;
        }
        
        // å¤§ä¸‰å…ƒ (å½¹æ»¡)
        const sangenPons = allPons.filter(m => ['5z', '6z', '7z'].includes(m.tiles[0]));
        if (sangenPons.length === 3) {
            yaku.push('å¤§ä¸‰å…ƒ'); han += 13;
        }
        
        // å­—ä¸€è‰² (å½¹æ»¡)
        if (allTiles.every(t => honors.includes(t))) { yaku.push('å­—ä¸€è‰²'); han += 13; }
        // æ¸…è€å¤´ (å½¹æ»¡)
        else if (allTiles.every(t => terminals.includes(t))) { yaku.push('æ¸…è€å¤´'); han += 13; }
        
        // ç»¿ä¸€è‰² (å½¹æ»¡) - åªç”¨2ã€3ã€4ã€6ã€8ç´¢å’Œå‘
        const greenTiles = ['2s', '3s', '4s', '6s', '8s', '6z'];
        if (allTiles.every(t => greenTiles.includes(t))) {
            yaku.push('ç»¿ä¸€è‰²'); han += 13;
        }
        
        // ä¹è²å®ç¯ (å½¹æ»¡)
        if (isMenzen) {
            const suitCounts = { m: 0, p: 0, s: 0 };
            allTiles.forEach(t => {
                if (['m', 'p', 's'].includes(t[1])) suitCounts[t[1]]++;
            });
            
            for (const suit of ['m', 'p', 's']) {
                if (suitCounts[suit] === 14) {
                    const hand13 = [...allTiles];
                    const winTileIndex = hand13.indexOf(winTile);
                    if (winTileIndex > -1) hand13.splice(winTileIndex, 1);
                    
                    const counts = getTileCounts(allTiles);
                    const pattern = [`1${suit}`, `2${suit}`, `3${suit}`, `4${suit}`, `5${suit}`, `6${suit}`, `7${suit}`, `8${suit}`, `9${suit}`];
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸º1112345678999å½¢çŠ¶
                    if (counts[`1${suit}`] >= 3 && counts[`9${suit}`] >= 3 &&
                        pattern.slice(1, 8).every(t => counts[t] >= 1)) {
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºçº¯æ­£ä¹è²å®ç¯ (1112345678999å¬9é¢)
                        const counts13 = getTileCounts(hand13);
                        if (counts13[`1${suit}`] === 3 && counts13[`9${suit}`] === 3 &&
                            pattern.slice(1, 8).every(t => counts13[t] === 1)) {
                            yaku.push('çº¯æ­£ä¹è²å®ç¯'); han += 26; // åŒå€å½¹æ»¡
                        } else {
                            yaku.push('ä¹è²å®ç¯'); han += 13;
                        }
                    }
                }
            }
        }
        
        // å››æš—åˆ» (å½¹æ»¡)
        if (isMenzen && allPons.length === 4) {
            if (winTile === pair) {
                yaku.push('å››æš—åˆ»å•éª‘'); han += 26;
            } else if (isTsumo) {
                yaku.push('å››æš—åˆ»'); han += 13;
            }
            // è£å’Œ(éå•éª‘) => æ‰åˆ°ä¸‰æš—åˆ»+å¯¹å¯¹å’Œ
        }
        
        // å››æ å­ (å½¹æ»¡)
        const kanCount = melds.filter(m => m.type === 'minkan' || m.type === 'ankan').length;
        if (kanCount === 4) {
            yaku.push('å››æ å­'); han += 13;
        }
        
        if (han >= 13) return { yaku, han }; 

        // -- 6+ ç•ª --
        const suits = new Set(allTiles.map(t => t[1]).filter(s => ['m', 'p', 's'].includes(s)));
        const hasHonor = allTiles.some(t => honors.includes(t));
        if (suits.size === 1 && !hasHonor) { yaku.push('æ¸…ä¸€è‰²'); han += isMenzen ? 6 : 5; }
        
        // -- 3+ ç•ª --
        if (suits.size === 1 && hasHonor) { yaku.push('æ··ä¸€è‰²'); han += isMenzen ? 3 : 2; }
        const isJunchan = allMelds.every(m => m.tiles.some(t => terminals.includes(t))) && terminals.includes(pair);
        if (isJunchan) { yaku.push('çº¯å…¨å¸¦å¹ºä¹'); han += isMenzen ? 3 : 2; }

        // (ä¿®å¤ 2) ä¸‰æš—åˆ»
        let concealedPons = 0;
        if (isMenzen) {
            allPons.forEach(pon => {
                // è‡ªæ‘¸æ—¶ï¼Œæ‰€æœ‰åˆ»å­éƒ½æ˜¯æš—åˆ»
                // è£å’Œæ—¶ï¼Œåªæœ‰å’Œäº†ç‰Œ*ä¸æ˜¯*çš„åˆ»å­æ‰æ˜¯æš—åˆ»
                if (isTsumo || pon.tiles[0] !== winTile) {
                    concealedPons++;
                }
            });
        }
        if (concealedPons === 3) {
            yaku.push('ä¸‰æš—åˆ»'); han += 2;
        }

        // -- 2 ç•ª --
        if (allPons.length === 4) { yaku.push('å¯¹å¯¹å’Œ'); han += 2; }
        if (allTiles.every(t => yaochuuhai.includes(t))) { yaku.push('æ··è€å¤´'); han += 2; }
        
        // å°ä¸‰å…ƒ (2ç•ª) - ç™½å‘ä¸­ï¼Œä¸¤ç§æˆåˆ»å­ï¼Œä¸€ç§åšé›€å¤´
        if (sangenPons.length === 2 && ['5z', '6z', '7z'].includes(pair)) {
            yaku.push('å°ä¸‰å…ƒ'); han += 2;
        }
        
        // ä¸‰è‰²åŒåˆ» (2ç•ª) - ä¸‡ç­’ç´¢åŒä¸€æ•°å­—çš„åˆ»å­å„ä¸€ä¸ª
        const ponNumbers = {};
        allPons.forEach(m => {
            const num = m.tiles[0][0];
            const suit = m.tiles[0][1];
            if (['m', 'p', 's'].includes(suit)) {
                ponNumbers[num] = (ponNumbers[num] || new Set()).add(suit);
            }
        });
        if (Object.values(ponNumbers).some(s => s.size === 3)) {
            yaku.push('ä¸‰è‰²åŒåˆ»'); han += 2;
        }
        
        // ä¸‰æ å­ (2ç•ª) - éœ€è¦æ‰©å±•é¢å­ç±»å‹æ”¯æŒæ å­
        // æ³¨: å½“å‰ç®€åŒ–ç‰ˆæœªå®ç°æ˜æ /æš—æ åŒºåˆ†ï¼Œæ­¤å¤„é¢„ç•™
        
        // åŒç«‹ç›´/äºŒç«‹ç›´ (2ç•ª)
        if (isDoubleRiichi) { yaku.push('åŒç«‹ç›´'); han += 2; }

        const shuntsuStarts = {};
        allShuntsu.forEach(m => {
          const num = m.tiles[0][0];
          const suit = m.tiles[0][1];
          shuntsuStarts[num] = (shuntsuStarts[num] || new Set()).add(suit);
        });
        if (Object.values(shuntsuStarts).some(s => s.size === 3)) { yaku.push('ä¸‰è‰²åŒé¡º'); han += isMenzen ? 2 : 1; }
        
        const itsuuSuits = {};
        allShuntsu.forEach(m => {
          const num = m.tiles[0][0];
          const suit = m.tiles[0][1];
          itsuuSuits[suit] = (itsuuSuits[suit] || new Set()).add(num);
        });
        if (Object.values(itsuuSuits).some(s => s.has('1') && s.has('4') && s.has('7'))) { yaku.push('ä¸€æ°”é€šè´¯'); han += isMenzen ? 2 : 1; }

        const isChanta = !isJunchan && allMelds.every(m => m.tiles.some(t => yaochuuhai.includes(t))) && yaochuuhai.includes(pair);
        if (isChanta) { yaku.push('æ··å…¨å¸¦å¹ºä¹'); han += isMenzen ? 2 : 1; }


        // -- 1 ç•ª --
        // åŒç«‹ç›´å’Œç«‹ç›´äº’æ–¥ï¼Œåªæœ‰åœ¨æ²¡æœ‰åŒç«‹ç›´æ—¶æ‰åˆ¤æ–­ç«‹ç›´
        if (isMenzen && isRiichi && !isDoubleRiichi) {
          yaku.push('ç«‹ç›´'); han += 1;
        }
        // ä¸€å‘éœ€è¦ç«‹ç›´æˆ–åŒç«‹ç›´
        if (isIppatsu && (isRiichi || isDoubleRiichi)) { 
          yaku.push('ä¸€å‘'); han += 1; 
        }
        
        // çŠ¶å†µå½¹ (1ç•ª)
        if (isHaitei && isTsumo) { yaku.push('æµ·åº•ææœˆ'); han += 1; }
        if (isHoutei && !isTsumo) { yaku.push('æ²³åº•æ‘¸é±¼'); han += 1; }
        if (isRinshan && isTsumo) { yaku.push('å²­ä¸Šå¼€èŠ±'); han += 1; }
        if (isChankan && !isTsumo) { yaku.push('æŠ¢æ '); han += 1; }
        
        if (isMenzen && isTsumo) {
          yaku.push('é—¨å‰æ¸…è‡ªæ‘¸å’Œ'); han += 1; 
        }
        
        const yakuhaiTiles = getYakuhaiTiles(playerWind, roundWind);
        allPons.forEach(m => {
          const tile = m.tiles[0];
          // (ä¿®æ­£) å½¹ç‰Œåªç®—åˆ»å­ï¼Œä¸ç®—é›€å¤´
          if (yakuhaiTiles.includes(tile)) {
            yaku.push(`å½¹ç‰Œ(${internalToDisplay[tile]})`);
            han += 1;
          }
        });
        
        const isPinfuShape = allShuntsu.length === 4;
        const isYakuhaiPair = yakuhaiTiles.includes(pair);
        const isRyanmenWait = allShuntsu.some(m => {
            const [t1, t2, t3] = m.tiles;
            if (winTile === t2) return false;
            if (t1[0] === '1' && winTile === t3) return false;
            if (t1[0] === '7' && winTile === t1) return false;
            return m.tiles.includes(winTile);
        });
        
        if (isMenzen && isPinfuShape && !isYakuhaiPair && isRyanmenWait) {
          yaku.push('å¹³å’Œ'); han += 1;
        }
        
        const shuntsuGroups = {};
        allShuntsu.forEach(m => {
            const key = m.tiles.join('');
            shuntsuGroups[key] = (shuntsuGroups[key] || 0) + 1;
        });
        const pairsOfShuntsu = Object.values(shuntsuGroups).filter(c => c >= 2).length;
        const quadsOfShuntsu = Object.values(shuntsuGroups).filter(c => c === 4).length;

        if (isMenzen) {
            if (quadsOfShuntsu === 1 || pairsOfShuntsu === 2) {
                // ç§»é™¤ä¸€æ¯å£ï¼Œå¦‚æœå®ƒæ˜¯ä¸¤æ¯å£çš„ä¸€éƒ¨åˆ†
                if (yaku.includes('ä¸€æ¯å£')) {
                    yaku.splice(yaku.indexOf('ä¸€æ¯å£'), 1);
                    han -= 1;
                }
                yaku.push('ä¸¤æ¯å£'); han += 3;
            } else if (pairsOfShuntsu === 1) {
                yaku.push('ä¸€æ¯å£'); han += 1;
            }
        }
        
        if (!allTiles.some(t => yaochuuhai.includes(t))) { yaku.push('æ–­å¹ºä¹'); han += 1; }

        return { yaku, han };
      };

      const calculateFu = (combo, winTile, context) => {
        const { isTsumo, isMenzen, playerWind, roundWind, isPinfu, melds: externalMelds } = context;
        
        if (isPinfu) {
          return isTsumo ? 20 : 30;
        }
        
        let fu = 20; // åº•ç¬¦
        
        if (isMenzen && !isTsumo) fu += 10; // é—¨æ¸…è£å’Œ
        if (isTsumo) fu += 2; // è‡ªæ‘¸
        
        const yakuhaiTiles = getYakuhaiTiles(playerWind, roundWind);
        const pair = combo.pair;
        // å½¹ç‰Œé›€å¤´ï¼ˆåŒ…æ‹¬è‡ªé£ã€åœºé£ã€ä¸‰å…ƒç‰Œï¼‰
        if (yakuhaiTiles.includes(pair)) {
          fu += 2;
        }
        // éå½¹ç‰Œçš„ä¸‰å…ƒç‰Œï¼ˆç™½å‘ä¸­ï¼‰ä¹ŸåŠ 2ç¬¦
        else if (['5z','6z','7z'].includes(pair)) {
          fu += 2;
        }
        
        // è®¡ç®—æ‰‹ç‰Œä¸­çš„åˆ»å­ç¬¦æ•°
        combo.melds.forEach(m => {
          if (m.type === 'pon') {
            const tile = m.tiles[0];
            let ponFu = yaochuuhai.includes(tile) ? 4 : 2;
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºæš—åˆ»
            if (isMenzen) {
              // é—¨æ¸…æ—¶ï¼šè‡ªæ‘¸æˆ–éå’Œç‰Œå¼ çš„åˆ»å­éƒ½ç®—æš—åˆ»
              if (isTsumo || tile !== winTile) {
                ponFu *= 2; // æš—åˆ»åŠ å€
              }
            } else {
              // æœ‰å‰¯éœ²æ—¶ï¼šåªæœ‰è‡ªæ‘¸ä¸”æ˜¯å’Œç‰Œå¼ å½¢æˆçš„åˆ»å­æ‰ç®—æš—åˆ»
              if (isTsumo && tile === winTile) {
                ponFu *= 2; // æš—åˆ»åŠ å€
              }
            }
            
            fu += ponFu;
          }
        });

        // è®¡ç®—å‰¯éœ²åŒºçš„ç¬¦æ•°
        if (externalMelds && externalMelds.length > 0) {
          externalMelds.forEach(m => {
            if (m.type === 'pon') {
              // æ˜åˆ»
              const tile = displayToInternal[m.tiles[0]];
              const ponFu = yaochuuhai.includes(tile) ? 4 : 2;
              fu += ponFu;
            } else if (m.type === 'minkan') {
              // æ˜æ 
              const tile = displayToInternal[m.tiles[0]];
              const kanFu = yaochuuhai.includes(tile) ? 16 : 8;
              fu += kanFu;
            } else if (m.type === 'ankan') {
              // æš—æ 
              const tile = displayToInternal[m.tiles[0]];
              const kanFu = yaochuuhai.includes(tile) ? 32 : 16;
              fu += kanFu;
            }
            // é¡ºå­(shuntsu)ä¸åŠ ç¬¦
          });
        }

        // å¾…ç‰Œå½¢ç¬¦æ•°åˆ¤å®š
        const isTanki = winTile === pair;
        
        // è¾¹å¼ åˆ¤å®šï¼š12å¾…3 æˆ– 78å¾…9
        const isPenchan = combo.melds.some(m => {
          if (m.type !== 'shuntsu') return false;
          const sortedTiles = m.tiles.slice().sort();
          // 123å½¢ï¼Œå’Œ3
          if (sortedTiles[0][0] === '1' && sortedTiles[2] === winTile) return true;
          // 789å½¢ï¼Œå’Œ7
          if (sortedTiles[2][0] === '9' && sortedTiles[0] === winTile) return true;
          return false;
        });
        
        // åµŒå¼ åˆ¤å®šï¼šé¡ºå­ä¸­é—´ç‰Œ
        const isKanchan = combo.melds.some(m => {
          if (m.type !== 'shuntsu') return false;
          const sortedTiles = m.tiles.slice().sort();
          return sortedTiles[1] === winTile;
        });

        // å•éª‘ã€è¾¹å¼ ã€åµŒå¼ éƒ½åŠ 2ç¬¦
        if (isTanki || isPenchan || isKanchan) {
          fu += 2;
        }
        
        return Math.ceil(fu / 10) * 10;
      };
      
      // æ£€æµ‹æ‰‹åŠ¨é€‰æ‹©çš„å½¹ç§æ˜¯å¦æœ‰å†²çª
      const checkYakuConflicts = (selectedYakuIds) => {
        const conflicts = [];
        const selected = selectedYakuIds.map(id => allYakuList.find(y => y.id === id)).filter(Boolean);
        
        // å®šä¹‰äº’æ–¥ç»„
        const exclusiveGroups = [
          ['tenhou', 'chiihou', 'renhou'], // å¤©åœ°äººå’Œ
          ['riichi', 'double_riichi'], // ç«‹ç›´å’ŒåŒç«‹ç›´
          ['haitei', 'houtei'], // æµ·åº•æ²³åº•
          ['rinshan', 'chankan'], // å²­ä¸ŠæŠ¢æ 
          ['iipeikou', 'ryanpeikou'], // ä¸€æ¯å£å’Œä¸¤æ¯å£
          ['chanta', 'junchan'], // æ··å…¨å’Œçº¯å…¨
          ['honitsu', 'chinitsu'], // æ··ä¸€è‰²å’Œæ¸…ä¸€è‰²
          ['kokushi', 'kokushi13'], // å›½å£«å’Œå›½å£«13é¢
          ['suuankou', 'suuankou_tanki'], // å››æš—åˆ»å’Œå››æš—åˆ»å•éª‘
          ['chuuren', 'chuuren9'] // ä¹è²å’Œçº¯æ­£ä¹è²
        ];
        
        // æ£€æŸ¥äº’æ–¥ç»„
        for (const group of exclusiveGroups) {
          const inGroup = selectedYakuIds.filter(id => group.includes(id));
          if (inGroup.length > 1) {
            const names = inGroup.map(id => allYakuList.find(y => y.id === id)?.name).join('ã€');
            conflicts.push(`${names} ä¸èƒ½åŒæ—¶å­˜åœ¨`);
          }
        }
        
        // æ£€æŸ¥é€»è¾‘å†²çª
        const hasYaku = (id) => selectedYakuIds.includes(id);
        
        // å›½å£«æ— åŒä¸å…¶ä»–å½¹ï¼ˆé™¤å­—ä¸€è‰²ï¼‰å†²çª
        if ((hasYaku('kokushi') || hasYaku('kokushi13')) && 
            selectedYakuIds.some(id => !['kokushi', 'kokushi13', 'tsuuiisou'].includes(id))) {
          conflicts.push('å›½å£«æ— åŒä¸èƒ½ä¸å…¶ä»–å½¹ç§å¤åˆ');
        }
        
        // ä¸ƒå¯¹å­ä¸æŸäº›å½¹å†²çª
        if (hasYaku('chiitoitsu')) {
          if (hasYaku('toitoi')) conflicts.push('ä¸ƒå¯¹å­ä¸å¯¹å¯¹å’Œå†²çª');
          if (hasYaku('iipeikou') || hasYaku('ryanpeikou')) conflicts.push('ä¸ƒå¯¹å­ä¸ä¸€æ¯å£/ä¸¤æ¯å£å†²çª');
          if (hasYaku('sanshoku_doujun') || hasYaku('ittsu')) conflicts.push('ä¸ƒå¯¹å­ä¸ä¸‰è‰²åŒé¡º/ä¸€æ°”é€šè´¯å†²çª');
        }
        
        // å¹³å’Œä¸å¯¹å¯¹å’Œ/ä¸ƒå¯¹å­å†²çª
        if (hasYaku('pinfu') && (hasYaku('toitoi') || hasYaku('chiitoitsu'))) {
          conflicts.push('å¹³å’Œä¸å¯¹å¯¹å’Œ/ä¸ƒå¯¹å­å†²çª');
        }
        
        // æ–­å¹ºä¹ä¸å«å¹ºä¹ç‰Œçš„å½¹å†²çª
        if (hasYaku('tanyao') && (hasYaku('honroutou') || hasYaku('chinroutou') || 
            hasYaku('chanta') || hasYaku('junchan'))) {
          conflicts.push('æ–­å¹ºä¹ä¸å«å¹ºä¹ç‰Œçš„å½¹ç§å†²çª');
        }
        
        // ä¸€å‘éœ€è¦ç«‹ç›´
        if (hasYaku('ippatsu') && !hasYaku('riichi') && !hasYaku('double_riichi')) {
          conflicts.push('ä¸€å‘éœ€è¦ç«‹ç›´æˆ–åŒç«‹ç›´');
        }
        
        return conflicts;
      };
      
      // è®¡ç®—æ‰‹åŠ¨é€‰æ‹©å½¹ç§çš„æ€»ç•ªæ•°
      const calculateManualHan = () => {
        let totalHan = 0;
        const conflicts = checkYakuConflicts(manualYaku);
        
        if (conflicts.length > 0) {
          return { han: 0, conflicts };
        }
        
        for (const yakuId of manualYaku) {
          const yaku = allYakuList.find(y => y.id === yakuId);
          if (yaku) {
            // æ‰‹åŠ¨æ¨¡å¼ä¸‹ä½¿ç”¨ isManualFuro åˆ¤æ–­æ˜¯å¦å‰¯éœ²ï¼Œä»è€Œå†³å®šç•ªæ•°
            if (yaku.hanNaki !== undefined && isManualFuro) {
              totalHan += yaku.hanNaki;
            } else {
              totalHan += yaku.han;
            }
          }
        }
        
        // åŠ ä¸Šå®ç‰Œ
        // æ‰‹åŠ¨æ¨¡å¼ä¸‹ï¼šå¦‚æœé€‰æ‹©äº†ç«‹ç›´æˆ–åŒç«‹ç›´å½¹ç§ï¼Œæˆ–è€…æœ‰ä»»ä½•é‡Œå®ï¼Œåˆ™åŠ ä¸Šé‡Œå®
        const hasRiichiYaku = manualYaku.includes('riichi') || manualYaku.includes('double_riichi');
        totalHan += dora + (hasRiichiYaku ? uraDora : 0) + redDora;
        
        return { han: totalHan, conflicts: [] };
      };

      const analyzeHandInternal = (tiles, winTile, context) => {
        if (tiles.length !== 14) return null;
        
        // (ä¿®å¤ 2) ä¼ å…¥ winTile
        const kokushi = checkKokushi(tiles, winTile);
        if (kokushi) return kokushi;
        
        let bestHand = null;

        const chiitoi = checkChiitoitsu(tiles);
        if (chiitoi) {
            bestHand = chiitoi;
        }
        
        const combinations = findStandardCombinations(tiles);
        if (combinations.length > 0) {
            for (const combo of combinations) {
                const { yaku, han } = calculateYaku(combo, winTile, context);
                
                if (han === 0) continue;
                
                const isPinfu = yaku.includes('å¹³å’Œ');
                const fu = calculateFu(combo, winTile, { ...context, isPinfu, melds });
                const currentHand = { yaku, han, fu };
                
                if (!bestHand || currentHand.han > bestHand.han || (currentHand.han === bestHand.han && currentHand.fu > bestHand.fu)) {
                    bestHand = currentHand;
                }
            }
        }

        return bestHand;
      };

      // æ–°å¢ï¼šä¸“é—¨å¤„ç†æœ‰å‰¯éœ²æƒ…å†µçš„åˆ†æå‡½æ•°
      const analyzeHandWithMelds = (handTiles, winTile, externalMelds, context) => {
        // å¦‚æœæ²¡æœ‰å‰¯éœ²ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘
        if (!externalMelds || externalMelds.length === 0) {
          const hand14 = [...handTiles, winTile];
          return analyzeHandInternal(hand14, winTile, context);
        }
        
        // æœ‰å‰¯éœ²çš„æƒ…å†µ
        const hand14 = [...handTiles, winTile];
        
        // è®¡ç®—éœ€è¦çš„é¢å­æ•°ï¼š4 - å‰¯éœ²ç»„æ•°
        const requiredMeldCount = 4 - externalMelds.length;
        
        // æ£€æŸ¥æ‰‹ç‰Œèƒ½å¦ç»„æˆæ‰€éœ€çš„é¢å­æ•° + 1ä¸ªé›€å¤´
        const handCombinations = findPartialCombinations(hand14, requiredMeldCount);
        
        if (handCombinations.length === 0) {
          return null; // æ— æ³•èƒ¡ç‰Œ
        }
        
        let bestHand = null;
        
        for (const handCombo of handCombinations) {
          // å°†æ‰‹ç‰Œé¢å­å’Œå‰¯éœ²é¢å­åˆå¹¶
          const externalMeldsConverted = externalMelds.map(m => {
            // ä¿æŒå‰¯éœ²é¢å­çš„ç±»å‹ï¼šé¡ºå­ã€åˆ»å­ï¼ˆå«æ˜æ ï¼‰ã€æš—æ 
            let meldType = m.type;
            if (m.type === 'minkan') meldType = 'pon'; // æ˜æ è§†ä¸ºåˆ»å­
            if (m.type === 'ankan') meldType = 'pon'; // æš—æ ä¹Ÿè§†ä¸ºåˆ»å­ï¼ˆä½†ç¬¦æ•°è®¡ç®—ä¼šåŒºåˆ†ï¼‰
            
            // è½¬æ¢å‰¯éœ²ç‰Œä¸ºå†…éƒ¨æ ¼å¼
            const internalTiles = m.tiles.map(t => {
              const internal = displayToInternal[t];
              if (!internal) {
                console.error('å‰¯éœ²ç‰Œè½¬æ¢å¤±è´¥:', t);
                return t;
              }
              return internal;
            });
            
            return {
              type: meldType,
              tiles: internalTiles,
              isKan: m.type === 'minkan' || m.type === 'ankan',
              isAnkan: m.type === 'ankan'
            };
          });
          
          const fullCombo = {
            pair: handCombo.pair,
            melds: [...handCombo.melds, ...externalMeldsConverted]
          };
          
          const { yaku, han } = calculateYaku(fullCombo, winTile, context);
          
          if (han === 0) continue;
          
          const isPinfu = yaku.includes('å¹³å’Œ');
          const fu = calculateFu(handCombo, winTile, { ...context, isPinfu, melds: externalMelds });
          const currentHand = { yaku, han, fu };
          
          if (!bestHand || currentHand.han > bestHand.han || (currentHand.han === bestHand.han && currentHand.fu > bestHand.fu)) {
            bestHand = currentHand;
          }
        }
        
        return bestHand;
      };

      // æ–°å¢ï¼šæŸ¥æ‰¾éƒ¨åˆ†ç»„åˆï¼ˆç”¨äºå‰¯éœ²æƒ…å†µï¼‰
      const findPartialCombinations = (tiles, requiredMeldCount) => {
        const counts = getTileCounts(tiles);
        const pairs = Object.keys(counts).filter(t => counts[t] >= 2);
        let combinations = [];

        for (const pairTile of pairs) {
          const countsWithoutPair = { ...counts };
          countsWithoutPair[pairTile] -= 2;
          if (countsWithoutPair[pairTile] === 0) delete countsWithoutPair[pairTile];

          const meldCombinations = findMelds(countsWithoutPair);
          for (const melds of meldCombinations) {
            if (melds.length === requiredMeldCount) {
              combinations.push({ pair: pairTile, melds: melds });
            }
          }
        }
        return combinations;
      };

      const findTenpaiWaits = (hand13) => {
        // ä¿®å¤ï¼šè€ƒè™‘å‰¯éœ²å’Œæ çš„æƒ…å†µï¼Œæ‰‹ç‰Œæ•°é‡åº”è¯¥æ˜¯ (13 + æ æ•°) - å‰¯éœ²ç‰Œæ•°
        const kanCount = melds.filter(m => m.type === 'minkan' || m.type === 'ankan').length;
        const requiredHandCount = (13 + kanCount) - melds.reduce((sum, m) => sum + m.tiles.length, 0);
        if (hand13.length !== requiredHandCount) return [];
        
        const waits = new Set();
        
        // è®¡ç®—éœ€è¦çš„é¢å­æ•°ï¼ˆè€ƒè™‘å‰¯éœ²ï¼‰
        const requiredMeldCount = 4 - melds.length;
        
        for (const tile of allInternalTilesForWait) {
          const hand14 = [...hand13, tile];
          
          // æœ‰å‰¯éœ²æ—¶ï¼Œä½¿ç”¨éƒ¨åˆ†ç»„åˆæŸ¥æ‰¾
          if (melds.length > 0) {
            const combinations = findPartialCombinations(hand14, requiredMeldCount);
            if (combinations.length > 0) {
              waits.add(internalToDisplay[tile]);
            }
          } else {
            // æ— å‰¯éœ²æ—¶ï¼Œä½¿ç”¨æ ‡å‡†ç»„åˆ
            const combinations = findStandardCombinations(hand14);
            if (combinations.length > 0) {
              waits.add(internalToDisplay[tile]);
            }
          }
        }
        
        // ä¸ƒå¯¹å­æ£€æŸ¥ï¼ˆæœ‰å‰¯éœ²æ—¶ä¸èƒ½æ˜¯ä¸ƒå¯¹å­ï¼‰
        if (melds.length === 0) {
          const counts13 = getTileCounts(hand13);
          if (Object.values(counts13).filter(c => c === 2).length === 6) {
              const single = Object.keys(counts13).find(t => counts13[t] === 1);
              if (single) waits.add(internalToDisplay[single]);
          }
        }
        
        // å›½å£«æ— åŒæ£€æŸ¥ï¼ˆæœ‰å‰¯éœ²æ—¶ä¸èƒ½æ˜¯å›½å£«ï¼‰
        if (melds.length === 0) {
          const yaochuuCounts = {};
          let nonYaochuu = false;
          hand13.forEach(t => {
              if (yaochuuhai.includes(t)) {
                  yaochuuCounts[t] = (yaochuuCounts[t] || 0) + 1;
              } else {
                  nonYaochuu = true;
              }
          });
          if (!nonYaochuu) {
              if (Object.keys(yaochuuCounts).length === 13) {
                  yaochuuhai.forEach(t => waits.add(internalToDisplay[t]));
              } else if (Object.keys(yaochuuCounts).length === 12 && Object.values(yaochuuCounts).every(c => c === 1)) {
                  const missing = yaochuuhai.find(t => !yaochuuCounts[t]);
                  if(missing) waits.add(internalToDisplay[missing]);
              }
          }
        }

        return Array.from(waits);
      };
      
      const updateDetailedTenpaiWaits = () => {
          const requiredHandCount = getRequiredHandTileCount();
          if (selectedTiles.length !== requiredHandCount) {
              tenpaiWaits = [];
              return;
          }
          
          const internalHand = selectedTiles.map(t => displayToInternal[t]);
          const simpleWaits = findTenpaiWaits(internalHand);
          const detailedWaits = [];
          
          const hypotheticalWinnerIndex = winnerIndex !== null ? winnerIndex : currentDealerIndex;
          const isDealer = hypotheticalWinnerIndex === currentDealerIndex;
          
          // è®¡ç®—å®é™…çš„é—¨å‰çŠ¶æ€ï¼šåªæœ‰æ²¡æœ‰æ˜å‰¯éœ²ï¼ˆé¡ºå­/åˆ»å­/æ˜æ ï¼‰æ—¶æ‰æ˜¯é—¨å‰
          const actualIsMenzen = melds.length === 0 || melds.every(m => m.type === 'ankan');
          
          const context = {
            isTsumo: isTsumo, // ä½¿ç”¨å½“å‰çš„è£å’Œ/è‡ªæ‘¸çŠ¶æ€
            isMenzen: actualIsMenzen,  // ä½¿ç”¨å®é™…çš„é—¨å‰çŠ¶æ€
            isRiichi: actualIsMenzen ? isRiichi : false,  // æœ‰æ˜å‰¯éœ²æ—¶ä¸èƒ½ç«‹ç›´
            isIppatsu,
            isDoubleRiichi: actualIsMenzen ? isDoubleRiichi : false,
            isTenhou,
            isChiihou,
            isRenhou,
            isHaitei,
            isHoutei,
            isRinshan,
            isChankan,
            playerWind: getPlayerWind(hypotheticalWinnerIndex),
            roundWind: gameState.wind
          };

          for (const waitTileDisplay of simpleWaits) {
              // æ£€æŸ¥è¯¥ç‰Œæ˜¯å¦å·²è¾¾åˆ°4å¼ ä¸Šé™
              if (getTileUsageCount(waitTileDisplay) >= 4) continue;
              
              const internalWinTile = displayToInternal[waitTileDisplay];
              
              // ä½¿ç”¨æ–°çš„åˆ†æå‡½æ•°ï¼Œæ”¯æŒå‰¯éœ²
              const analysis = analyzeHandWithMelds(internalHand, internalWinTile, melds, context);
              
              if (analysis) {
                  // (ä¿®å¤ 5) å¬ç‰Œåˆ†æåªåŒ…æ‹¬ dora å’Œ redDora
                  const han = analysis.han + dora + redDora;
                  if (han === 0) continue;
                  
                  const scoreData = calculateScore(han, analysis.fu, isDealer, gameState.honba);
                  detailedWaits.push({ 
                      tile: waitTileDisplay, 
                      yaku: analysis.yaku.length > 0 ? analysis.yaku.join('/') : '(æ— å½¹)', 
                      han: han, 
                      fu: analysis.fu, 
                      score: scoreData.total 
                  });
              }
          }
          tenpaiWaits = detailedWaits;
      }
      
      const getCurrentAnalysis = () => {
        // è€æ‰‹æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨ç•ªæ•°å’Œç¬¦æ•°
        if (isExpertMode) {
          if (winnerIndex === null) {
            analysisError = 'è¯·é€‰æ‹©å’Œç‰Œè€…';
            return null;
          }
          
          // è€æ‰‹æ¨¡å¼ï¼šç›´æ¥åŠ ä¸Šæ‰€æœ‰å®ç‰Œï¼ˆåŒ…æ‹¬é‡Œå®ï¼‰ï¼Œä¸æ£€æŸ¥ç«‹ç›´çŠ¶æ€
          const totalHan = expertHan + dora + uraDora + redDora;
          
          if (totalHan === 0) {
            analysisError = 'ç•ªæ•°ä¸èƒ½ä¸º0';
            return null;
          }
          
          analysisError = null;
          return {
            yaku: [`${expertHan}ç•ªï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼‰`],
            han: totalHan,
            fu: expertFu
          };
        }
        
        // æ‰‹åŠ¨æ¨¡å¼ï¼šç›´æ¥ä»é€‰æ‹©çš„å½¹ç§è®¡ç®—
        if (isManualMode) {
          if (winnerIndex === null) {
            analysisError = 'è¯·é€‰æ‹©å’Œç‰Œè€…';
            return null;
          }
          
          if (manualYaku.length === 0) {
            analysisError = 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå½¹ç§';
            return null;
          }
          
          const { han, conflicts } = calculateManualHan();
          
          if (conflicts.length > 0) {
            analysisError = 'å½¹ç§å†²çª: ' + conflicts.join('; ');
            return null;
          }
          
          if (han === 0) {
            analysisError = 'æ— å½¹ã€‚è¯·é€‰æ‹©å½¹ç§æˆ–æ·»åŠ å®ç‰Œã€‚';
            return null;
          }
          
          const yakuNames = manualYaku.map(id => allYakuList.find(y => y.id === id)?.name).filter(Boolean);
          
          analysisError = null;
          return {
            yaku: yakuNames,
            han: han,
            fu: manualFu
          };
        }
        
        // è‡ªåŠ¨åˆ†ææ¨¡å¼ï¼šéœ€è¦æ‰‹ç‰Œå’Œå’Œç‰Œ
        const requiredHandCount = getRequiredHandTileCount();
        if (winnerIndex === null || selectedTiles.length !== requiredHandCount || !winTile) {
          analysisError = null;
          return null;
        }
        
        const internalHand = selectedTiles.map(t => displayToInternal[t]);
        const internalWinTile = displayToInternal[winTile];
        
        // è®¡ç®—å®é™…çš„é—¨å‰çŠ¶æ€ï¼šåªæœ‰æ²¡æœ‰æ˜å‰¯éœ²ï¼ˆé¡ºå­/åˆ»å­/æ˜æ ï¼‰æ—¶æ‰æ˜¯é—¨å‰
        const actualIsMenzen = melds.length === 0 || melds.every(m => m.type === 'ankan');
        
        const context = {
          isTsumo,
          isMenzen: actualIsMenzen,  // ä½¿ç”¨å®é™…çš„é—¨å‰çŠ¶æ€
          isRiichi: actualIsMenzen ? isRiichi : false,  // æœ‰æ˜å‰¯éœ²æ—¶ä¸èƒ½ç«‹ç›´
          isIppatsu,
          isDoubleRiichi: actualIsMenzen ? isDoubleRiichi : false,
          isTenhou,
          isChiihou,
          isRenhou,
          isHaitei,
          isHoutei,
          isRinshan,
          isChankan,
          playerWind: getPlayerWind(winnerIndex),
          roundWind: gameState.wind
        };

        // ä½¿ç”¨æ–°çš„åˆ†æå‡½æ•°ï¼Œæ”¯æŒå‰¯éœ²
        const analysis = analyzeHandWithMelds(internalHand, internalWinTile, melds, context);
        
        if (!analysis) {
          analysisError = 'æœªæ£€æµ‹åˆ°æœ‰æ•ˆå½¹ç§ã€‚è¯·æ£€æŸ¥æ‰‹ç‰Œæˆ–æ·»åŠ ç«‹ç›´ã€‚';
          return null;
        }
        
        // (ä¿®å¤ 5) åªæœ‰ç«‹ç›´æˆ–åŒç«‹ç›´æ—¶æ‰åŠ é‡Œå®
        analysis.han += dora + ((isRiichi || isDoubleRiichi) ? uraDora : 0) + redDora;
        
        if(analysis.han === 0) {
          analysisError = 'æ— å½¹ã€‚è¯·æ·»åŠ å½¹ç§ï¼ˆå¦‚ç«‹ç›´ï¼‰æˆ–å®ç‰Œã€‚';
          return null;
        }
        
        analysisError = null;
        return analysis;
      };

      // ====================================================================
      // 4. HANDLER FUNCTIONS
      // ====================================================================

      const getPlayerWind = (index) => {
        const winds = ['east', 'south', 'west', 'north'];
        // ä¿®æ­£è‡ªé£è®¡ç®—ï¼šè‡ªé£æ˜¯ç›¸å¯¹äºåº„å®¶çš„ä½ç½®
        const playerIndex = (index - currentDealerIndex + 4) % 4;
        return winds[playerIndex];
      };
      
      const roundWindDisplay = { 'east': 'æ±', 'south': 'å—', 'west': 'è¥¿', 'north': 'åŒ—' };

      // å·¥å…·å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ˜å‰¯éœ²
      const hasMinimalFuro = () => {
        return melds.some(m => m.type === 'shuntsu' || m.type === 'pon' || m.type === 'minkan');
      };

      // å·¥å…·å‡½æ•°ï¼šè®¡ç®—å®é™…çš„é—¨å‰çŠ¶æ€
      const calculateIsMenzen = () => {
        return melds.length === 0 || melds.every(m => m.type === 'ankan');
      };

      const checkGameOver = (newPlayers, nextRoundState) => {
        if (isGameOver) return true;

        if (gameSettings.tobu && newPlayers.some(p => p.score < 0)) {
          isGameOver = true;
          return true;
        }
        
        const { wind, round } = nextRoundState;
        
        // ä¸œé£æˆ˜: ä¸œåœºç»“æŸ(è¿›å…¥å—åœº)æ—¶ç»“æŸ
        if (gameSettings.type === 'tonpuu' && wind === 'south') {
          isGameOver = true;
          return true;
        }
        
        // åŠåº„æˆ˜: å—åœºç»“æŸ(è¿›å…¥è¥¿åœº)æ—¶ç»“æŸ
        if (gameSettings.type === 'hanchan' && wind === 'west') {
          isGameOver = true;
          return true;
        }
        
        // å…¨åº„æˆ˜: åŒ—åœºç¬¬4å±€ç»“æŸå(wind='north' && round=5,å³å°†åˆ‡æ¢åˆ°ä¸‹ä¸€é£ä½)æ—¶ç»“æŸ
        // æˆ–è€…å·²ç»è¶…è¿‡åŒ—åœº(ç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿ,ä½†ä½œä¸ºä¿é™©)
        if (gameSettings.type === 'yonchan') {
          // åŒ—åœºç»“æŸ: round > 4 æ„å‘³ç€åŒ—4å±€å·²ç»“æŸ,å‡†å¤‡åˆ‡æ¢é£ä½
          if (wind === 'north' && round > 4) {
            isGameOver = true;
            return true;
          }
          // ä¿é™©: å¦‚æœå·²ç»åˆ°äº†åŒ—åœºä¹‹åçš„é£ä½(ç†è®ºä¸Šä¸åº”è¯¥)
          const windOrder = ['east', 'south', 'west', 'north'];
          const windIndex = windOrder.indexOf(wind);
          if (windIndex > 3) {
            isGameOver = true;
            return true;
          }
        }
        
        return false;
      };

      const goToNextRound = (dealerContinuation) => {
        let newWind = gameState.wind;
        let newRound = gameState.round;
        let newHonba = gameState.honba;
        let newDealerIndex = currentDealerIndex;
        let newRiichiSticks = gameState.riichiSticks;

        if (dealerContinuation) {
          // è¿åº„ï¼šæœ¬åœºæ•°+1ï¼Œåº„å®¶å’Œå±€æ•°ä¸å˜
          newHonba += 1;
        } else {
          // éè¿åº„ï¼šæœ¬åœºæ•°å½’é›¶ï¼Œè¿›å…¥ä¸‹ä¸€å±€
          newHonba = 0;
          newRound += 1;
          newDealerIndex = (currentDealerIndex + 1) % 4;
          
          // å®Œæˆ4å±€åï¼Œè¿›å…¥ä¸‹ä¸€é£å±€
          if (newRound > 4) {
            // å…ˆæ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ (åœ¨é‡ç½® round ä¹‹å‰)
            const nextStateBeforeReset = { 
              ...gameState, 
              wind: newWind, 
              round: newRound, 
              honba: newHonba, 
              riichiSticks: newRiichiSticks 
            };
            
            // å¦‚æœæ¸¸æˆç»“æŸ,ç›´æ¥åº”ç”¨çŠ¶æ€å¹¶è¿”å›
            if (checkGameOver(players, nextStateBeforeReset)) {
              gameState = nextStateBeforeReset;
              return;
            }
            
            // æ¸¸æˆæœªç»“æŸ,ç»§ç»­åˆ‡æ¢é£ä½
            newRound = 1;
            const windOrder = ['east', 'south', 'west', 'north'];
            const currentWindIndex = windOrder.indexOf(gameState.wind);
            if (currentWindIndex < windOrder.length - 1) {
              newWind = windOrder[currentWindIndex + 1];
            }
          }
        }
        
        const nextState = { ...gameState, wind: newWind, round: newRound, honba: newHonba, riichiSticks: newRiichiSticks };
        
        if (!checkGameOver(players, nextState)) {
          gameState = nextState;
          currentDealerIndex = newDealerIndex;
          
          const newPlayerWinds = ['ä¸œ', 'å—', 'è¥¿', 'åŒ—'];
          const rotatedPlayers = [...players];
          for (let i = 0; i < 4; i++) {
            rotatedPlayers[i].wind = newPlayerWinds[(i - newDealerIndex + 4) % 4];
          }
          players = rotatedPlayers;
        }
      };
      
      // è·å–å½¹æ»¡ç­‰çº§åç§°
      const getYakumanLevelName = (han) => {
        if (han >= 78) return ' (å…­å€å½¹æ»¡)';
        if (han >= 65) return ' (äº”å€å½¹æ»¡)';
        if (han >= 52) return ' (å››å€å½¹æ»¡)';
        if (han >= 39) return ' (ä¸‰å€å½¹æ»¡)';
        if (han >= 26) return ' (åŒå€å½¹æ»¡)';
        if (han >= 13) return ' (å½¹æ»¡)';
        if (han >= 11) return ' (ä¸‰å€æ»¡)';
        if (han >= 8) return ' (å€æ»¡)';
        if (han >= 6) return ' (è·³æ»¡)';
        if (han >= 5) return ' (æ»¡è´¯)';
        return '';
      };

      // (ä¿®å¤ 3) ä¿®æ­£åˆ†æ•°è®¡ç®— (NaN Bug)
      const calculateScore = (han, fu, isDealer, honba) => {
        const honbaBonusTsumo = honba * 100;
        const honbaBonusRon = honba * 300;
        
        let base = 0;
        let isMangan = false;
        
        // å½¹æ»¡åŠä»¥ä¸Šï¼ˆæ”¯æŒå¤šå€å½¹æ»¡ï¼š13ç•ª=1å€, 26ç•ª=2å€, 39ç•ª=3å€, 52ç•ª=4å€, 65ç•ª=5å€, 78ç•ª=6å€ï¼‰
        if (han >= 13) { 
          const yakumanMultiplier = Math.floor(han / 13); // è®¡ç®—å½¹æ»¡å€æ•°
          base = yakumanMultiplier * (isDealer ? 48000 : 32000); 
          isMangan = true; 
        }
        else if (han >= 11) { base = isDealer ? 36000 : 24000; isMangan = true; }
        else if (han >= 8) { base = isDealer ? 24000 : 16000; isMangan = true; }
        else if (han >= 6) { base = isDealer ? 18000 : 12000; isMangan = true; }
        else if (han === 5) { base = isDealer ? 12000 : 8000; isMangan = true; }
        else {
            let basicPoints = fu * Math.pow(2, 2 + han);
            if (basicPoints > 2000) {
                base = isDealer ? 12000 : 8000; // Mangan cut-off
                isMangan = true;
            } else {
                // éæ»¡è´¯
                if (isDealer) {
                  const nonDealerPays = Math.ceil(basicPoints * 2 / 100) * 100;
                  if (isTsumo) {
                    const each = nonDealerPays + honbaBonusTsumo;
                    return { total: each * 3, each: each };
                  } else {
                    return { total: Math.ceil(basicPoints * 6 / 100) * 100 + honbaBonusRon };
                  }
                } else {
                  const dealerPays = Math.ceil(basicPoints * 2 / 100) * 100;
                  const nonDealerPays = Math.ceil(basicPoints * 1 / 100) * 100;
                  if (isTsumo) {
                    const dealer = dealerPays + honbaBonusTsumo;
                    const nonDealer = nonDealerPays + honbaBonusTsumo;
                    return { total: dealer + nonDealer * 2, dealer: dealer, nonDealer: nonDealer };
                  } else {
                    return { total: Math.ceil(basicPoints * 4 / 100) * 100 + honbaBonusRon };
                  }
                }
            }
        }
        
        // æ»¡è´¯åŠä»¥ä¸Š
        if (isMangan) {
            if (isTsumo) {
                if (isDealer) {
                    const each = Math.ceil(base / 3 / 100) * 100 + honbaBonusTsumo;
                    return { total: each * 3, each: each };
                } else {
                    const dealer = Math.ceil(base / 2 / 100) * 100 + honbaBonusTsumo;
                    const nonDealer = Math.ceil(base / 4 / 100) * 100 + honbaBonusTsumo;
                    return { total: dealer + nonDealer * 2, dealer: dealer, nonDealer: nonDealer };
                }
            } else { // Ron
                return { total: base + honbaBonusRon };
            }
        }
      };
      
      // è®¡ç®—å¤šäººå’Œç‰Œçš„ç‚¹æ•°åˆ†é…
      const calculateMultiWinScores = () => {
        const scores = [0, 0, 0, 0];
        
        // å¤šäººå’Œç‰Œæ€»æ˜¯è£å’Œ(ä¸‰å®¶å’Œä¸å¯èƒ½è‡ªæ‘¸)
        // è£å’Œï¼šæ”¾é“³è€…æ”¯ä»˜æ‰€æœ‰å’Œç‰Œè€…
        if (multiWinLoser === null) return scores;
        
        multiWinners.forEach(winnerIdx => {
          const data = multiWinHanFu[winnerIdx];
          if (!data) return;
          
          const { han, fu } = data;
          const isDealer = winnerIdx === currentDealerIndex;
          const scoreData = calculateScore(han, fu, false, isDealer); // æ€»æ˜¯è£å’Œ
          
          if (!scoreData) return;
          
          scores[winnerIdx] += scoreData.total;
          scores[multiWinLoser] -= scoreData.total;
        });
        
        return scores;
      };
      
      // (ä¿®å¤ 3) æ–°å¢ï¼šè·å–åˆ†æ•°å˜åŠ¨
      const getScoreDistribution = (analysis, scoreData) => {
          const changes = [0, 0, 0, 0];
          const riichiBonus = gameState.riichiSticks * 1000;
          
          if (!analysis || !scoreData) return changes;

          const isDealerWin = winnerIndex === currentDealerIndex;

          if (isTsumo) {
              if (isDealerWin) {
                  changes.forEach((_, i) => {
                      if (i === winnerIndex) changes[i] = scoreData.total + riichiBonus;
                      else changes[i] = -scoreData.each;
                  });
              } else {
                  changes.forEach((_, i) => {
                      if (i === winnerIndex) changes[i] = scoreData.total + riichiBonus;
                      else if (i === currentDealerIndex) changes[i] = -scoreData.dealer;
                      else changes[i] = -scoreData.nonDealer;
                  });
              }
          } else {
              if (loserIndex !== null) {
                  changes[winnerIndex] = scoreData.total + riichiBonus;
                  changes[loserIndex] = -scoreData.total;
              }
          }
          return changes;
      };


      const handleWin = () => {
        const analysis = getCurrentAnalysis();
        if (!analysis) {
          alert(analysisError || 'æ— æ•ˆçš„å’Œç‰Œï¼');
          return;
        }

        const isDealerWin = winnerIndex === currentDealerIndex;
        const scoreData = calculateScore(analysis.han, analysis.fu, isDealerWin, gameState.honba);
        const newPlayers = JSON.parse(JSON.stringify(players));
        
        // ç»Ÿè®¡ç«‹ç›´ç©å®¶ï¼ˆç«‹ç›´æ£’å·²ç»åœ¨ç«‹ç›´æ—¶æ‰£é™¤ï¼Œè¿™é‡Œåªæ˜¯ç»Ÿè®¡ï¼‰
        const riichiPlayers = [];
        newPlayers.forEach((p, i) => {
          if (p.isRiichi) {
            riichiPlayers.push(i);
          }
        });
        
        // (ä¿®å¤ 3) ä½¿ç”¨ getScoreDistribution æ¥è®¡ç®— (å·²åŒ…å«ç«‹ç›´æ£’)
        const scoreChanges = getScoreDistribution(analysis, scoreData);
        newPlayers.forEach((p, i) => {
            p.score += scoreChanges[i];
        });
        
        // ç«‹ç›´æ£’å·²åœ¨ getScoreDistribution ä¸­è®¡ç®—ï¼Œè¿™é‡Œåªè®°å½•æ•°å€¼
        const riichiBonus = gameState.riichiSticks * 1000;
        
        // æ¸…é™¤æ‰€æœ‰ç©å®¶çš„ç«‹ç›´çŠ¶æ€
        newPlayers.forEach(p => p.isRiichi = false);
        
        const roundData = {
          round: `${roundWindDisplay[gameState.wind]}${gameState.round}å±€ ${gameState.honba}æœ¬åœº`,
          dealer: players[currentDealerIndex].name,
          winner: players[winnerIndex].name,
          type: isTsumo ? 'è‡ªæ‘¸' : 'è£å’Œ',
          yaku: analysis.yaku.join(' / ') + ` (å®${dora}+é‡Œ${isRiichi ? uraDora : 0}+èµ¤${redDora})`,
          han: analysis.han,
          fu: analysis.fu,
          score: scoreData.total,
          loser: isTsumo ? 'å…¨å‘˜' : (loserIndex !== null ? players[loserIndex].name : '-'),
          riichiBonus: riichiBonus,
          riichiPlayers: riichiPlayers.map(i => players[i].name).join(', '),
          scoreChanges: scoreChanges, // (ä¿®å¤ 3) ä¿å­˜å˜åŠ¨
          currentScores: newPlayers.map(p => p.score), // ä¿å­˜è¯¥å±€ç»“æŸåæ¯ä¸ªç©å®¶çš„åˆ†æ•°
          // ç‰Œè°±ä¿¡æ¯
          handData: {
            tiles: [...selectedTiles], // æ‰‹ç‰Œ
            melds: JSON.parse(JSON.stringify(melds)), // å‰¯éœ²
            winTile: winTile, // å’Œç‰Œ
            isMenzen: isMenzen, // é—¨å‰æ¸…
            dora: dora, // å®ç‰Œæ•°
            uraDora: uraDora, // é‡Œå®ç‰Œæ•°
            redDora: redDora, // èµ¤å®ç‰Œæ•°
            isRiichi: isRiichi, // ç«‹ç›´
            isDoubleRiichi: isDoubleRiichi, // äºŒç«‹ç›´
            isIppatsu: isIppatsu, // ä¸€å‘
            isTenhou: isTenhou, // å¤©å’Œ
            isChiihou: isChiihou, // åœ°å’Œ
            isRenhou: isRenhou, // äººå’Œ
            isHaitei: isHaitei, // æµ·åº•
            isHoutei: isHoutei, // æ²³åº•
            isRinshan: isRinshan, // å²­ä¸Š
            isChankan: isChankan // æŠ¢æ 
          }
        };
        
        roundHistory = [...roundHistory, roundData];
        gameState.riichiSticks = 0;
        
        if (checkGameOver(newPlayers, gameState)) {
            players = newPlayers;
            isGameOver = true;
            saveGameState(); // ç»“ç®—åä¿å­˜
            render();
        } else {
            players = newPlayers;
            goToNextRound(isDealerWin);
            resetScoreInput();
            saveGameState(); // ç»“ç®—åä¿å­˜
        }
      };

      const handleMultiWin = () => {
        // æ£€æŸ¥è‡³å°‘æœ‰ä¸€ä¸ªå’Œç‰Œè€…
        if (multiWinners.length === 0) {
          alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä½å’Œç‰Œè€…!');
          return;
        }
        
        // å¤šäººå’Œç‰Œæ€»æ˜¯è£å’Œ,æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æ”¾é“³è€…
        if (multiWinLoser === null) {
          alert('è£å’Œæ—¶è¯·é€‰æ‹©æ”¾é“³è€…!');
          return;
        }
        
        // è®¡ç®—åˆ†æ•°å˜åŒ–
        const calculatedScores = calculateMultiWinScores();
        multiWinScores = [...calculatedScores];
        
        // æ£€æŸ¥åˆ†æ•°æ€»å’Œæ˜¯å¦ä¸º0
        const totalChange = multiWinScores.reduce((sum, score) => sum + score, 0);
        if (totalChange !== 0) {
          alert(`åˆ†æ•°è®¡ç®—é”™è¯¯ï¼æ€»å’Œï¼š${totalChange}ï¼ˆåº”ä¸º0ï¼‰`);
          return;
        }
        
        const newPlayers = JSON.parse(JSON.stringify(players));
        
        // åº”ç”¨åˆ†æ•°å˜åŒ–
        newPlayers.forEach((p, i) => {
          p.score += multiWinScores[i];
        });
        
        // æ¸…é™¤æ‰€æœ‰ç©å®¶çš„ç«‹ç›´çŠ¶æ€
        newPlayers.forEach(p => p.isRiichi = false);
        
        // å’Œç‰Œè€…å¹³åˆ†ç«‹ç›´æ£’
        const riichiBonus = gameState.riichiSticks * 1000;
        if (multiWinners.length > 0 && riichiBonus > 0) {
          const bonusPerWinner = Math.floor(riichiBonus / multiWinners.length);
          multiWinners.forEach(idx => {
            newPlayers[idx].score += bonusPerWinner;
            multiWinScores[idx] += bonusPerWinner;
          });
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰åº„å®¶å’Œç‰Œ
        const isDealerWin = multiWinners.includes(currentDealerIndex);
        
        // ä¸ºæ¯ä¸ªå’Œç‰Œè€…æ”¶é›†è¯¦ç»†ä¿¡æ¯
        const winnersDetails = multiWinners.map(winnerIdx => {
          const data = multiWinHanFu[winnerIdx] || { han: 0, fu: 0 };
          const isDealer = winnerIdx === currentDealerIndex;
          const scoreData = calculateScore(data.han, data.fu, false, isDealer);
          return {
            name: players[winnerIdx].name,
            wind: players[winnerIdx].wind,
            han: data.han,
            fu: data.fu,
            score: scoreData ? scoreData.total : 0,
            isDealer: isDealer
          };
        });
        
        const roundData = {
          round: `${roundWindDisplay[gameState.wind]}${gameState.round}å±€ ${gameState.honba}æœ¬åœº`,
          dealer: players[currentDealerIndex].name,
          winner: multiWinners.map(i => players[i].name).join(' & '),
          type: 'å¤šäººå’Œç‰Œ',
          yaku: '-',
          han: 0,
          fu: 0,
          score: multiWinners.reduce((sum, i) => sum + multiWinScores[i], 0),
          loser: players[multiWinLoser].name, // å¤šäººå’Œç‰Œæ€»æ˜¯è£å’Œ
          riichiBonus: riichiBonus,
          riichiPlayers: '-',
          scoreChanges: [...multiWinScores],
          currentScores: newPlayers.map(p => p.score), // ä¿å­˜è¯¥å±€ç»“æŸåæ¯ä¸ªç©å®¶çš„åˆ†æ•°
          // å¤šäººå’Œç‰Œä¸“ç”¨å­—æ®µ
          isMultiWin: true,
          winnersDetails: winnersDetails, // æ¯ä¸ªå’Œç‰Œè€…çš„è¯¦ç»†ä¿¡æ¯
          multiWinCount: multiWinners.length // å’Œç‰Œäººæ•°
        };
        
        roundHistory = [...roundHistory, roundData];
        gameState.riichiSticks = 0;
        
        if (checkGameOver(newPlayers, gameState)) {
            players = newPlayers;
            isGameOver = true;
            saveGameState(); // ç»“ç®—åä¿å­˜
            render();
        } else {
            players = newPlayers;
            goToNextRound(isDealerWin);
            resetScoreInput();
            saveGameState(); // ç»“ç®—åä¿å­˜
        }
      };

      const handleDrawConfirm = () => {
        const tenpaiCount = tenpaiedPlayers.length;
        const notenCount = 4 - tenpaiCount;
        const newPlayers = JSON.parse(JSON.stringify(players));
        const scoreChanges = [0, 0, 0, 0];

        // å¼€å±€æµå±€ï¼šç‚¹æ•°ä¸å˜ï¼Œåªå¢åŠ å±€æ•°
        if (!isStartingHandDraw) {
          // å…ˆå¤„ç†æµå±€æ»¡è´¯ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
          if (nagashiManganPlayers.length > 0) {
            nagashiManganPlayers.forEach(winnerIdx => {
              const isDealer = winnerIdx === currentDealerIndex;
              const eachPay = isDealer ? 4000 : 2000; // æ»¡è´¯è‡ªæ‘¸ï¼šåº„å®¶æ¯å®¶4000ï¼Œé—²å®¶æ¯å®¶2000
              const dealerPay = 4000; // é—²å®¶æ»¡è´¯æ—¶åº„å®¶æ”¯ä»˜4000
              
              newPlayers.forEach((p, idx) => {
                if (idx !== winnerIdx) {
                  if (isDealer) {
                    // åº„å®¶æµå±€æ»¡è´¯ï¼šæ¯å®¶æ”¯ä»˜4000
                    p.score -= eachPay;
                    scoreChanges[idx] -= eachPay;
                  } else {
                    // é—²å®¶æµå±€æ»¡è´¯ï¼šåº„å®¶4000ï¼Œå…¶ä»–é—²å®¶2000
                    const payment = idx === currentDealerIndex ? dealerPay : eachPay;
                    p.score -= payment;
                    scoreChanges[idx] -= payment;
                  }
                }
              });
              
              // æµå±€æ»¡è´¯è€…è·å¾—ç‚¹æ•°
              const totalGain = isDealer ? 12000 : 8000;
              newPlayers[winnerIdx].score += totalGain;
              scoreChanges[winnerIdx] += totalGain;
            });
          }
          
          // å†å¤„ç†æ™®é€šæµå±€å¬ç‰Œç½šç¬¦ï¼ˆå¦‚æœæœ‰æµå±€æ»¡è´¯ï¼Œä¹Ÿå¯ä»¥åŒæ—¶è®¡ç®—å¬ç‰Œç½šç¬¦ï¼‰
          if (tenpaiCount > 0 && notenCount > 0) {
            const payPerNoten = Math.round(3000 / notenCount);
            const receivePerTenpai = Math.round(3000 / tenpaiCount);
            
            newPlayers.forEach((p, i) => {
              if (tenpaiedPlayers.includes(i)) {
                p.score += receivePerTenpai;
                scoreChanges[i] += receivePerTenpai;
              } else {
                p.score -= payPerNoten;
                scoreChanges[i] -= payPerNoten;
              }
            });
          }
        }
        
        // æµå±€æ—¶å¤„ç†ç«‹ç›´æ£’
        // ç«‹ç›´çš„ç©å®¶äº¤å‡º1000ç‚¹ç«‹ç›´æ£’
        drawRiichiPlayers.forEach(i => {
          newPlayers[i].score -= 1000;
          scoreChanges[i] -= 1000;
          gameState.riichiSticks += 1;
        });
        
        // è®°å½•æ‰€æœ‰ç«‹ç›´ç©å®¶ï¼ˆåŒ…æ‹¬ä¹‹å‰å·²ç»ç«‹ç›´çš„å’Œæœ¬å±€æ–°ç«‹ç›´çš„ï¼‰
        const allRiichiPlayers = [];
        newPlayers.forEach((p, i) => {
          if (p.isRiichi || drawRiichiPlayers.includes(i)) {
            allRiichiPlayers.push(i);
          }
        });
        const riichiPlayers = allRiichiPlayers.map(i => players[i].name);
        
        // æµå±€åæ¸…é™¤æ‰€æœ‰ç«‹ç›´çŠ¶æ€ï¼ˆç«‹ç›´æ£’ä¿ç•™åœ¨åœºä¸Šï¼‰
        newPlayers.forEach(p => p.isRiichi = false);
        
        // æ„å»ºæµå±€æè¿°
        let drawType = '';
        let drawYaku = '';
        
        if (isStartingHandDraw) {
          drawType = 'æµå±€ (å¼€å±€æµå±€)';
          drawYaku = 'å¼€å±€æµå±€ï¼ˆç‚¹æ•°ä¸å˜ï¼‰';
        } else if (nagashiManganPlayers.length > 0) {
          const nagashiNames = nagashiManganPlayers.map(i => players[i].name).join('ã€');
          drawType = `æµå±€ (${nagashiNames} æµå±€æ»¡è´¯)`;
          drawYaku = `æµå±€æ»¡è´¯ - ${nagashiNames}`;
          if (tenpaiCount > 0) {
            drawYaku += ` | ${tenpaiedPlayers.map(i => players[i].name).join('ã€')} å¬ç‰Œ`;
          }
        } else {
          drawType = 'æµå±€ (' + tenpaiCount + 'äººå¬ç‰Œ)';
          drawYaku = tenpaiedPlayers.map(i => players[i].name).join(', ') + ' å¬ç‰Œ';
        }
        
        const roundData = {
          round: `${roundWindDisplay[gameState.wind]}${gameState.round}å±€ ${gameState.honba}æœ¬åœº`,
          dealer: players[currentDealerIndex].name,
          winner: nagashiManganPlayers.length > 0 ? nagashiManganPlayers.map(i => players[i].name).join('ã€') : '-',
          type: drawType,
          yaku: drawYaku,
          han: nagashiManganPlayers.length > 0 ? 5 : 0, // æµå±€æ»¡è´¯è§†ä¸º5ç•ªï¼ˆæ»¡è´¯ï¼‰
          fu: 0, 
          score: 0, 
          loser: '-',
          riichiPlayers: riichiPlayers.join(', '),
          scoreChanges: scoreChanges, // (ä¿®å¤ 3) ä¿å­˜å˜åŠ¨
          currentScores: newPlayers.map(p => p.score) // ä¿å­˜è¯¥å±€ç»“æŸåæ¯ä¸ªç©å®¶çš„åˆ†æ•°
        };
        roundHistory = [...roundHistory, roundData];
        
        // å¼€å±€æµå±€æ—¶åº„å®¶è¿åº„ï¼Œæ™®é€šæµå±€æ—¶æ ¹æ®åº„å®¶æ˜¯å¦å¬ç‰Œå†³å®š
        // æµå±€æ»¡è´¯æ—¶ï¼šå¦‚æœæµå±€æ»¡è´¯è€…åŒ…å«åº„å®¶ï¼Œåˆ™è¿åº„
        const isDealerTenpai = isStartingHandDraw 
          ? true 
          : (nagashiManganPlayers.includes(currentDealerIndex) || tenpaiedPlayers.includes(currentDealerIndex));
        
        if (checkGameOver(newPlayers, gameState)) {
            players = newPlayers;
            isGameOver = true;
            // æ¸…é™¤æµå±€æ»¡è´¯çŠ¶æ€
            nagashiManganPlayers = [];
            showNagashiMangan = false;
            saveGameState(); // ç»“ç®—åä¿å­˜
            render();
        } else {
            players = newPlayers;
            goToNextRound(isDealerTenpai);
            showDrawDialog = false;
            tenpaiedPlayers = [];
            drawRiichiPlayers = [];
            isStartingHandDraw = false;
            // æ¸…é™¤æµå±€æ»¡è´¯çŠ¶æ€
            nagashiManganPlayers = [];
            showNagashiMangan = false;
            saveGameState(); // ç»“ç®—åä¿å­˜
            render();
        }
      };

      const resetScoreInput = () => {
        showScoreInput = false;
        winnerIndex = null;
        winnerIndices = [];
        loserIndex = null;
        isTsumo = true;
        isMenzen = true;
        selectedTiles = [];
        melds = [];
        winTile = null;
        isRiichi = false;
        isIppatsu = false;
        isDoubleRiichi = false;
        isTenhou = false;
        isChiihou = false;
        isRenhou = false;
        isHaitei = false;
        isHoutei = false;
        isRinshan = false;
        isChankan = false;
        dora = 0;
        uraDora = 0;
        redDora = 0;
        tenpaiWaits = [];
        analysisError = null;
        isManualMode = false;
        manualYaku = [];
        manualFu = 40;
        isManualFuro = false;
        isExpertMode = false;
        expertHan = 1;
        expertFu = 30;
        activeTileArea = 'hand'; // å›åˆ°æ‰‹ç‰ŒåŒº
        render();
      };

      const resetGame = () => {
        // æ¸…é™¤ä¿å­˜çš„æ¸¸æˆçŠ¶æ€
        clearGameState();
        
        gameSettings = null;
        isGameOver = false;
        players = [
          { id: 1, name: 'ä¸œå®¶', score: 25000, wind: 'æ±', isRiichi: false },
          { id: 2, name: 'å—å®¶', score: 25000, wind: 'å—', isRiichi: false },
          { id: 3, name: 'è¥¿å®¶', score: 25000, wind: 'è¥¿', isRiichi: false },
          { id: 4, name: 'åŒ—å®¶', score: 25000, wind: 'åŒ—', isRiichi: false }
        ];
        gameState = { wind: 'east', round: 1, honba: 0, riichiSticks: 0 };
        currentDealerIndex = 0;
        roundHistory = [];
        showDrawDialog = false;
        
        showScoreInput = false;
        winnerIndex = null;
        loserIndex = null;
        isTsumo = true;
        isMenzen = true;
        selectedTiles = [];
        melds = [];
        winTile = null;
        isRiichi = false;
        isIppatsu = false;
        dora = 0;
        uraDora = 0;
        redDora = 0;
        tenpaiWaits = [];
        analysisError = null;
        
        render();
      };

      // ====================================================================
      // å¯¼å‡ºå¯¹å±€è®°å½•åŠŸèƒ½
      // ====================================================================
      
      const exportGameRecord = () => {
        // æ„å»ºå¯¼å‡ºæ•°æ®
        const exportData = {
          exportDate: new Date().toLocaleString('zh-CN'),
          gameSettings: gameSettings,
          gameInfo: {
            gameType: gameSettings.type === 'tonpuu' ? 'ä¸œé£æˆ˜' : gameSettings.type === 'hanchan' ? 'åŠåº„æˆ˜' : 'å…¨åº„æˆ˜',
            tobuEnabled: gameSettings.tobu,
            currentWind: roundWindDisplay[gameState.wind],
            currentRound: gameState.round,
            honba: gameState.honba,
            riichiSticks: gameState.riichiSticks,
            isGameOver: isGameOver
          },
          players: players.map(p => ({
            name: p.name,
            wind: p.wind,
            score: p.score,
            isRiichi: p.isRiichi
          })),
          roundHistory: roundHistory,
          totalRounds: roundHistory.length
        };

        // ç”Ÿæˆæ–‡æœ¬æ ¼å¼çš„è®°å½•
        let textContent = '==========================================\n';
        textContent += '      æ—¥æœ¬éº»å°†å¯¹å±€è®°å½•\n';
        textContent += '==========================================\n\n';
        
        textContent += `å¯¼å‡ºæ—¶é—´: ${exportData.exportDate}\n`;
        textContent += `å¯¹å±€ç±»å‹: ${exportData.gameInfo.gameType}${exportData.gameInfo.tobuEnabled ? ' (å‡»é£è§„åˆ™)' : ''}\n`;
        textContent += `å½“å‰è¿›åº¦: ${exportData.gameInfo.currentWind} ${exportData.gameInfo.currentRound} å±€ / ${exportData.gameInfo.honba} æœ¬åœº\n`;
        textContent += `ç«‹ç›´æ£’: ${exportData.gameInfo.riichiSticks}\n`;
        textContent += `å¯¹å±€çŠ¶æ€: ${exportData.gameInfo.isGameOver ? 'å·²ç»“æŸ' : 'è¿›è¡Œä¸­'}\n`;
        textContent += `æ€»å±€æ•°: ${exportData.totalRounds}\n\n`;
        
        textContent += '------------------------------------------\n';
        textContent += 'ç©å®¶ä¿¡æ¯\n';
        textContent += '------------------------------------------\n';
        
        // æŒ‰å½“å‰åˆ†æ•°æ’åºæ˜¾ç¤º
        const sortedPlayers = [...exportData.players].sort((a, b) => b.score - a.score);
        sortedPlayers.forEach((p, idx) => {
          const rank = idx + 1;
          const rankSymbol = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '  ';
          textContent += `${rankSymbol} ${rank}. ${p.name} (${p.wind}): ${p.score.toLocaleString()} ç‚¹`;
          if (p.isRiichi) textContent += ' [ç«‹ç›´ä¸­]';
          textContent += '\n';
        });
        
        textContent += '\n------------------------------------------\n';
        textContent += 'å¯¹å±€å†å²\n';
        textContent += '------------------------------------------\n\n';
        
        if (roundHistory.length === 0) {
          textContent += 'æš‚æ— å†å²è®°å½•ã€‚\n';
        } else {
          roundHistory.forEach((round, idx) => {
            textContent += `ã€ç¬¬ ${idx + 1} å±€ã€‘\n`;
            textContent += `  å±€æ•°: ${round.round}\n`;
            textContent += `  åº„å®¶: ${round.dealer}\n`;
            textContent += `  ç±»å‹: ${round.type}\n`;
            
            if (round.winner !== '-') {
              // æ£€æŸ¥æ˜¯å¦ä¸ºå¤šäººå’Œç‰Œ
              if (round.isMultiWin && round.winnersDetails) {
                textContent += `  ğŸ‰ ${round.multiWinCount}å®¶å’Œç‰Œ (ä¸‰å®¶å’Œ)\n`;
                textContent += `  æ”¾é“³è€…: ${round.loser}\n`;
                textContent += `  --- å’Œç‰Œè€…è¯¦æƒ… ---\n`;
                round.winnersDetails.forEach((winner, idx) => {
                  textContent += `    ${idx + 1}. ${winner.wind} ${winner.name}${winner.isDealer ? ' [åº„]' : ''}\n`;
                  textContent += `       ç•ªç¬¦: ${winner.han}ç•ª${winner.fu}ç¬¦\n`;
                  textContent += `       å¾—ç‚¹: +${winner.score.toLocaleString()} ç‚¹\n`;
                });
                textContent += `  ------------------\n`;
                textContent += `  æ€»å¾—åˆ†: ${round.score.toLocaleString()} ç‚¹\n`;
                if (round.riichiBonus > 0) {
                  textContent += `  ç«‹ç›´æ£’: +${round.riichiBonus.toLocaleString()} ç‚¹ (å¹³å‡åˆ†é…)\n`;
                }
              } else {
                // æ™®é€šå’Œç‰Œ
                textContent += `  å’Œç‰Œè€…: ${round.winner}\n`;
                if (round.loser !== 'å…¨å‘˜' && round.loser !== '-') {
                  textContent += `  æ”¾é“³è€…: ${round.loser}\n`;
                }
                textContent += `  å½¹ç§: ${round.yaku}\n`;
                textContent += `  ç•ªç¬¦: ${round.han}ç•ª${round.fu}ç¬¦\n`;
                textContent += `  å¾—ç‚¹: ${round.score.toLocaleString()} ç‚¹\n`;
                if (round.riichiBonus > 0) {
                  textContent += `  ç«‹ç›´æ£’: +${round.riichiBonus.toLocaleString()} ç‚¹\n`;
                }
              }
              
              if (round.riichiPlayers && !round.isMultiWin) {
                textContent += `  ç«‹ç›´ç©å®¶: ${round.riichiPlayers}\n`;
              }
              
              // æ·»åŠ ç‰Œè°±ä¿¡æ¯ (ä»…æ™®é€šå’Œç‰Œæœ‰ç‰Œè°±)
              if (round.handData && !round.isMultiWin) {
                textContent += `  --- ç‰Œè°± ---\n`;
                
                // æ‰‹ç‰Œ
                if (round.handData.tiles && round.handData.tiles.length > 0) {
                  textContent += `  æ‰‹ç‰Œ: ${round.handData.tiles.join(' ')}\n`;
                }
                
                // å‰¯éœ²
                if (round.handData.melds && round.handData.melds.length > 0) {
                  textContent += `  å‰¯éœ²: `;
                  const meldStrs = round.handData.melds.map(m => {
                    const typeNames = {
                      'shuntsu': 'é¡ºå­',
                      'pon': 'ç¢°',
                      'minkan': 'æ˜æ ',
                      'ankan': 'æš—æ '
                    };
                    return `${typeNames[m.type]}[${m.tiles.join(' ')}]`;
                  });
                  textContent += meldStrs.join(' ') + '\n';
                }
                
                // å’Œç‰Œ
                if (round.handData.winTile) {
                  textContent += `  å’Œç‰Œ: ${round.handData.winTile}\n`;
                }
                
                // çŠ¶å†µå½¹
                const statusYaku = [];
                if (round.handData.isMenzen) statusYaku.push('é—¨å‰æ¸…');
                if (round.handData.isRiichi) statusYaku.push('ç«‹ç›´');
                if (round.handData.isDoubleRiichi) statusYaku.push('äºŒç«‹ç›´');
                if (round.handData.isIppatsu) statusYaku.push('ä¸€å‘');
                if (round.handData.isTenhou) statusYaku.push('å¤©å’Œ');
                if (round.handData.isChiihou) statusYaku.push('åœ°å’Œ');
                if (round.handData.isRenhou) statusYaku.push('äººå’Œ');
                if (round.handData.isHaitei) statusYaku.push('æµ·åº•');
                if (round.handData.isHoutei) statusYaku.push('æ²³åº•');
                if (round.handData.isRinshan) statusYaku.push('å²­ä¸Š');
                if (round.handData.isChankan) statusYaku.push('æŠ¢æ ');
                
                if (statusYaku.length > 0) {
                  textContent += `  çŠ¶å†µ: ${statusYaku.join(', ')}\n`;
                }
                
                textContent += `  ------------\n`;
              }
            } else {
              textContent += `  ç»“æœ: ${round.yaku}\n`;
            }
            
            if (round.scoreChanges) {
              textContent += `  åˆ†æ•°å˜åŒ–:\n`;
              exportData.players.forEach((p, i) => {
                const change = round.scoreChanges[i];
                const sign = change > 0 ? '+' : '';
                textContent += `    ${p.name}: ${sign}${change.toLocaleString()}\n`;
              });
            }
            
            if (round.currentScores) {
              textContent += `  å½“å‰åˆ†æ•°:\n`;
              exportData.players.forEach((p, i) => {
                textContent += `    ${p.name}: ${round.currentScores[i].toLocaleString()}\n`;
              });
            }
            
            textContent += '\n';
          });
        }
        
        textContent += '==========================================\n';
        textContent += '       è®°å½•ç»“æŸ\n';
        textContent += '==========================================\n';
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        link.href = url;
        link.download = `éº»å°†å¯¹å±€è®°å½•_${timestamp}.txt`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        alert('å¯¹å±€è®°å½•å·²å¯¼å‡ºä¸ºTXTæ–‡æœ¬æ–‡ä»¶ï¼');
      };

      // è·å–æ‰€æœ‰ç‰Œçš„ä½¿ç”¨æƒ…å†µï¼ˆæ‰‹ç‰Œ+å‰¯éœ²+å’Œç‰Œï¼‰
      const getTileUsageCount = (tile) => {
        const handCount = selectedTiles.filter(t => t === tile).length;
        const meldCount = melds.reduce((sum, meld) => {
          return sum + meld.tiles.filter(t => t === tile).length;
        }, 0);
        const winTileCount = (winTile === tile) ? 1 : 0;
        return handCount + meldCount + winTileCount;
      };

      // è®¡ç®—æ€»ç‰Œæ•°é™åˆ¶ï¼ˆ13 + æ å­æ•°é‡ï¼‰
      const getTotalTileLimit = () => {
        const kanCount = melds.filter(m => m.type === 'minkan' || m.type === 'ankan').length;
        return 13 + kanCount;
      };

      // è®¡ç®—å½“å‰åº”è¯¥æœ‰çš„æ‰‹ç‰Œæ€»æ•°ï¼ˆæ€»æ•° - å‰¯éœ²åŒºå·²ç”¨ï¼‰
      const getRequiredHandTileCount = () => {
        const totalLimit = getTotalTileLimit();
        const meldCount = melds.reduce((sum, meld) => sum + meld.tiles.length, 0);
        return totalLimit - meldCount;
      };

      // è®¡ç®—å½“å‰æ‰‹ç‰Œå’Œå‰¯éœ²çš„æ€»æ•°
      const getCurrentTotalTileCount = () => {
        const handCount = selectedTiles.length;
        const meldCount = melds.reduce((sum, meld) => sum + meld.tiles.length, 0);
        return handCount + meldCount;
      };

      // æ·»åŠ å‰¯éœ²ç»„
      const addMeld = (type, firstTile) => {
        const internal = displayToInternal[firstTile];
        if (!internal) return;

        let tiles = [];
        
        if (type === 'shuntsu') {
          // é¡ºå­ï¼šä»¥ç¬¬ä¸€å¼ ç‰Œä¸ºåŸºå‡†ï¼Œè‡ªåŠ¨è¡¥å…¨åä¸¤å¼ 
          const num = parseInt(internal[0]);
          const suit = internal[1];
          if (suit === 'z' || num > 7) {
            alert('å­—ç‰Œä¸èƒ½ç»„æˆé¡ºå­ï¼Œæ•°å­—ç‰Œ7ä»¥ä¸Šä¸èƒ½ä½œä¸ºé¡ºå­èµ·å§‹ç‰Œï¼');
            return;
          }
          tiles = [
            internalToDisplay[`${num}${suit}`],
            internalToDisplay[`${num + 1}${suit}`],
            internalToDisplay[`${num + 2}${suit}`]
          ];
        } else if (type === 'pon') {
          // åˆ»å­ï¼šä¸‰å¼ ç›¸åŒçš„ç‰Œ
          tiles = [firstTile, firstTile, firstTile];
        } else if (type === 'minkan') {
          // æ˜æ ï¼šå››å¼ ç›¸åŒçš„ç‰Œ
          tiles = [firstTile, firstTile, firstTile, firstTile];
        } else if (type === 'ankan') {
          // æš—æ ï¼šå››å¼ ç›¸åŒçš„ç‰Œ
          tiles = [firstTile, firstTile, firstTile, firstTile];
        }

        // æ£€æŸ¥æ¯å¼ ç‰Œæ˜¯å¦è¶…è¿‡4å¼ 
        // å…ˆç»Ÿè®¡æœ¬æ¬¡å‰¯éœ²ä¸­æ¯å¼ ç‰Œçš„æ•°é‡
        const tileCount = {};
        for (const tile of tiles) {
          tileCount[tile] = (tileCount[tile] || 0) + 1;
        }
        
        // æ£€æŸ¥æ¯ç§ç‰ŒåŠ ä¸Šæœ¬æ¬¡ä½¿ç”¨é‡æ˜¯å¦è¶…è¿‡4å¼ 
        for (const tile in tileCount) {
          const currentCount = getTileUsageCount(tile);
          const addCount = tileCount[tile];
          if (currentCount + addCount > 4) {
            alert(`${tile} å½“å‰å·²ä½¿ç”¨${currentCount}å¼ ï¼Œæ·»åŠ æ­¤å‰¯éœ²éœ€è¦${addCount}å¼ ï¼Œæ€»å…±${currentCount + addCount}å¼ è¶…è¿‡4å¼ ä¸Šé™ï¼`);
            return;
          }
        }

        // æ£€æŸ¥æ·»åŠ åæ€»ç‰Œæ•°æ˜¯å¦è¶…è¿‡é™åˆ¶
        const currentTotal = getCurrentTotalTileCount();
        const totalLimit = getTotalTileLimit();
        const newKanCount = (type === 'minkan' || type === 'ankan') ? 1 : 0;
        const newLimit = totalLimit + newKanCount;
        
        if (currentTotal + tiles.length > newLimit) {
          alert(`æ·»åŠ æ­¤å‰¯éœ²åæ€»ç‰Œæ•°å°†è¶…è¿‡é™åˆ¶ï¼ˆå½“å‰${currentTotal}ï¼Œé™åˆ¶${newLimit}ï¼‰ï¼è¯·å…ˆè°ƒæ•´æ‰‹ç‰Œæ•°é‡ã€‚`);
          return;
        }

        melds.push({ type, tiles });
        
        // å¦‚æœæœ‰æ˜å‰¯éœ²ï¼Œè‡ªåŠ¨å–æ¶ˆé—¨å‰çŠ¶æ€å’Œç«‹ç›´çŠ¶æ€
        if (type === 'shuntsu' || type === 'pon' || type === 'minkan') {
          isMenzen = false;
          // æœ‰æ˜å‰¯éœ²æ—¶ï¼Œå¿…é¡»æ¸…é™¤ç«‹ç›´å’ŒåŒç«‹ç›´çŠ¶æ€ï¼ˆçŠ¶å†µå½¹ï¼‰
          isRiichi = false;
          isDoubleRiichi = false;
          isIppatsu = false; // ä¸€å‘ä¹Ÿéœ€è¦æ¸…é™¤ï¼Œå› ä¸ºéœ€è¦ç«‹ç›´
          // æ¸…é™¤å¤©åœ°äººå’Œï¼ˆè¿™äº›å½¹ç§éœ€è¦é—¨å‰æ¸…ï¼‰
          isTenhou = false;
          isChiihou = false;
          isRenhou = false;
          
          // å¦‚æœå·²é€‰æ‹©å’Œç‰Œè€…ï¼Œå¹¶ä¸”å’Œç‰Œè€…å·²ç»ç«‹ç›´ï¼Œæ¸…é™¤å’Œç‰Œè€…çš„ç«‹ç›´çŠ¶æ€
          if (winnerIndex !== null && players[winnerIndex].isRiichi) {
            players[winnerIndex].isRiichi = false;
            // è¿”è¿˜ç«‹ç›´æ£’
            players[winnerIndex].score += 1000;
            gameState.riichiSticks = Math.max(0, gameState.riichiSticks - 1);
          }
        }
        
        // å³ä½¿æ˜¯æš—æ ï¼ŒæŒ‰ä¸¥æ ¼è§„åˆ™ä¹Ÿä¼šå½±å“å¤©åœ°äººå’Œ
        // ï¼ˆç¬¬ä¸€å·¡æœ‰ä»»ä½•å‰¯éœ²æ“ä½œéƒ½ä¸èƒ½æˆç«‹å¤©åœ°äººå’Œï¼‰
        if (type === 'ankan') {
          isTenhou = false;
          isChiihou = false;
          isRenhou = false;
        }
        
        autoAdjustRedDora(); // è‡ªåŠ¨è°ƒæ•´çº¢å®ç‰Œ
        render();
      };

      // åˆ é™¤å‰¯éœ²ç»„
      const removeMeld = (index) => {
        melds = melds.filter((_, i) => i !== index);
        
        // è‡ªåŠ¨æ›´æ–°é—¨å‰çŠ¶æ€ï¼šåªæœ‰æ²¡æœ‰æ˜å‰¯éœ²æ—¶æ‰æ˜¯é—¨å‰
        const hasMinFuro = hasMinimalFuro();
        isMenzen = !hasMinFuro;
        
        // å¦‚æœå’Œç‰Œè€…å·²ç«‹ç›´ï¼Œä¸”ç°åœ¨æ²¡æœ‰æ˜å‰¯éœ²ï¼Œé‡æ–°å¯ç”¨ç«‹ç›´çŠ¶å†µå½¹
        if (winnerIndex !== null && players[winnerIndex].isRiichi && !hasMinFuro) {
          isRiichi = true;
          isDoubleRiichi = false; // é»˜è®¤ä¸ºæ™®é€šç«‹ç›´
        }
        
        autoAdjustRedDora(); // è‡ªåŠ¨è°ƒæ•´çº¢å®ç‰Œ
        render();
      };

      // æ¸…ç©ºå‰¯éœ²åŒº
      const clearMelds = () => {
        melds = [];
        isMenzen = true; // æ²¡æœ‰å‰¯éœ²ï¼Œè‡ªåŠ¨é—¨å‰
        
        // å¦‚æœå’Œç‰Œè€…å·²ç«‹ç›´ï¼Œé‡æ–°å¯ç”¨ç«‹ç›´çŠ¶å†µå½¹
        if (winnerIndex !== null && players[winnerIndex].isRiichi) {
          isRiichi = true;
          isDoubleRiichi = false; // é»˜è®¤ä¸ºæ™®é€šç«‹ç›´
        }
        
        render();
      };

      const addTile = (tile) => {
        const requiredCount = getRequiredHandTileCount();
        if (selectedTiles.length >= requiredCount) return;

        // æ£€æŸ¥è¯¥ç‰Œæ˜¯å¦è¶…è¿‡4å¼ 
        if (getTileUsageCount(tile) >= 4) return;
        
        selectedTiles = [...selectedTiles, tile];
        autoAdjustRedDora(); // è‡ªåŠ¨è°ƒæ•´çº¢å®ç‰Œ
        
        // å½“æ‰‹ç‰Œé€‰æ»¡æ—¶,è‡ªåŠ¨è·³è½¬åˆ°å’Œç‰ŒåŒº
        if (selectedTiles.length === requiredCount) {
          activeTileArea = 'win';
          showToast('âœ… æ‰‹ç‰Œå·²æ»¡ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°å’Œç‰ŒåŒº');
        }
        
        render();
      };

      const removeTile = (index) => {
        selectedTiles = selectedTiles.filter((_, i) => i !== index);
        autoAdjustRedDora(); // è‡ªåŠ¨è°ƒæ•´çº¢å®ç‰Œ
        activeTileArea = 'hand'; // å›åˆ°æ‰‹ç‰ŒåŒº
        render();
      };
      
      const clearHand = () => {
          selectedTiles = [];
          melds = [];
          isMenzen = true;
          activeTileArea = 'hand'; // å›åˆ°æ‰‹ç‰ŒåŒº
          render();
      }
      
      // Toastæç¤ºå‡½æ•°
      const showToast = (message, duration = 2000) => {
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (toastTimer) {
          clearTimeout(toastTimer);
        }
        
        toastMessage = message;
        toastVisible = true;
        render();
        
        // è‡ªåŠ¨éšè—
        toastTimer = setTimeout(() => {
          toastVisible = false;
          render();
        }, duration);
      };
      
      // æ¸²æŸ“Toast UI
      const renderToast = () => {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        
        if (toastVisible && toastMessage) {
          toastContainer.innerHTML = `
            <div class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 animate-fade-in">
              <div class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-2xl flex items-center gap-2 max-w-md">
                <span class="text-lg">${toastMessage}</span>
              </div>
            </div>
          `;
        } else {
          toastContainer.innerHTML = '';
        }
      };
      
      const getTileColor = (tile) => {
        const internal = displayToInternal[tile];
        if (!internal) return 'bg-gray-100 border-gray-300';
        if (internal[1] === 'm') return 'bg-red-100 border-red-300 text-red-800 hover:border-red-500 hover:bg-red-50';
        if (internal[1] === 'p') return 'bg-blue-100 border-blue-300 text-blue-800 hover:border-blue-500 hover:bg-blue-50';
        if (internal[1] === 's') return 'bg-green-100 border-green-300 text-green-800 hover:border-green-500 hover:bg-green-50';
        if (internal[1] === 'z') return 'bg-gray-100 border-gray-300 text-gray-800 hover:border-gray-500 hover:bg-gray-50';
        return 'bg-white border-gray-300';
      };

      // è®¡ç®—çº¢å®ç‰Œçš„æœ€å¤§å€¼å’Œè‡ªåŠ¨å€¼
      const calculateRedDoraInfo = () => {
        // æœ€å¤§çº¢å®ç‰Œæ•°å›ºå®šä¸º3
        const maxRedDora = 3;
        
        // è‡ªåŠ¨çº¢å®ç‰Œï¼šä¸å†è‡ªåŠ¨è®¾ç½®
        const autoRedDora = 0;
        
        return { maxRedDora, autoRedDora };
      };

      // è‡ªåŠ¨è°ƒæ•´çº¢å®ç‰Œæ•°é‡
      const autoAdjustRedDora = () => {
        const redDoraInfo = calculateRedDoraInfo();
        
        // å¦‚æœå½“å‰çº¢å®ç‰Œè¶…è¿‡æœ€å¤§å€¼ï¼Œè°ƒæ•´åˆ°æœ€å¤§å€¼
        if (redDora > redDoraInfo.maxRedDora) {
          redDora = redDoraInfo.maxRedDora;
        }
        
        // å¦‚æœæœ‰æŸç±»5è¾¾åˆ°4ä¸ªï¼Œè‡ªåŠ¨è®¾ç½®çº¢å®ç‰Œ
        if (redDoraInfo.autoRedDora > 0 && redDora < redDoraInfo.autoRedDora) {
          redDora = redDoraInfo.autoRedDora;
        }
      };

      // ====================================================================
      // 5. RENDER FUNCTIONS
      // ====================================================================

      const getDoraCounterHTML = ({ label, value, type, max = 12 }) => {
        return `
        <div class="bg-white rounded-lg border-2 border-gray-200 p-3">
          <div class="text-xs text-gray-600 mb-2 font-bold text-center">${label}</div>
          <div class="flex items-center justify-center gap-2">
            <button
              data-action="change-dora"
              data-type="${type}"
              data-amount="-1"
              class="p-2 bg-gradient-to-br from-red-100 to-red-200 rounded-lg hover:from-red-200 hover:to-red-300 transition-all shadow-sm hover:shadow-md active:scale-95"
              title="å‡å°‘"
            >
              <svg class="w-5 h-5 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M20 12H4"/>
              </svg>
            </button>
            <span class="text-2xl font-bold w-12 text-center text-blue-700">${value}</span>
            <button
              data-action="change-dora"
              data-type="${type}"
              data-amount="1"
              data-max="${max}"
              class="p-2 bg-gradient-to-br from-green-100 to-green-200 rounded-lg hover:from-green-200 hover:to-green-300 transition-all shadow-sm hover:shadow-md active:scale-95"
              title="å¢åŠ "
            >
              <svg class="w-5 h-5 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/>
              </svg>
            </button>
          </div>
        </div>
        `;
      };
      
      const getStartScreenHTML = () => {
        // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æ¸¸æˆ
        const hasSavedGame = localStorage.getItem(STORAGE_KEY) !== null;
        
        return `
          <div class="min-h-screen p-4">
            <div class="max-w-md mx-auto mt-20">
              <div class="bg-white rounded-2xl shadow-2xl p-8">
                <h1 class="text-3xl font-bold text-center mb-8 text-emerald-800">æ—¥æœ¬éº»å°†è®°å½•å™¨</h1>
                
                ${hasSavedGame ? `
                  <div class="mb-6 p-4 bg-blue-50 border-2 border-blue-300 rounded-xl">
                    <div class="flex items-center gap-2 mb-3">
                      <i data-lucide="save" class="w-5 h-5 text-blue-600"></i>
                      <h3 class="font-bold text-blue-800">å‘ç°ä¿å­˜çš„è¿›åº¦</h3>
                    </div>
                    <p class="text-sm text-blue-700 mb-3">
                      æ£€æµ‹åˆ°æœªå®Œæˆçš„å¯¹å±€ï¼Œæ‚¨å¯ä»¥ç»§ç»­ä¸Šæ¬¡çš„æ¸¸æˆæˆ–å¼€å§‹æ–°æ¸¸æˆ
                    </p>
                    <div class="flex gap-2">
                      <button
                        data-action="continue-game"
                        class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-600 transition"
                      >
                        ç»§ç»­æ¸¸æˆ
                      </button>
                      <button
                        data-action="clear-saved-game"
                        class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg font-bold hover:bg-gray-400 transition"
                      >
                        æ¸…é™¤è¿›åº¦
                      </button>
                    </div>
                  </div>
                ` : ''}
                
                <div class="space-y-4">
                  <button
                    data-action="select-game"
                    data-type="tonpuu"
                    class="w-full bg-gradient-to-r from-orange-400 to-orange-500 text-white py-4 rounded-xl font-bold text-lg hover:from-orange-500 hover:to-orange-600 transition shadow-lg"
                  >
                    ä¸œé£æˆ˜ (æ±é¢¨æˆ¦)
                  </button>
                  <button
                    data-action="select-game"
                    data-type="hanchan"
                    class="w-full bg-gradient-to-r from-blue-400 to-blue-500 text-white py-4 rounded-xl font-bold text-lg hover:from-blue-500 hover:to-blue-600 transition shadow-lg"
                  >
                    åŠåº„æˆ˜ (åŠè˜æˆ¦)
                  </button>
                  <button
                    data-action="select-game"
                    data-type="yonchan"
                    class="w-full bg-gradient-to-r from-purple-400 to-purple-500 text-white py-4 rounded-xl font-bold text-lg hover:from-purple-500 hover:to-purple-600 transition shadow-lg"
                  >
                    å…¨åº„æˆ˜ (ä¸€è˜æˆ¦)
                  </button>
                </div>
                <div class="mt-6 text-center">
                  <label class="flex items-center justify-center gap-2 text-gray-700">
                    <input
                      type="checkbox"
                      id="tobu-checkbox"
                      class="h-5 w-5 text-emerald-600"
                      checked
                    />
                    å¼€å¯å‡»é£ (åˆ†æ•°<0æ—¶ç»“æŸ)
                  </label>
                </div>
              </div>
            </div>
          </div>
        `;
      };
      
      const getGameOverScreenHTML = () => {
        return `
          <div class="min-h-screen bg-gradient-to-br from-red-50 to-gray-100 p-4">
            <div class="max-w-2xl mx-auto mt-20">
              <div class="bg-white rounded-2xl shadow-2xl p-8">
                <h1 class="text-4xl font-bold text-center mb-6 text-red-800">æ¸¸æˆç»“æŸ</h1>
                <div class="mb-6">
                  <h2 class="text-xl font-bold mb-4">æœ€ç»ˆæ’å</h2>
                  <div class="space-y-2">
                    ${[...players]
                      .sort((a, b) => b.score - a.score)
                      .map((player, idx) => `
                        <div
                          key="${player.id}"
                          class="flex items-center justify-between p-3 bg-gray-100 rounded-lg"
                        >
                          <div class="flex items-center gap-4">
                            <span class="text-2xl font-bold w-8 ${
                              idx === 0 ? 'text-yellow-500' :
                              idx === 1 ? 'text-gray-500' :
                              idx === 2 ? 'text-orange-700' : 'text-gray-400'
                            }">
                              ${idx + 1}
                            </span>
                            <span class="font-bold">${player.name} (${player.wind})</span>
                          </div>
                          <span class="text-xl font-bold text-emerald-800">
                            ${player.score.toLocaleString()}
                          </span>
                        </div>
                      `).join('')}
                  </div>
                </div>
                <div class="flex gap-2 mt-4">
                  <button
                    data-action="export-record"
                    class="flex-1 flex items-center justify-center gap-2 bg-emerald-500 text-white py-3 rounded-xl font-bold text-lg hover:bg-emerald-600 transition"
                  >
                    <i data-lucide="download"></i>
                    å¯¼å‡ºå¯¹å±€è®°å½•
                  </button>
                  <button
                    data-action="reset-game"
                    class="flex-1 bg-gradient-to-r from-emerald-500 to-green-500 text-white py-3 rounded-xl font-bold text-lg hover:from-emerald-600 hover:to-green-600 transition"
                  >
                    å†æ¥ä¸€å±€
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      };

      const getHistoryScreenHTML = () => {
        return `
          <div class="min-h-screen p-4">
            <div class="max-w-6xl mx-auto">
              <div class="bg-white rounded-2xl shadow-2xl p-6">
                <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold text-emerald-800">å¯¹å±€å†å²</h2>
                  <div class="flex gap-2">
                    <button
                      data-action="export-record"
                      class="flex items-center gap-2 px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600"
                    >
                      <i data-lucide="download"></i>
                      å¯¼å‡ºè®°å½•
                    </button>
                    <button
                      data-action="toggle-history"
                      class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                    >
                      è¿”å›
                    </button>
                  </div>
                </div>
                
                <div class="space-y-4">
                  ${roundHistory.length === 0 ? '<p class="text-gray-500">æš‚æ— å†å²è®°å½•ã€‚</p>' : ''}
                  ${roundHistory.slice().reverse().map((round, idx) => {
                    const actualIdx = roundHistory.length - 1 - idx; // å®é™…ç´¢å¼•
                    return `
                    <div key="${idx}" class="border rounded-lg p-4 bg-gray-50">
                      <div class="flex justify-between items-start mb-2">
                        <div>
                          <span class="font-bold text-lg">${round.round}</span>
                          <span class="ml-4 text-gray-600">åº„å®¶: ${round.dealer}</span>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-bold ${
                          round.type.includes('æµå±€') ? 'bg-gray-200' :
                          round.type === 'å¤šäººå’Œç‰Œ' ? 'bg-purple-200 text-purple-800' :
                          round.type === 'è‡ªæ‘¸' ? 'bg-green-200' : 'bg-blue-200'
                        }">
                          ${round.type}
                        </span>
                      </div>
                      
                      ${round.winner !== '-' ? `
                        <div>
                          ${round.isMultiWin ? `
                            <!-- å¤šäººå’Œç‰Œç‰¹æ®Šæ˜¾ç¤º -->
                            <div class="mb-3 p-3 bg-purple-50 rounded-lg border-2 border-purple-200">
                              <div class="flex items-center gap-2 mb-2">
                                <span class="text-lg font-bold text-purple-700">ğŸ‰ ${round.multiWinCount}å®¶å’Œç‰Œ</span>
                                <span class="text-sm text-gray-600">æ”¾é“³è€…: <span class="font-bold text-red-600">${round.loser}</span></span>
                              </div>
                              
                              <!-- æ¯ä¸ªå’Œç‰Œè€…çš„è¯¦ç»†ä¿¡æ¯ -->
                              <div class="space-y-2 mt-3">
                                ${round.winnersDetails.map((winner, idx) => `
                                  <div class="bg-white rounded p-2 border border-purple-200">
                                    <div class="flex items-center justify-between">
                                      <div class="flex items-center gap-2">
                                        <span class="font-bold text-emerald-700">${winner.wind} ${winner.name}</span>
                                        ${winner.isDealer ? '<span class="px-1.5 py-0.5 bg-yellow-200 text-yellow-800 rounded text-xs font-bold">åº„</span>' : ''}
                                      </div>
                                      <div class="flex items-center gap-3">
                                        <span class="text-sm text-gray-600">${winner.han}ç•ª ${winner.fu}ç¬¦</span>
                                        <span class="text-xl font-bold text-emerald-700">
                                          +${winner.score.toLocaleString()}
                                        </span>
                                      </div>
                                    </div>
                                  </div>
                                `).join('')}
                              </div>
                              
                              <!-- æ€»å¾—åˆ† -->
                              <div class="mt-3 pt-3 border-t border-purple-200 flex items-center justify-between">
                                <span class="text-sm text-gray-700">æ€»è®¡å¾—åˆ†:</span>
                                <span class="text-2xl font-bold text-purple-700">
                                  ${round.score.toLocaleString()} ç‚¹
                                </span>
                              </div>
                              
                              ${round.riichiBonus > 0 ? `
                                <div class="mt-2 text-sm text-yellow-700 font-bold flex items-center gap-2">
                                  <span>ğŸ’° ç«‹ç›´æ£’:</span>
                                  <span>+${round.riichiBonus.toLocaleString()}</span>
                                  <span class="text-xs text-gray-600">(å¹³å‡åˆ†é…)</span>
                                </div>
                              ` : ''}
                            </div>
                          ` : `
                            <!-- æ™®é€šå’Œç‰Œæ˜¾ç¤º -->
                            <div class="mb-2">
                              <span class="font-bold text-emerald-700">${round.winner}</span>
                              ${round.loser !== 'å…¨å‘˜' ? `<span class="text-gray-600"> â† ${round.loser}</span>` : ''}
                            </div>
                            <div class="flex flex-wrap gap-2 mb-2">
                               <span class="px-2 py-1 bg-emerald-100 rounded text-sm">
                                 ${round.yaku}
                               </span>
                            </div>
                            <div class="flex items-center gap-4">
                              <span class="text-gray-600">${round.han}ç•ª${round.fu}ç¬¦</span>
                              <span class="text-2xl font-bold text-emerald-700">
                                ${round.score.toLocaleString()} ç‚¹
                              </span>
                              ${round.riichiBonus > 0 ? `
                                <span class="text-sm text-yellow-700 font-bold">
                                  +${round.riichiBonus.toLocaleString()} ç«‹ç›´æ£’
                                </span>
                              ` : ''}
                            </div>
                            ${round.riichiPlayers ? `
                              <div class="text-xs text-gray-600 mt-1">
                                ç«‹ç›´ç©å®¶: ${round.riichiPlayers || 'æ— '}
                              </div>
                            ` : ''}
                          `}
                          
                          ${round.handData ? `
                            <details class="mt-3 pt-3 border-t border-gray-300">
                              <summary class="cursor-pointer text-blue-600 hover:text-blue-800 font-bold text-sm flex items-center gap-1">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                                æŸ¥çœ‹ç‰Œè°±
                              </summary>
                              <div class="mt-3 p-3 bg-white rounded-lg border border-blue-200">
                                ${round.handData.tiles && round.handData.tiles.length > 0 ? `
                                  <div class="mb-2">
                                    <span class="font-bold text-xs text-gray-700">æ‰‹ç‰Œï¼š</span>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                      ${round.handData.tiles.map(tile => `
                                        <span class="border-2 rounded px-2 py-1 text-sm font-bold bg-gray-50">${tile}</span>
                                      `).join('')}
                                    </div>
                                  </div>
                                ` : ''}
                                
                                ${round.handData.melds && round.handData.melds.length > 0 ? `
                                  <div class="mb-2">
                                    <span class="font-bold text-xs text-gray-700">å‰¯éœ²ï¼š</span>
                                    <div class="flex flex-wrap gap-2 mt-1">
                                      ${round.handData.melds.map(meld => {
                                        const typeNames = { 'shuntsu': 'é¡ºå­', 'pon': 'ç¢°', 'minkan': 'æ˜æ ', 'ankan': 'æš—æ ' };
                                        const typeColors = { 'shuntsu': 'bg-blue-100 border-blue-300', 'pon': 'bg-green-100 border-green-300', 'minkan': 'bg-red-100 border-red-300', 'ankan': 'bg-purple-100 border-purple-300' };
                                        return `
                                          <div class="border-2 rounded p-2 ${typeColors[meld.type]}">
                                            <div class="text-xs font-bold text-gray-600 mb-1">${typeNames[meld.type]}</div>
                                            <div class="flex gap-1">
                                              ${meld.tiles.map(tile => `
                                                <span class="px-1.5 py-0.5 text-sm font-bold bg-white rounded">${tile}</span>
                                              `).join('')}
                                            </div>
                                          </div>
                                        `;
                                      }).join('')}
                                    </div>
                                  </div>
                                ` : ''}
                                
                                ${round.handData.winTile ? `
                                  <div class="mb-2">
                                    <span class="font-bold text-xs text-gray-700">å’Œç‰Œï¼š</span>
                                    <span class="ml-2 border-2 border-emerald-400 bg-emerald-100 rounded px-3 py-1 text-lg font-bold">${round.handData.winTile}</span>
                                  </div>
                                ` : ''}
                                
                                <div class="mb-2">
                                  <span class="font-bold text-xs text-gray-700">çŠ¶å†µï¼š</span>
                                  <div class="flex flex-wrap gap-1 mt-1">
                                    ${round.handData.isMenzen ? '<span class="px-2 py-0.5 bg-teal-100 text-teal-800 rounded text-xs font-bold">é—¨å‰æ¸…</span>' : ''}
                                    ${round.handData.isRiichi ? '<span class="px-2 py-0.5 bg-purple-100 text-purple-800 rounded text-xs font-bold">ç«‹ç›´</span>' : ''}
                                    ${round.handData.isDoubleRiichi ? '<span class="px-2 py-0.5 bg-purple-200 text-purple-900 rounded text-xs font-bold">äºŒç«‹ç›´</span>' : ''}
                                    ${round.handData.isIppatsu ? '<span class="px-2 py-0.5 bg-purple-100 text-purple-800 rounded text-xs font-bold">ä¸€å‘</span>' : ''}
                                    ${round.handData.isTenhou ? '<span class="px-2 py-0.5 bg-yellow-200 text-yellow-900 rounded text-xs font-bold">å¤©å’Œ</span>' : ''}
                                    ${round.handData.isChiihou ? '<span class="px-2 py-0.5 bg-yellow-200 text-yellow-900 rounded text-xs font-bold">åœ°å’Œ</span>' : ''}
                                    ${round.handData.isRenhou ? '<span class="px-2 py-0.5 bg-yellow-200 text-yellow-900 rounded text-xs font-bold">äººå’Œ</span>' : ''}
                                    ${round.handData.isHaitei ? '<span class="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs font-bold">æµ·åº•</span>' : ''}
                                    ${round.handData.isHoutei ? '<span class="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs font-bold">æ²³åº•</span>' : ''}
                                    ${round.handData.isRinshan ? '<span class="px-2 py-0.5 bg-green-100 text-green-800 rounded text-xs font-bold">å²­ä¸Š</span>' : ''}
                                    ${round.handData.isChankan ? '<span class="px-2 py-0.5 bg-red-100 text-red-800 rounded text-xs font-bold">æŠ¢æ </span>' : ''}
                                  </div>
                                </div>
                                
                                <div>
                                  <span class="font-bold text-xs text-gray-700">å®ç‰Œï¼š</span>
                                  <span class="ml-2 text-sm">å®${round.handData.dora || 0} + é‡Œ${round.handData.uraDora || 0} + èµ¤${round.handData.redDora || 0}</span>
                                </div>
                              </div>
                            </details>
                          ` : ''}
                        </div>
                      ` : `
                         <p class="text-sm text-gray-700">${round.yaku}</p>
                      `}
                      
                      ${round.scoreChanges ? `
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs mt-2 pt-2 border-t">
                          ${players.map((p, i) => `
                            <div>
                              <span class="font-bold">${p.name}:</span>
                              <span class="${round.scoreChanges[i] > 0 ? 'text-green-600' : (round.scoreChanges[i] < 0 ? 'text-red-600' : 'text-gray-600')} font-bold">
                                ${round.scoreChanges[i] > 0 ? '+' : ''}${round.scoreChanges[i].toLocaleString()}
                              </span>
                            </div>
                          `).join('')}
                        </div>
                      ` : ''}
                    </div>
                  `}).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      };

      // ç¼“å­˜ä¸Šæ¬¡çš„å¬ç‰Œåˆ†æç»“æœ
      let cachedTenpaiState = null;
      let cachedTenpaiWaits = [];
      
      const getMainGameHTML = () => {
        // æ€§èƒ½ä¼˜åŒ–ï¼šåªåœ¨ç›¸å…³çŠ¶æ€å˜åŒ–æ—¶æ‰é‡æ–°è®¡ç®—å¬ç‰Œ
        const currentTenpaiState = JSON.stringify({
          tiles: selectedTiles,
          melds: melds,
          winnerIndex: winnerIndex,
          isTsumo: isTsumo,
          isRiichi: isRiichi,
          isDoubleRiichi: isDoubleRiichi,
          dora: dora,
          redDora: redDora
        });
        
        if (currentTenpaiState !== cachedTenpaiState) {
          updateDetailedTenpaiWaits();
          cachedTenpaiState = currentTenpaiState;
          cachedTenpaiWaits = [...tenpaiWaits];
        } else {
          tenpaiWaits = cachedTenpaiWaits;
        }
        
        const currentAnalysis = getCurrentAnalysis();
        const scoreData = currentAnalysis ? calculateScore(currentAnalysis.han, currentAnalysis.fu, winnerIndex === currentDealerIndex, gameState.honba) : null;
        
        // è®¡ç®—åˆ†æ•°å˜åŒ– (getScoreDistribution å·²åŒ…å«ç«‹ç›´æ£’)
        let scoreChanges = [0, 0, 0, 0];
        if (currentAnalysis) {
          scoreChanges = getScoreDistribution(currentAnalysis, scoreData);
        }
        
        return `
          <div class="min-h-screen p-4">
            <div class="max-w-7xl mx-auto">
              <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                  <div>
                    <h1 class="text-2xl font-bold text-emerald-800">
                      ${gameSettings.type === 'tonpuu' ? 'ä¸œé£æˆ˜' : gameSettings.type === 'hanchan' ? 'åŠåº„æˆ˜' : 'å…¨åº„æˆ˜'}
                    </h1>
                    <p class="text-lg text-gray-600 font-bold">
                      ${`${roundWindDisplay[gameState.wind]} ${gameState.round} å±€ / ${gameState.honba} æœ¬åœº`}
                      <span class="ml-4"> ( ${gameState.riichiSticks} ç«‹ç›´æ£’ )</span>
                    </p>
                    <p class="text-xs text-green-600 mt-1 flex items-center gap-1">
                      <i data-lucide="save" class="w-3 h-3"></i>
                      è‡ªåŠ¨ä¿å­˜å·²å¼€å¯
                    </p>
                  </div>
                  <div class="flex gap-2">
                    <button
                      data-action="toggle-history"
                      class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                    >
                      <i data-lucide="history"></i>
                      å†å²
                    </button>
                    <button
                      data-action="reset-game"
                      class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600"
                    >
                      <i data-lucide="rotate-ccw"></i>
                      é‡ç½®
                    </button>
                  </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                  ${players.map((player, idx) => `
                    <div
                      key="${player.id}"
                      class="${
                        idx === currentDealerIndex
                          ? 'bg-gradient-to-br from-yellow-100 to-yellow-200 border-2 border-yellow-400'
                          : 'bg-gray-50'
                      } p-4 rounded-xl"
                    >
                      <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-lg">${player.wind}</span>
                        <div class="flex gap-1">
                          ${player.isRiichi ? `
                            <span class="px-2 py-1 bg-yellow-500 text-white text-xs rounded-full font-bold">
                              ç«‹ç›´
                            </span>
                          ` : ''}
                          ${idx === currentDealerIndex ? `
                            <span class="px-2 py-1 bg-yellow-400 text-white text-xs rounded-full font-bold">
                              åº„å®¶
                            </span>
                          ` : ''}
                        </div>
                      </div>
                      <input
                        type="text"
                        id="player-name-${idx}"
                        value="${player.name}"
                        class="w-full mb-2 px-2 py-1 border rounded"
                      />
                      <div class="text-2xl font-bold text-emerald-700">
                        ${player.score.toLocaleString()}
                      </div>
                    </div>
                  `).join('')}
                </div>

                ${!showScoreInput && !showDrawDialog ? `
                  <div class="border-t pt-4">
                    <h3 class="text-xl font-bold mb-4">é€‰æ‹©æœ¬å±€ç»“æœ</h3>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                      <button
                        data-action="select-round-type"
                        data-type="single-win"
                        class="py-4 bg-gradient-to-r from-emerald-400 to-emerald-500 text-white rounded-xl font-bold text-lg hover:from-emerald-500 hover:to-emerald-600 transition shadow-lg"
                      >
                        å•äººå’Œç‰Œ
                      </button>
                      <button
                        data-action="select-round-type"
                        data-type="multi-win"
                        class="py-4 bg-gradient-to-r from-blue-400 to-blue-500 text-white rounded-xl font-bold text-lg hover:from-blue-500 hover:to-blue-600 transition shadow-lg"
                      >
                        å¤šäººå’Œç‰Œ
                      </button>
                      <button
                        data-action="select-round-type"
                        data-type="draw"
                        class="py-4 bg-gradient-to-r from-gray-400 to-gray-500 text-white rounded-xl font-bold text-lg hover:from-gray-500 hover:to-gray-600 transition shadow-lg col-span-2"
                      >
                        æµå±€
                      </button>
                    </div>
                  </div>
                ` : ''}

                ${showDrawDialog ? `
                  <div class="border-t pt-4">
                    <h3 class="text-xl font-bold mb-4">æµå±€å¤„ç†</h3>
                    
                    <div class="mb-6">
                      <p class="mb-2 text-gray-600 font-semibold">æµå±€ç±»å‹</p>
                      <div class="flex gap-2 mb-4">
                        <button
                          data-action="toggle-draw-type"
                          data-type="normal"
                          class="flex-1 py-3 rounded-lg font-bold ${
                            !isStartingHandDraw 
                              ? 'bg-blue-500 text-white' 
                              : 'bg-gray-200 text-gray-700'
                          }"
                        >
                          æ™®é€šæµå±€
                        </button>
                        <button
                          data-action="toggle-draw-type"
                          data-type="starting"
                          class="flex-1 py-3 rounded-lg font-bold ${
                            isStartingHandDraw 
                              ? 'bg-orange-500 text-white' 
                              : 'bg-gray-200 text-gray-700'
                          }"
                        >
                          å¼€å±€æµå±€
                        </button>
                      </div>
                      ${isStartingHandDraw ? `
                        <div class="p-3 bg-orange-50 border-2 border-orange-200 rounded-lg mb-4">
                          <p class="text-sm text-orange-800">
                            <strong>ğŸ“¢ å¼€å±€æµå±€è¯´æ˜ï¼š</strong><br/>
                            â€¢ å››é£è¿æ‰“ã€ä¹ç§ä¹ç‰Œçš„å¼€å±€è’ç‰Œ<br/>
                            â€¢ æ‰€æœ‰ç©å®¶ç‚¹æ•°ä¸å˜<br/>
                            â€¢ åº„å®¶è¿åº„ï¼Œæœ¬åœºæ•°+1<br/>
                          </p>
                        </div>
                      ` : `
                        <p class="mb-4 text-sm text-gray-500">ï¼ˆå¬ç‰Œè€…ä»æœªå¬ç‰Œè€…è·å¾—ç‚¹æ•°ï¼Œåº„å®¶å¬ç‰Œåˆ™è¿åº„ï¼‰</p>
                      `}
                    </div>

                    ${!isStartingHandDraw ? `
                    <!-- æµå±€æ»¡è´¯é€‰é¡¹ï¼ˆé»˜è®¤æŠ˜å ï¼‰ -->
                    <div class="mb-6">
                      <button
                        data-action="toggle-nagashi-mangan"
                        class="w-full flex justify-between items-center py-2 px-3 rounded-lg font-bold transition-all bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 hover:border-yellow-400"
                      >
                        <span class="text-sm font-bold text-yellow-800">
                          ${showNagashiMangan ? 'ğŸ”½' : 'â–¶ï¸'} æµå±€æ»¡è´¯
                          ${nagashiManganPlayers.length > 0 ? ` (${nagashiManganPlayers.map(i => players[i].wind).join('ã€')})` : ''}
                        </span>
                        <span class="text-xs text-yellow-600">${showNagashiMangan ? 'æ”¶èµ·' : 'å±•å¼€'}</span>
                      </button>
                      
                      ${showNagashiMangan ? `
                        <div class="mt-3 p-3 bg-yellow-50 border-2 border-yellow-200 rounded-lg">
                          <p class="text-xs text-yellow-800 mb-3">
                            <strong>ğŸ“¢ æµå±€æ»¡è´¯è¯´æ˜ï¼š</strong><br/>
                            â€¢ æµå±€æ—¶ï¼ŒæŸç©å®¶æ‰€æœ‰èˆç‰Œå‡ä¸ºå¹ºä¹ç‰Œä¸”æœªè¢«é¸£ç‰Œ<br/>
                            â€¢ è§†ä¸ºæ»¡è´¯ï¼ˆè‡ªæ‘¸ï¼‰ï¼Œä»å…¶ä»–ä¸‰å®¶å„è·å¾—ç‚¹æ•°<br/>
                            â€¢ å¤šäººå¯åŒæ—¶è¾¾æˆæµå±€æ»¡è´¯
                          </p>
                          
                          <p class="mb-2 text-yellow-700 font-semibold text-sm">é€‰æ‹©è¾¾æˆæµå±€æ»¡è´¯çš„ç©å®¶ï¼š</p>
                          <div class="grid grid-cols-4 gap-2">
                            ${players.map((player, idx) => `
                              <button
                                data-action="toggle-nagashi-mangan-player"
                                data-index="${idx}"
                                class="py-3 rounded-lg font-bold transition-all ${
                                  nagashiManganPlayers.includes(idx)
                                    ? 'bg-yellow-500 text-white shadow-lg'
                                    : 'bg-white text-yellow-700 border-2 border-yellow-300 hover:bg-yellow-50'
                                }"
                              >
                                ${player.wind}<br/>
                                <span class="text-xs">${nagashiManganPlayers.includes(idx) ? 'âœ“ æ»¡è´¯' : 'æœªè¾¾æˆ'}</span>
                              </button>
                            `).join('')}
                          </div>
                          
                          ${nagashiManganPlayers.length > 0 ? `
                            <div class="mt-3 p-2 bg-yellow-100 border border-yellow-300 rounded">
                              <p class="text-xs text-yellow-800 font-bold">
                                ğŸ’° ç‚¹æ•°é¢„è§ˆï¼š
                              </p>
                              ${nagashiManganPlayers.map(idx => {
                                const isDealer = idx === currentDealerIndex;
                                const eachPay = isDealer ? 4000 : 2000;
                                const dealerPay = isDealer ? 4000 : 4000;
                                const total = isDealer ? 12000 : 8000;
                                
                                return `
                                  <div class="text-xs text-yellow-700 mt-1">
                                    <strong>${players[idx].wind}</strong>: 
                                    ${isDealer 
                                      ? `å„å®¶æ”¯ä»˜ ${eachPay}ç‚¹ï¼Œå…±è·å¾— <strong class="text-yellow-900">${total}ç‚¹</strong>` 
                                      : `åº„å®¶æ”¯ä»˜ ${dealerPay}ç‚¹ï¼Œé—²å®¶å„æ”¯ä»˜ ${eachPay}ç‚¹ï¼Œå…±è·å¾— <strong class="text-yellow-900">${total}ç‚¹</strong>`
                                    }
                                  </div>
                                `;
                              }).join('')}
                            </div>
                          ` : ''}
                        </div>
                      ` : ''}
                    </div>
                    ` : ''}

                    ${!isStartingHandDraw ? `
                    <div class="mb-6">
                      <p class="mb-2 text-gray-600 font-semibold">é€‰æ‹©å¬ç‰Œçš„ç©å®¶</p>
                      
                      <div class="grid grid-cols-4 gap-2">
                        ${players.map((player, idx) => `
                          <button
                            key="${idx}"
                            data-action="toggle-tenpai"
                            data-index="${idx}"
                            class="py-3 rounded-lg font-bold ${
                              tenpaiedPlayers.includes(idx)
                                ? 'bg-green-500 text-white'
                                : 'bg-gray-200 text-gray-700'
                            }"
                          >
                            ${player.wind}<br/>
                            <span class="text-xs">${tenpaiedPlayers.includes(idx) ? 'å¬ç‰Œ' : 'æœªå¬'}</span>
                          </button>
                        `).join('')}
                      </div>
                    </div>
                    ` : ''}

                    ${!isStartingHandDraw && tenpaiedPlayers.length > 0 ? `
                      <div class="mb-6">
                        <p class="mb-2 text-gray-600 font-semibold">é€‰æ‹©ç«‹ç›´çš„ç©å®¶ï¼ˆä»…å¬ç‰Œç©å®¶å¯ç«‹ç›´ï¼‰</p>
                        <p class="mb-4 text-sm text-gray-500">ï¼ˆç«‹ç›´ç©å®¶éœ€äº¤å‡º1000ç‚¹ç«‹ç›´æ£’ï¼‰</p>
                        
                        <div class="grid grid-cols-4 gap-2">
                          ${players.map((player, idx) => {
                            const isTenpai = tenpaiedPlayers.includes(idx);
                            const isAlreadyRiichi = player.isRiichi;
                            const isDrawRiichi = drawRiichiPlayers.includes(idx);
                            const canSelect = isTenpai && !isAlreadyRiichi;
                            
                            return `
                              <button
                                key="riichi-${idx}"
                                data-action="toggle-draw-riichi"
                                data-index="${idx}"
                                class="py-3 rounded-lg font-bold ${
                                  isAlreadyRiichi
                                    ? 'bg-orange-300 text-gray-700 cursor-not-allowed'
                                    : isDrawRiichi
                                    ? 'bg-red-500 text-white'
                                    : isTenpai
                                    ? 'bg-gray-200 text-gray-700'
                                    : 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                }"
                                ${!canSelect ? 'disabled' : ''}
                              >
                                ${player.wind}<br/>
                                <span class="text-xs">
                                  ${isAlreadyRiichi ? 'å·²ç«‹ç›´' : isDrawRiichi ? 'ç«‹ç›´' : isTenpai ? 'å¯ç«‹ç›´' : '-'}
                                </span>
                              </button>
                            `;
                          }).join('')}
                        </div>
                      </div>
                    ` : ''}

                    <div class="flex gap-2">
                      <button
                        data-action="cancel-draw"
                        class="flex-1 py-3 bg-gray-300 rounded-xl font-bold hover:bg-gray-400"
                      >
                        å–æ¶ˆ
                      </button>
                      <button
                        data-action="confirm-draw"
                        class="flex-1 py-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600"
                      >
                        ç¡®è®¤æµå±€
                      </button>
                    </div>
                  </div>
                ` : ''}

                ${showScoreInput ? `
                  <div class="border-t pt-4">
                    ${multiWinType ? `
                      <div class="bg-blue-50 p-3 rounded-lg border-2 border-blue-200">
                        <p class="text-xs text-blue-700 mb-3">âš¡ å¤šäººå’Œç‰Œï¼šå¤šäººè£å’ŒåŒä¸€å¼ ç‰Œï¼Œé€‰æ‹©å’Œç‰Œè€…ã€æ”¾é“³è€…å’Œç•ªç¬¦ï¼Œç¨‹åºå°†è‡ªåŠ¨è®¡ç®—ç‚¹æ•°</p>
                        
                        <!-- 1. é€‰æ‹©å’Œç‰Œè€… -->
                        <div class="mb-3">
                          <label class="block text-xs font-bold text-blue-800 mb-2">å’Œç‰Œè€…ï¼ˆå¯å¤šé€‰ï¼Œè‡³å¤š3äººï¼‰</label>
                          <div class="grid grid-cols-2 gap-2">
                            ${players.map((player, idx) => `
                              <button
                                data-action="toggle-multi-winner"
                                data-index="${idx}"
                                class="py-2 px-3 rounded-lg font-bold ${
                                  multiWinners.includes(idx)
                                    ? 'bg-blue-500 text-white'
                                    : 'bg-gray-100 hover:bg-gray-200'
                                }"
                              >
                                ${player.wind} ${player.name}
                              </button>
                            `).join('')}
                          </div>
                        </div>
                        
                        <!-- 2. é€‰æ‹©æ”¾é“³è€… -->
                        ${multiWinners.length > 0 ? `
                          <div class="mb-3">
                            <label class="block text-xs font-bold text-blue-800 mb-2">æ”¾é“³è€…</label>
                            <div class="grid grid-cols-2 gap-2">
                              ${players.map((player, idx) => {
                                if (multiWinners.includes(idx)) return ''; // å’Œç‰Œè€…ä¸èƒ½æ˜¯æ”¾é“³è€…
                                return `
                                  <button
                                    data-action="set-multi-loser"
                                    data-index="${idx}"
                                    class="py-2 px-3 rounded-lg font-bold ${
                                      multiWinLoser === idx
                                        ? 'bg-red-500 text-white'
                                        : 'bg-gray-100 hover:bg-gray-200'
                                    }"
                                  >
                                    ${player.wind} ${player.name}
                                  </button>
                                `;
                              }).join('')}
                            </div>
                          </div>
                        ` : ''}
                        
                        <!-- 3. ä¸ºæ¯ä¸ªå’Œç‰Œè€…è®¾ç½®ç•ªæ•°å’Œç¬¦æ•° -->
                        ${multiWinners.length > 0 ? `
                          <div class="space-y-3">
                            ${multiWinners.map(winnerIdx => {
                              const player = players[winnerIdx];
                              const data = multiWinHanFu[winnerIdx] || { han: 1, fu: 30 };
                              return `
                                <div class="bg-white p-3 rounded-lg border-2 border-blue-300">
                                  <p class="text-xs font-bold text-blue-800 mb-2">${player.wind} ${player.name} çš„ç•ªæ•°ç¬¦æ•°</p>
                                  
                                  <div class="grid grid-cols-2 gap-2">
                                    <div>
                                      <label class="block text-xs font-bold text-blue-700 mb-1">ç•ªæ•°</label>
                                      <div class="grid grid-cols-4 gap-1">
                                        ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 26].map(han => `
                                          <button
                                            data-action="set-multi-winner-han"
                                            data-winner="${winnerIdx}"
                                            data-han="${han}"
                                            class="py-1 text-xs rounded font-bold ${
                                              data.han === han ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200'
                                            }"
                                          >${han}</button>
                                        `).join('')}
                                      </div>
                                      <input
                                        type="number"
                                        data-action="input-multi-winner-han"
                                        data-winner="${winnerIdx}"
                                        value="${data.han}"
                                        min="1"
                                        max="99"
                                        class="w-full mt-1 px-2 py-1 border-2 border-blue-300 rounded text-center text-xs font-bold"
                                      />
                                    </div>
                                    
                                    <div>
                                      <label class="block text-xs font-bold text-blue-700 mb-1">ç¬¦æ•°</label>
                                      <div class="grid grid-cols-3 gap-1">
                                        ${[20, 25, 30, 40, 50, 60, 70, 80, 90, 100, 110].map(fu => `
                                          <button
                                            data-action="set-multi-winner-fu"
                                            data-winner="${winnerIdx}"
                                            data-fu="${fu}"
                                            class="py-1 text-xs rounded font-bold ${
                                              data.fu === fu ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200'
                                            }"
                                          >${fu}</button>
                                        `).join('')}
                                      </div>
                                      <input
                                        type="number"
                                        data-action="input-multi-winner-fu"
                                        data-winner="${winnerIdx}"
                                        value="${data.fu}"
                                        min="20"
                                        max="110"
                                        step="10"
                                        class="w-full mt-1 px-2 py-1 border-2 border-blue-300 rounded text-center text-xs font-bold"
                                      />
                                    </div>
                                  </div>
                                  
                                  <p class="text-xs text-blue-600 mt-2">
                                    ${data.han}ç•ª ${data.fu}ç¬¦
                                    ${getYakumanLevelName(data.han)}
                                  </p>
                                  
                                  <!-- å•ä¸ªå’Œç‰Œè€…çš„ç‚¹æ•°é¢„è§ˆ -->
                                  ${multiWinLoser !== null ? (() => {
                                    const { han, fu } = data;
                                    const isDealer = winnerIdx === currentDealerIndex;
                                    const scoreData = calculateScore(han, fu, false, isDealer); // å¤šäººå’Œç‰Œæ€»æ˜¯è£å’Œ
                                    
                                    if (!scoreData) return '';
                                    
                                    const points = scoreData.total;
                                    return `
                                      <div class="mt-2 p-2 bg-blue-50 rounded">
                                        <p class="text-xs text-gray-600">ç‚¹æ•°é¢„è§ˆ:</p>
                                        <p class="text-sm font-bold text-green-600">
                                          ${players[winnerIdx].wind}: +${points}
                                        </p>
                                        <p class="text-sm font-bold text-red-600">
                                          ${players[multiWinLoser].wind}: -${points}
                                        </p>
                                      </div>
                                    `;
                                  })() : ''}
                                </div>
                              `;
                            }).join('')}
                          </div>
                        ` : ''}
                        
                        <!-- 4. æ€»åˆ†æ•°é¢„è§ˆ -->
                        ${multiWinners.length > 0 && multiWinLoser !== null ? `
                          <div class="mt-3 pt-3 border-t border-blue-200">
                            <p class="text-xs text-blue-600 mb-2">ğŸ’¡ æ€»åˆ†æ•°å˜åŒ–é¢„è§ˆ:</p>
                            ${(() => {
                              const previewScores = calculateMultiWinScores();
                              return `
                                <div class="grid grid-cols-4 gap-2 mb-2">
                                  ${players.map((player, idx) => `
                                    <div class="text-center">
                                      <div class="text-xs text-gray-600">${player.wind}</div>
                                      <div class="font-bold text-sm ${previewScores[idx] > 0 ? 'text-green-600' : previewScores[idx] < 0 ? 'text-red-600' : 'text-gray-400'}">
                                        ${previewScores[idx] > 0 ? '+' : ''}${previewScores[idx]}
                                      </div>
                                    </div>
                                  `).join('')}
                                </div>
                                <p class="text-xs ${previewScores.reduce((a, b) => a + b, 0) === 0 ? 'text-green-600' : 'text-red-600'}">
                                  æ€»è®¡: ${previewScores.reduce((a, b) => a + b, 0)} 
                                  ${previewScores.reduce((a, b) => a + b, 0) === 0 ? 'âœ…' : 'âš ï¸ åº”ä¸º0'}
                                </p>
                              `;
                            })()}
                          </div>
                        ` : ''}
                        
                        <div class="mt-3 flex gap-2">
                          <button
                            data-action="cancel-scorer"
                            class="flex-1 py-3 bg-gray-300 rounded-xl font-bold hover:bg-gray-400 transition"
                          >
                            å–æ¶ˆ
                          </button>
                          <button
                            data-action="confirm-multi-win"
                            class="flex-1 py-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition"
                          >
                            ç¡®è®¤ç»“ç®—
                          </button>
                        </div>
                      </div>
                    ` : `
                    <h3 class="text-xl font-bold mb-4">å’Œç‰Œç»“ç®—</h3>
                    
                    <div class="mb-4">
                      <label class="block text-sm font-bold mb-2">å’Œç‰Œç±»å‹</label>
                      <div class="flex gap-2">
                        <button
                          data-action="set-tsumo"
                          data-value="true"
                          class="flex-1 py-2 rounded-lg font-bold ${isTsumo ? 'bg-emerald-500 text-white' : 'bg-gray-200'}"
                        >
                          è‡ªæ‘¸ (ãƒ„ãƒ¢)
                        </button>
                        <button
                          data-action="set-tsumo"
                          data-value="false"
                          class="flex-1 py-2 rounded-lg font-bold ${!isTsumo ? 'bg-emerald-500 text-white' : 'bg-gray-200'}"
                        >
                          è£å’Œ (ãƒ­ãƒ³)
                        </button>
                      </div>
                    </div>

                    <div class="mb-4">
                      <label class="block text-sm font-bold mb-2">å’Œç‰Œè€…</label>
                      <div class="grid grid-cols-4 gap-2">
                        ${players.map((player, idx) => `
                          <button
                            key="${idx}"
                            data-action="set-winner"
                            data-index="${idx}"
                            class="py-2 rounded-lg font-bold ${winnerIndex === idx ? 'bg-blue-500 text-white' : 'bg-gray-200'}"
                          >
                            ${player.wind}
                          </button>
                        `).join('')}
                      </div>
                    </div>

                    ${!isTsumo ? `
                      <div class="mb-4">
                        <label class="block text-sm font-bold mb-2">æ”¾é“³è€…</label>
                        <div class="grid grid-cols-4 gap-2">
                          ${players.map((player, idx) => `
                            <button
                              key="${idx}"
                              data-action="set-loser"
                              data-index="${idx}"
                              ${idx === winnerIndex ? 'disabled' : ''}
                              class="py-2 rounded-lg font-bold ${
                                loserIndex === idx ? 'bg-red-500 text-white' :
                                idx === winnerIndex ? 'bg-gray-100 text-gray-400 cursor-not-allowed' :
                                'bg-gray-200'
                              }"
                            >
                              ${player.wind}
                            </button>
                          `).join('')}
                        </div>
                      </div>
                    ` : ''}
                    
                    <div class="mb-4">
                      <label class="block text-sm font-bold mb-2">
                        ç«‹ç›´ç©å®¶ (å’Œç‰Œå‰æ‰£é™¤1000ç‚¹ï¼Œå’Œç‰Œè€…è·å¾—æ‰€æœ‰ç«‹ç›´æ£’)
                        ${winnerIndex !== null && hasMinimalFuro() ? '<span class="text-red-600 text-xs">ï¼ˆå’Œç‰Œè€…æœ‰æ˜å‰¯éœ²ï¼Œä¸å¯ç«‹ç›´ï¼‰</span>' : ''}
                      </label>
                      <div class="grid grid-cols-4 gap-2">
                        ${players.map((player, idx) => {
                          // åªæœ‰å’Œç‰Œè€…æœ‰æ˜å‰¯éœ²æ—¶ï¼Œæ‰ç¦ç”¨å’Œç‰Œè€…çš„ç«‹ç›´æŒ‰é’®
                          const isWinner = idx === winnerIndex;
                          const hasMinFuro = hasMinimalFuro();
                          const isDisabled = isWinner && hasMinFuro;
                          return `
                          <button
                            key="${idx}"
                            data-action="toggle-player-riichi"
                            data-index="${idx}"
                            ${isDisabled ? 'disabled' : ''}
                            class="py-2 rounded-lg font-bold ${player.isRiichi ? 'bg-yellow-500 text-white' : 'bg-gray-200'} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}"
                          >
                            ${player.wind}${player.isRiichi ? ' ç«‹' : ''}${isDisabled ? ' (å‰¯éœ²)' : ''}
                          </button>
                        `}).join('')}
                      </div>
                    </div>

                    <div class="mb-4">
                      <label class="block text-sm font-bold mb-2">å½¹ç§åˆ†ææ¨¡å¼</label>
                      <div class="flex gap-2 mb-2">
                        <button
                          data-action="toggle-analysis-mode"
                          data-mode="auto"
                          class="flex-1 py-2 rounded-lg font-bold ${!isManualMode && !isExpertMode ? 'bg-blue-500 text-white' : 'bg-gray-200'}"
                        >
                          ğŸ¤– è‡ªåŠ¨åˆ†æ
                        </button>
                        <button
                          data-action="toggle-analysis-mode"
                          data-mode="manual"
                          class="flex-1 py-2 rounded-lg font-bold ${isManualMode && !isExpertMode ? 'bg-purple-500 text-white' : 'bg-gray-200'}"
                        >
                          âœ‹ æ‰‹åŠ¨é€‰æ‹©
                        </button>
                        <button
                          data-action="toggle-analysis-mode"
                          data-mode="expert"
                          class="flex-1 py-2 rounded-lg font-bold ${isExpertMode ? 'bg-orange-500 text-white' : 'bg-gray-200'}"
                        >
                          âš¡ è€æ‰‹æ¨¡å¼
                        </button>
                      </div>
                      ${isExpertMode ? `
                        <div class="bg-orange-50 p-3 rounded-lg border-2 border-orange-200">
                          <p class="text-xs text-orange-700 mb-3">âš¡ è€æ‰‹æ¨¡å¼ï¼šç›´æ¥è¾“å…¥ç•ªæ•°å’Œç¬¦æ•°ï¼Œæé€Ÿè®°å½•</p>
                          
                          <div class="grid grid-cols-2 gap-3">
                            <div>
                              <label class="block text-xs font-bold text-orange-800 mb-2">ç•ªæ•°</label>
                              <div class="grid grid-cols-4 gap-1">
                                ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 26, 39, 52].map(han => `
                                  <button
                                    data-action="set-expert-han"
                                    data-han="${han}"
                                    class="py-2 text-sm rounded font-bold ${
                                      expertHan === han 
                                        ? 'bg-orange-500 text-white' 
                                        : 'bg-gray-100 hover:bg-gray-200'
                                    }"
                                  >
                                    ${han}ç•ª
                                  </button>
                                `).join('')}
                              </div>
                              <div class="mt-2 text-center">
                                <input
                                  type="number"
                                  data-action="input-expert-han"
                                  value="${expertHan}"
                                  min="1"
                                  max="130"
                                  class="w-full px-3 py-2 border-2 border-orange-300 rounded-lg text-center font-bold"
                                  placeholder="è‡ªå®šä¹‰ç•ªæ•°ï¼ˆæœ€é«˜130ï¼‰"
                                />
                              </div>
                            </div>
                            
                            <div>
                              <label class="block text-xs font-bold text-orange-800 mb-2">ç¬¦æ•°</label>
                              <div class="grid grid-cols-3 gap-1">
                                ${[20, 25, 30, 40, 50, 60, 70, 80, 90, 100, 110].map(fu => `
                                  <button
                                    data-action="set-expert-fu"
                                    data-fu="${fu}"
                                    class="py-2 text-sm rounded font-bold ${
                                      expertFu === fu 
                                        ? 'bg-orange-500 text-white' 
                                        : 'bg-gray-100 hover:bg-gray-200'
                                    }"
                                  >
                                    ${fu}ç¬¦
                                  </button>
                                `).join('')}
                              </div>
                              <div class="mt-2 text-center">
                                <input
                                  type="number"
                                  data-action="input-expert-fu"
                                  value="${expertFu}"
                                  min="20"
                                  max="110"
                                  step="10"
                                  class="w-full px-3 py-2 border-2 border-orange-300 rounded-lg text-center font-bold"
                                  placeholder="è‡ªå®šä¹‰ç¬¦æ•°"
                                />
                              </div>
                            </div>
                          </div>
                          
                          <div class="mt-3 pt-3 border-t border-orange-200">
                            <p class="text-xs text-orange-600">
                              ğŸ’¡ å½“å‰è®¾ç½®ï¼š<span class="font-bold">${expertHan}ç•ª ${expertFu}ç¬¦</span>
                              ${getYakumanLevelName(expertHan)}
                            </p>
                          </div>
                        </div>
                      ` : isManualMode ? `
                        <div class="bg-purple-50 p-3 rounded-lg border-2 border-purple-200">
                          <p class="text-xs text-purple-700 mb-2">ğŸ’¡ æ‰‹åŠ¨æ¨¡å¼ï¼šé€‰æ‹©æ‚¨çš„å½¹ç§ï¼Œç¨‹åºå°†éªŒè¯å†²çªå¹¶è®¡ç®—ç‚¹æ•°</p>
                          <div class="mb-3">
                            <p class="text-xs font-bold text-purple-800 mb-1">å·²é€‰å½¹ç§ (${manualYaku.length}):</p>
                            <div class="bg-white p-2 rounded min-h-[40px]">
                              ${manualYaku.length > 0 ? `
                                <div class="flex flex-wrap gap-1">
                                  ${manualYaku.map(yakuId => {
                                    const yaku = allYakuList.find(y => y.id === yakuId);
                                    return `
                                      <span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-bold">
                                        ${yaku?.name}
                                        <button
                                          data-action="remove-manual-yaku"
                                          data-yaku-id="${yakuId}"
                                          class="text-purple-600 hover:text-purple-900"
                                        >Ã—</button>
                                      </span>
                                    `;
                                  }).join('')}
                                </div>
                              ` : '<span class="text-gray-400 text-xs">æœªé€‰æ‹©å½¹ç§</span>'}
                            </div>
                          </div>
                          <div class="space-y-2 max-h-[300px] overflow-y-auto">
                            ${['yakuman', '6han', '3han', '2han', '1han'].map(category => {
                              const categoryYaku = allYakuList.filter(y => y.category === category);
                              const categoryNames = {
                                'yakuman': 'å½¹æ»¡',
                                '6han': '6ç•ª',
                                '3han': '3ç•ª',
                                '2han': '2ç•ª',
                                '1han': '1ç•ª'
                              };
                              return `
                                <div>
                                  <p class="text-xs font-bold text-purple-700 mb-1">${categoryNames[category]}</p>
                                  <div class="grid grid-cols-3 gap-1">
                                    ${categoryYaku.map(yaku => {
                                      const isSelected = manualYaku.includes(yaku.id);
                                      return `
                                        <button
                                          data-action="toggle-manual-yaku"
                                          data-yaku-id="${yaku.id}"
                                          class="py-1 px-2 text-xs rounded font-bold ${
                                            isSelected 
                                              ? 'bg-purple-500 text-white' 
                                              : 'bg-gray-100 hover:bg-gray-200'
                                          }"
                                        >
                                          ${yaku.name}
                                        </button>
                                      `;
                                    }).join('')}
                                  </div>
                                </div>
                              `;
                            }).join('')}
                          </div>
                          <div class="mt-3 pt-3 border-t border-purple-200">
                            <label class="block text-xs font-bold text-purple-800 mb-2">ç¬¦æ•°è®¾ç½®</label>
                            <div class="grid grid-cols-6 gap-1">
                              ${[20, 25, 30, 40, 50, 60, 70, 80, 90, 100, 110].map(fu => `
                                <button
                                  data-action="set-manual-fu"
                                  data-fu="${fu}"
                                  class="py-2 text-sm rounded font-bold ${
                                    manualFu === fu 
                                      ? 'bg-purple-500 text-white' 
                                      : 'bg-gray-100 hover:bg-gray-200'
                                  }"
                                >
                                  ${fu}ç¬¦
                                </button>
                              `).join('')}
                            </div>
                            <p class="text-xs text-purple-600 mt-2">ğŸ’¡ æç¤º: å¹³å’Œè‡ªæ‘¸20ç¬¦/è£å’Œ30ç¬¦ï¼Œä¸ƒå¯¹å­25ç¬¦ï¼Œå…¶ä»–ä¸€èˆ¬40ç¬¦èµ·</p>
                          </div>
                          <div class="mt-3 pt-3 border-t border-purple-200">
                            <label class="flex items-center justify-between cursor-pointer">
                              <span class="text-xs font-bold text-purple-800">æ˜¯å¦æœ‰å‰¯éœ²ï¼ˆå½±å“ç•ªæ•°è®¡ç®—ï¼‰</span>
                              <div class="relative">
                                <input
                                  type="checkbox"
                                  data-action="toggle-manual-furo"
                                  ${isManualFuro ? 'checked' : ''}
                                  class="sr-only peer"
                                >
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                              </div>
                            </label>
                            <p class="text-xs text-purple-600 mt-1">
                              ${isManualFuro ? 'âš ï¸ å‰¯éœ²æ¨¡å¼ï¼šæœ‰å‰¯éœ²å‡ç•ªçš„å½¹ç§å°†ä½¿ç”¨å‰¯éœ²ç•ªæ•°' : 'âœ… é—¨å‰æ¨¡å¼ï¼šä½¿ç”¨å®Œæ•´ç•ªæ•°'}
                            </p>
                          </div>
                        </div>
                      ` : ''}
                    </div>

                    ${!isManualMode && !isExpertMode ? `
                    <!-- æ‰‹ç‰ŒåŒºæ˜¾ç¤º -->
                    <div class="mb-4">
                      <div class="flex justify-between items-center mb-1 gap-2">
                        <button
                          data-action="set-active-area"
                          data-area="hand"
                          class="flex-1 text-left py-2 px-3 rounded-lg font-bold transition-all ${
                            activeTileArea === 'hand' 
                              ? 'bg-blue-600 text-white shadow-lg' 
                              : 'bg-white text-blue-700 border-2 border-blue-300 hover:bg-blue-50'
                          }"
                        >
                          ğŸ€„ æ‰‹ç‰ŒåŒº (${selectedTiles.length}/${getRequiredHandTileCount()})
                          ${activeTileArea === 'hand' ? ' âœ“' : ''}
                        </button>
                        ${selectedTiles.length > 0 ? `
                        <button
                          data-action="clear-hand"
                          class="text-xs text-red-600 hover:text-red-800 font-bold px-3 py-2 rounded-lg border-2 border-red-300 hover:bg-red-50"
                        >
                          ä¸€é”®æ¸…é™¤
                        </button>
                        ` : ''}
                      </div>
                      ${melds.length > 0 || melds.filter(m => m.type === 'minkan' || m.type === 'ankan').length > 0 ? `
                        <p class="text-xs text-gray-500 mb-1">
                          ğŸ’¡ æ€»é™åˆ¶: ${getTotalTileLimit()}å¼  = 13 + ${melds.filter(m => m.type === 'minkan' || m.type === 'ankan').length}æ  | 
                          å‰¯éœ²å·²ç”¨: ${melds.reduce((sum, m) => sum + m.tiles.length, 0)}å¼  | 
                          æ‰‹ç‰Œå¯ç”¨: ${getRequiredHandTileCount()}å¼ 
                        </p>
                      ` : `
                        <p class="text-xs text-gray-500 mb-1">æç¤ºï¼šç‚¹å‡»æ‰‹ç‰Œå¯ä»¥åˆ é™¤</p>
                      `}
                      <div class="bg-gray-100 p-3 rounded-lg mb-2 min-h-[60px]">
                        <div class="flex flex-wrap gap-1">
                          ${selectedTiles.map((tile, idx) => `
                            <button
                              key="${idx}"
                              data-action="remove-tile"
                              data-index="${idx}"
                              class="border-2 rounded px-2 py-1 font-bold ${getTileColor(tile)} hover:bg-red-100"
                            >
                              ${tile}
                            </button>
                          `).join('')}
                          ${selectedTiles.length === 0 ? `
                            <span class="text-gray-400 text-xs">æš‚æ— æ‰‹ç‰Œï¼ˆç‚¹å‡»ä¸Šæ–¹"ğŸ€„ æ‰‹ç‰ŒåŒº"æŒ‰é’®åæ·»åŠ ï¼‰</span>
                          ` : ''}
                        </div>
                      </div>
                      
                      ${tenpaiWaits.length > 0 ? `
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg mb-2">
                          <h4 class="font-bold text-blue-800 mb-2">
                            å¬ç‰Œåˆ†æ (å’Œç‰Œè€…: ${winnerIndex !== null ? players[winnerIndex].wind : 'åº„å®¶'}, ${isTsumo ? 'è‡ªæ‘¸' : 'è£å’Œ'}, ä¸å«é‡Œå®)
                          </h4>
                          <ul class="list-disc list-inside space-y-1">
                            ${tenpaiWaits.map(wait => `
                              <li class="text-sm">
                                <span class="font-bold">${wait.tile}</span>: 
                                <span class="text-blue-700">${wait.yaku}</span> 
                                (${wait.han}ç•ª ${wait.fu}ç¬¦) - 
                                <span class="font-bold">${wait.score.toLocaleString()}ç‚¹</span>
                              </li>
                            `).join('')}
                          </ul>
                        </div>
                      ` : (selectedTiles.length === getRequiredHandTileCount() ? `
                        <div class="p-2 bg-yellow-50 border border-yellow-200 rounded-lg mb-2">
                          <p class="text-sm text-yellow-800">æœªå¬ç‰Œ</p>
                        </div>
                      ` : '')}
                    </div>

                    <!-- å‰¯éœ²åŒºæ˜¾ç¤º -->
                    <div class="mb-4">
                      <div class="flex justify-between items-center mb-1 gap-2">
                        <button
                          data-action="set-active-area"
                          data-area="meld"
                          class="flex-1 text-left py-2 px-3 rounded-lg font-bold transition-all ${
                            activeTileArea === 'meld' 
                              ? 'bg-indigo-600 text-white shadow-lg' 
                              : 'bg-white text-indigo-700 border-2 border-indigo-300 hover:bg-indigo-50'
                          }"
                        >
                          ğŸ´ å‰¯éœ²åŒº (${melds.length}ç»„)
                          ${activeTileArea === 'meld' ? ' âœ“' : ''}
                        </button>
                        ${melds.length > 0 ? `
                        <button
                          data-action="clear-melds"
                          class="text-xs text-red-600 hover:text-red-800 font-bold px-3 py-2 rounded-lg border-2 border-red-300 hover:bg-red-50"
                        >
                          æ¸…ç©ºå‰¯éœ²
                        </button>
                        ` : ''}
                      </div>
                      
                      <!-- å‰¯éœ²ç±»å‹é€‰æ‹©å™¨ï¼ˆä»…åœ¨å‰¯éœ²åŒºæ¿€æ´»æ—¶æ˜¾ç¤ºï¼‰ -->
                      ${activeTileArea === 'meld' ? `
                        <div class="mb-2 p-2 bg-indigo-100 border border-indigo-300 rounded-lg">
                          <p class="text-xs text-indigo-800 font-bold mb-2">ğŸ’¡ å…ˆé€‰æ‹©å‰¯éœ²ç±»å‹ï¼Œå†ç‚¹å‡»ä¸‹æ–¹ç‰Œé¢</p>
                          <div class="grid grid-cols-4 gap-1">
                            <button
                              data-action="set-meld-mode"
                              data-type="shuntsu"
                              class="py-1.5 text-xs rounded font-bold ${
                                pendingMeldType === 'shuntsu' 
                                  ? 'bg-blue-500 text-white' 
                                  : 'bg-blue-100 hover:bg-blue-200 text-blue-800'
                              }"
                            >
                              ${pendingMeldType === 'shuntsu' ? 'âœ“ ' : ''}é¡ºå­
                            </button>
                            <button
                              data-action="set-meld-mode"
                              data-type="pon"
                              class="py-1.5 text-xs rounded font-bold ${
                                pendingMeldType === 'pon' 
                                  ? 'bg-green-500 text-white' 
                                  : 'bg-green-100 hover:bg-green-200 text-green-800'
                              }"
                            >
                              ${pendingMeldType === 'pon' ? 'âœ“ ' : ''}åˆ»å­
                            </button>
                            <button
                              data-action="set-meld-mode"
                              data-type="minkan"
                              class="py-1.5 text-xs rounded font-bold ${
                                pendingMeldType === 'minkan' 
                                  ? 'bg-purple-500 text-white' 
                                  : 'bg-purple-100 hover:bg-purple-200 text-purple-800'
                              }"
                            >
                              ${pendingMeldType === 'minkan' ? 'âœ“ ' : ''}æ˜æ 
                            </button>
                            <button
                              data-action="set-meld-mode"
                              data-type="ankan"
                              class="py-1.5 text-xs rounded font-bold ${
                                pendingMeldType === 'ankan' 
                                  ? 'bg-orange-500 text-white' 
                                  : 'bg-orange-100 hover:bg-orange-200 text-orange-800'
                              }"
                            >
                              ${pendingMeldType === 'ankan' ? 'âœ“ ' : ''}æš—æ 
                            </button>
                          </div>
                          ${pendingMeldType ? `
                            <p class="text-xs text-indigo-700 mt-2 font-bold">
                              ğŸ‘‰ å·²é€‰æ‹©ï¼š${
                                pendingMeldType === 'shuntsu' ? 'é¡ºå­ï¼ˆé€‰ç¬¬ä¸€å¼ ç‰Œè‡ªåŠ¨è¡¥å…¨ï¼‰' :
                                pendingMeldType === 'pon' ? 'åˆ»å­ï¼ˆé€‰ä»»æ„ä¸€å¼ ï¼‰' :
                                pendingMeldType === 'minkan' ? 'æ˜æ ï¼ˆé€‰ä»»æ„ä¸€å¼ ï¼‰' : 'æš—æ ï¼ˆé€‰ä»»æ„ä¸€å¼ ï¼‰'
                              }
                            </p>
                          ` : `
                            <p class="text-xs text-gray-500 mt-2">è¯·å…ˆé€‰æ‹©å‰¯éœ²ç±»å‹</p>
                          `}
                        </div>
                      ` : ''}
                      
                      ${melds.length > 0 ? `
                      <div class="bg-indigo-50 p-3 rounded-lg mb-2 min-h-[60px]">
                        <div class="flex flex-wrap gap-2">
                          ${melds.map((meld, idx) => {
                            const meldTypeNames = {
                              'shuntsu': 'é¡º',
                              'pon': 'åˆ»',
                              'minkan': 'æ˜æ ',
                              'ankan': 'æš—æ '
                            };
                            return `
                            <div class="inline-flex items-center bg-white rounded-lg border-2 border-indigo-300 p-1.5 gap-1">
                              <div class="flex gap-0.5">
                                ${meld.tiles.map(tile => `
                                  <span class="px-1.5 py-0.5 text-xs font-bold ${getTileColor(tile)} rounded">
                                    ${tile}
                                  </span>
                                `).join('')}
                              </div>
                              <span class="text-xs text-indigo-600 font-bold px-1">${meldTypeNames[meld.type]}</span>
                              <button
                                data-action="remove-meld"
                                data-index="${idx}"
                                class="text-red-500 hover:text-red-700 hover:bg-red-100 rounded px-1.5 py-0.5 font-bold text-sm"
                                title="åˆ é™¤æ­¤å‰¯éœ²"
                              >
                                Ã—
                              </button>
                            </div>
                          `}).join('')}
                        </div>
                      </div>
                      ` : `
                      <div class="bg-gray-50 p-3 rounded-lg mb-2">
                        <p class="text-xs text-gray-400">æš‚æ— å‰¯éœ²ï¼ˆç‚¹å‡»ä¸Šæ–¹"ğŸ´ å‰¯éœ²åŒº"æŒ‰é’®åæ·»åŠ ï¼‰</p>
                      </div>
                      `}
                    </div>

                    <!-- å’Œç‰Œæ˜¾ç¤º -->
                    <div class="mb-4">
                      <button
                        data-action="set-active-area"
                        data-area="win"
                        class="w-full text-left py-2 px-3 rounded-lg font-bold transition-all mb-2 ${
                          activeTileArea === 'win' 
                            ? 'bg-emerald-600 text-white shadow-lg' 
                            : 'bg-white text-emerald-700 border-2 border-emerald-300 hover:bg-emerald-50'
                        }"
                      >
                        â­ å’Œç‰ŒåŒº (${winTile || 'æœªé€‰æ‹©'})
                        ${activeTileArea === 'win' ? ' âœ“' : ''}
                      </button>
                      <div class="bg-gray-100 p-3 rounded-lg mb-2">
                        ${winTile ? `
                          <button
                            data-action="clear-wintile"
                            class="border-2 rounded px-3 py-2 font-bold text-lg ${getTileColor(winTile)} hover:bg-red-100"
                            title="ç‚¹å‡»æ¸…é™¤å’Œç‰Œ"
                          >
                            ${winTile}
                          </button>
                        ` : `
                          <span class="text-gray-400">æœªé€‰æ‹©ï¼ˆç‚¹å‡»ä¸Šæ–¹"â­ å’Œç‰ŒåŒº"æŒ‰é’®åé€‰æ‹©ï¼‰</span>
                        `}
                      </div>
                    </div>

                    <!-- ç»Ÿä¸€çš„éº»å°†ç‰Œé€‰æ‹©å™¨ -->
                    <div class="mb-4">
                      <div class="p-3 bg-white border-2 rounded-lg ${
                        activeTileArea === 'hand' ? 'border-blue-400 shadow-lg' :
                        activeTileArea === 'meld' ? 'border-indigo-400 shadow-lg' :
                        'border-emerald-400 shadow-lg'
                      }">
                        <div class="flex justify-between items-center mb-2">
                          <p class="text-sm font-bold ${
                            activeTileArea === 'hand' ? 'text-blue-700' :
                            activeTileArea === 'meld' ? 'text-indigo-700' :
                            'text-emerald-700'
                          }">
                            ğŸ´ éº»å°†ç‰Œé€‰æ‹©å™¨
                            ${activeTileArea === 'meld' && !pendingMeldType ? ' - âš ï¸ è¯·å…ˆé€‰æ‹©å‰¯éœ²ç±»å‹' : ''}
                          </p>
                        </div>
                        
                        ${[
                          { label: 'ä¸‡å­', tiles: tileTypes.man },
                          { label: 'é¥¼å­', tiles: tileTypes.pin },
                          { label: 'ç´¢å­', tiles: tileTypes.sou },
                          { label: 'å­—ç‰Œ', tiles: tileTypes.honor },
                        ].map(group => `
                          <div key="${group.label}" class="mb-2">
                            <div class="text-xs text-gray-600 mb-1 font-bold">${group.label}</div>
                            <div class="flex flex-wrap gap-1">
                              ${group.tiles.map(tile => {
                                const isMaxed = getTileUsageCount(tile) >= 4;
                                const requiredCount = getRequiredHandTileCount();
                                const canAddToHand = activeTileArea === 'hand' && selectedTiles.length < requiredCount && !isMaxed;
                                const canAddToMeld = activeTileArea === 'meld' && pendingMeldType && !isMaxed;
                                const canSetWin = activeTileArea === 'win' && !isMaxed;
                                const isDisabled = !canAddToHand && !canAddToMeld && !canSetWin;
                                const isSelected = activeTileArea === 'win' && winTile === tile;
                                
                                return `
                                <button
                                  key="${tile}"
                                  data-action="tile-click"
                                  data-tile="${tile}"
                                  ${isDisabled ? 'disabled' : ''}
                                  class="border-2 rounded px-2 py-1.5 text-sm font-bold transition-all ${
                                    isSelected 
                                      ? 'bg-emerald-500 text-white border-emerald-600 shadow-lg' 
                                      : isDisabled 
                                      ? 'opacity-30 cursor-not-allowed bg-gray-200' 
                                      : getTileColor(tile) + ' hover:scale-110 hover:shadow-md'
                                  }"
                                >
                                  ${tile}
                                </button>
                              `}).join('')}
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                    ` : ''}
                    
                    ${!isManualMode && !isExpertMode ? `
                    <div class="mb-4">
                      <label class="block text-sm font-bold mb-2">å®ç‰Œ</label>
                      <div class="grid grid-cols-3 gap-4">
                        ${getDoraCounterHTML({ label: 'Dora', value: dora, type: 'dora' })}
                        ${getDoraCounterHTML({ 
                          label: 'é‡ŒDora', 
                          value: uraDora, 
                          type: 'uraDora', 
                          max: (isManualMode || isExpertMode) ? 12 : ((isRiichi || isDoubleRiichi) ? 12 : 0)
                        })}
                        ${(() => {
                          const redDoraInfo = calculateRedDoraInfo();
                          return getDoraCounterHTML({ 
                            label: `èµ¤Dora ${redDoraInfo.maxRedDora === 0 ? '(æ— 5)' : ''}`, 
                            value: redDora, 
                            type: 'redDora', 
                            max: redDoraInfo.maxRedDora 
                          });
                        })()}
                      </div>
                    </div>

                    <div class="mb-4">
                      <button
                        data-action="toggle-yaku-section"
                        class="w-full flex justify-between items-center py-2 px-3 rounded-lg font-bold transition-all bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 hover:border-purple-300"
                      >
                        <span class="text-sm font-bold text-purple-800">
                          ${isYakuExpanded ? 'ğŸ”½' : 'â–¶ï¸'} çŠ¶å†µå½¹
                          ${(() => {
                            const activeYaku = [];
                            if (isMenzen) activeYaku.push('é—¨æ¸…');
                            if (isRiichi) activeYaku.push('ç«‹ç›´');
                            if (isDoubleRiichi) activeYaku.push('äºŒç«‹ç›´');
                            if (isIppatsu) activeYaku.push('ä¸€å‘');
                            if (isTenhou) activeYaku.push('å¤©å’Œ');
                            if (isChiihou) activeYaku.push('åœ°å’Œ');
                            if (isRenhou) activeYaku.push('äººå’Œ');
                            if (isHaitei) activeYaku.push('æµ·åº•ææœˆ');
                            if (isHoutei) activeYaku.push('æ²³åº•æ‘¸é±¼');
                            if (isRinshan) activeYaku.push('å²­ä¸Šå¼€èŠ±');
                            if (isChankan) activeYaku.push('æŠ¢æ ');
                            return activeYaku.length > 0 ? ` (${activeYaku.join('ã€')})` : '';
                          })()}
                        </span>
                        <span class="text-xs text-purple-600">${isYakuExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}</span>
                      </button>
                      
                      ${isYakuExpanded ? `
                      <div class="grid grid-cols-3 gap-2 mt-3">
                        <button
                          disabled
                          class="py-2 rounded-lg font-bold ${isMenzen ? 'bg-teal-500 text-white' : 'bg-gray-400 text-white'} opacity-75 cursor-not-allowed"
                        >
                          é—¨æ¸… ${isMenzen ? 'âœ“' : '(æœ‰æ˜å‰¯éœ²)'}
                        </button>
                        <button
                          data-action="toggle-riichi"
                          ${(winnerIndex === null || !players[winnerIndex].isRiichi) ? 'disabled' : ''}
                          class="py-2 rounded-lg font-bold ${isRiichi ? 'bg-purple-500 text-white' : 'bg-gray-200'} ${(winnerIndex === null || !players[winnerIndex].isRiichi) ? 'opacity-50 cursor-not-allowed' : ''}"
                        >
                          ç«‹ç›´ (+1ç•ª) ${(winnerIndex !== null && players[winnerIndex].isRiichi) ? (isRiichi ? 'âœ“' : '') : '(æœªç«‹ç›´)'}
                        </button>
                        <button
                          data-action="toggle-double-riichi"
                          ${(winnerIndex === null || !players[winnerIndex].isRiichi) ? 'disabled' : ''}
                          class="py-2 rounded-lg font-bold ${isDoubleRiichi ? 'bg-purple-600 text-white' : 'bg-gray-200'} ${(winnerIndex === null || !players[winnerIndex].isRiichi) ? 'opacity-50 cursor-not-allowed' : ''}"
                        >
                          äºŒç«‹ç›´ (+2ç•ª) ${(winnerIndex !== null && players[winnerIndex].isRiichi) ? (isDoubleRiichi ? 'âœ“' : '') : '(æœªç«‹ç›´)'}
                        </button>
                        <button
                          data-action="toggle-ippatsu"
                          ${!(isRiichi || isDoubleRiichi) ? 'disabled' : ''}
                          class="py-2 rounded-lg font-bold ${
                            isIppatsu ? 'bg-purple-500 text-white' : 'bg-gray-200'
                          } disabled:opacity-50"
                        >
                          ä¸€å‘ (+1ç•ª)
                        </button>
                        <button
                          data-action="toggle-tenhou"
                          ${!isMenzen ? 'disabled' : ''}
                          class="py-2 rounded-lg font-bold text-sm ${isTenhou ? 'bg-yellow-500 text-white' : 'bg-gray-200'} ${!isMenzen ? 'opacity-50 cursor-not-allowed' : ''}"
                        >
                          å¤©å’Œ (å½¹æ»¡)${!isMenzen ? ' (éœ€é—¨æ¸…)' : ''}
                        </button>
                        <button
                          data-action="toggle-chiihou"
                          ${!isMenzen ? 'disabled' : ''}
                          class="py-2 rounded-lg font-bold text-sm ${isChiihou ? 'bg-yellow-500 text-white' : 'bg-gray-200'} ${!isMenzen ? 'opacity-50 cursor-not-allowed' : ''}"
                        >
                          åœ°å’Œ (å½¹æ»¡)${!isMenzen ? ' (éœ€é—¨æ¸…)' : ''}
                        </button>
                        <button
                          data-action="toggle-renhou"
                          ${!isMenzen ? 'disabled' : ''}
                          class="py-2 rounded-lg font-bold text-sm ${isRenhou ? 'bg-yellow-500 text-white' : 'bg-gray-200'} ${!isMenzen ? 'opacity-50 cursor-not-allowed' : ''}"
                        >
                          äººå’Œ (å½¹æ»¡)${!isMenzen ? ' (éœ€é—¨æ¸…)' : ''}
                        </button>
                        <button
                          data-action="toggle-haitei"
                          class="py-2 rounded-lg font-bold text-sm ${isHaitei ? 'bg-blue-500 text-white' : 'bg-gray-200'}"
                        >
                          æµ·åº•ææœˆ (+1ç•ª)
                        </button>
                        <button
                          data-action="toggle-houtei"
                          class="py-2 rounded-lg font-bold text-sm ${isHoutei ? 'bg-blue-500 text-white' : 'bg-gray-200'}"
                        >
                          æ²³åº•æ‘¸é±¼ (+1ç•ª)
                        </button>
                        <button
                          data-action="toggle-rinshan"
                          class="py-2 rounded-lg font-bold text-sm ${isRinshan ? 'bg-green-500 text-white' : 'bg-gray-200'}"
                        >
                          å²­ä¸Šå¼€èŠ± (+1ç•ª)
                        </button>
                        <button
                          data-action="toggle-chankan"
                          class="py-2 rounded-lg font-bold text-sm ${isChankan ? 'bg-red-500 text-white' : 'bg-gray-200'}"
                        >
                          æŠ¢æ  (+1ç•ª)
                        </button>
                      </div>
                      ` : ''}
                    </div>
                    ` : ''}
                    
                    ${currentAnalysis ? `
                      <div class="mb-4 p-4 bg-emerald-50 rounded-lg border-2 border-emerald-200">
                        <h4 class="font-bold text-emerald-800 mb-2">ç‰Œå‹åˆ†æ</h4>
                        <div class="flex flex-wrap gap-2 mb-3">
                          ${currentAnalysis.yaku.map((y, i) => `
                            <span key="${i}" class="px-2 py-1 bg-emerald-200 rounded-lg text-sm font-bold">
                              ${y}
                            </span>
                          `).join('')}
                        </div>
                        <div class="text-lg font-bold text-emerald-700 mb-1">
                          ${currentAnalysis.han - (dora + ((isRiichi || isDoubleRiichi) ? uraDora : 0) + redDora)} (å½¹) + 
                          ${dora + ((isRiichi || isDoubleRiichi) ? uraDora : 0) + redDora} (å®) = 
                          <span class="text-xl"> ${currentAnalysis.han}ç•ª ${currentAnalysis.fu}ç¬¦</span>
                        </div>
                        <div class="text-3xl font-bold text-emerald-800">
                          ${scoreData.total.toLocaleString()} ç‚¹
                          ${gameState.honba > 0 ? ` (+${gameState.honba * 300} æœ¬åœº)` : ''}
                        </div>
                        
                        <div class="mt-3 pt-3 border-t">
                          <h5 class="font-bold text-sm text-emerald-700">åˆ†æ•°å˜åŒ–é¢„è§ˆ (å«ç«‹ç›´æ£’):</h5>
                          ${(() => {
                            return gameState.riichiSticks > 0 ? `
                              <div class="text-xs text-yellow-700 mb-1">
                                ç«‹ç›´æ£’: ${gameState.riichiSticks}æ ¹ = ${gameState.riichiSticks * 1000}ç‚¹ â†’ ${winnerIndex !== null ? players[winnerIndex].wind : '?'}
                              </div>
                            ` : '';
                          })()}
                          <div class="grid grid-cols-2 md:grid-cols-4 gap-1 text-sm">
                            ${players.map((p, i) => `
                              <div>
                                <span class="font-bold">${p.wind}:</span>
                                <span class="${scoreChanges[i] > 0 ? 'text-green-600' : (scoreChanges[i] < 0 ? 'text-red-600' : 'text-gray-600')} font-bold">
                                  ${scoreChanges[i] > 0 ? '+' : ''}${scoreChanges[i].toLocaleString()}
                                </span>
                              </div>
                            `).join('')}
                          </div>
                        </div>
                        
                      </div>
                    ` : ''}
                    
                    ${analysisError ? `
                      <div class="mb-4 p-4 bg-yellow-50 rounded-lg border-2 border-yellow-300">
                        <p class="text-yellow-800 font-bold">âš ï¸ ${analysisError}</p>
                      </div>
                    ` : ''}

                    <div class="flex gap-2">
                      <button
                        data-action="cancel-scorer"
                        class="flex-1 py-3 bg-gray-300 rounded-xl font-bold hover:bg-gray-400"
                      >
                        å–æ¶ˆ
                      </button>
                      <button
                        data-action="confirm-win"
                        ${(!currentAnalysis || winnerIndex === null || (!isTsumo && loserIndex === null)) ? 'disabled' : ''}
                        class="flex-1 py-3 bg-gradient-to-r from-emerald-500 to-green-500 text-white rounded-xl font-bold hover:from-emerald-600 hover:to-green-600 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        ç¡®è®¤ç»“ç®—
                      </button>
                    </div>
                    `}
                  </div>
                ` : ''}
              </div>

              <div class="bg-white rounded-2xl shadow-2xl p-6">
                <h2 class="text-xl font-bold mb-4">å½“å‰æ’å</h2>
                <div class="space-y-2">
                  ${[...players]
                    .sort((a, b) => b.score - a.score)
                    .map((player, idx) => `
                      <div
                        key="${player.id}"
                        class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"
                      >
                        <div class="flex items-center gap-4">
                          <span class="text-2xl font-bold text-gray-400 w-8">
                            ${idx + 1}
                          </span>
                          <span class="font-bold">${player.wind}</span>
                          <span>${player.name}</span>
                        </div>
                        <span class="text-xl font-bold text-emerald-700">
                          ${player.score.toLocaleString()}
                        </span>
                      </div>
                    `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      };


      // ====================================================================
      // 6. RENDER & EVENT LISTENERS
      // ====================================================================
      
      // æ€§èƒ½ä¼˜åŒ–ï¼šæ·»åŠ é˜²æŠ–å’ŒèŠ‚æµ
      let renderTimer = null;
      let saveTimer = null;
      
      const render = () => {
        // å–æ¶ˆä¹‹å‰çš„æ¸²æŸ“ä»»åŠ¡
        if (renderTimer) {
          cancelAnimationFrame(renderTimer);
        }
        
        // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½
        renderTimer = requestAnimationFrame(() => {
          const root = document.getElementById('root');

          if (!gameSettings) {
            root.innerHTML = getStartScreenHTML();
          } else if (isGameOver) {
            root.innerHTML = getGameOverScreenHTML();
          } else if (showHistory) {
            root.innerHTML = getHistoryScreenHTML();
          } else {
            root.innerHTML = getMainGameHTML();
          }

          attachEventListeners();
          
          // å®‰å…¨è°ƒç”¨ lucide.createIcons()ï¼Œé¿å… lucide æœªåŠ è½½å®Œæˆæ—¶æŠ¥é”™
          if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
          }
          
          // æ¸²æŸ“Toastæç¤º
          renderToast();
          
          // ä¸å†è‡ªåŠ¨ä¿å­˜ï¼Œä»…åœ¨ç»“ç®—åä¿å­˜
        });
      };
      
      // é˜²æŠ–ä¿å­˜å‡½æ•°å·²ç§»é™¤ï¼Œæ”¹ä¸ºåœ¨ç»“ç®—åç›´æ¥ä¿å­˜

      const attachEventListeners = () => {
        // æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œå‡å°‘äº‹ä»¶ç›‘å¬å™¨æ•°é‡
        const root = document.getElementById('root');
        
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (root._clickHandler) {
          root.removeEventListener('click', root._clickHandler);
        }
        
        // äº‹ä»¶å¤„ç†å™¨æ˜ å°„è¡¨
        const actionHandlers = {
          'continue-game': () => render(),
          'clear-saved-game': () => {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ä¿å­˜çš„è¿›åº¦å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
              clearGameState();
              render();
            }
          },
          'select-game': (t) => {
            gameSettings = { type: t.dataset.type, tobu: document.getElementById('tobu-checkbox').checked };
            render();
          },
          'toggle-history': () => { showHistory = !showHistory; render(); },
          'reset-game': () => resetGame(),
          'select-round-type': (t) => handleSelectRoundType(t.dataset.type),
          'cancel-draw': () => {
            showDrawDialog = false;
            tenpaiedPlayers = [];
            drawRiichiPlayers = [];
            isStartingHandDraw = false;
            nagashiManganPlayers = [];
            showNagashiMangan = false;
            render();
          },
          'confirm-draw': () => handleDrawConfirm(),
          'toggle-draw-type': (t) => {
            isStartingHandDraw = (t.dataset.type === 'starting');
            if (isStartingHandDraw) {
              tenpaiedPlayers = [];
              drawRiichiPlayers = [];
              nagashiManganPlayers = [];
              showNagashiMangan = false;
            }
            render();
          },
          'toggle-nagashi-mangan': () => { showNagashiMangan = !showNagashiMangan; render(); },
          'toggle-nagashi-mangan-player': (t) => handleToggleNagashiManganPlayer(parseInt(t.dataset.index, 10)),
          'toggle-tenpai': (t) => handleToggleTenpai(parseInt(t.dataset.index, 10)),
          'toggle-draw-riichi': (t) => handleToggleDrawRiichi(parseInt(t.dataset.index, 10)),
          'cancel-scorer': () => resetScoreInput(),
          'confirm-win': () => handleWin(),
          'confirm-multi-win': () => handleMultiWin(),
          'toggle-multi-winner': (t) => handleToggleMultiWinner(parseInt(t.dataset.index, 10)),
          'set-multi-loser': (t) => { multiWinLoser = parseInt(t.dataset.index, 10); render(); },
          'set-multi-winner-han': (t) => handleSetMultiWinnerHan(parseInt(t.dataset.winner, 10), parseInt(t.dataset.han, 10)),
          'set-multi-winner-fu': (t) => handleSetMultiWinnerFu(parseInt(t.dataset.winner, 10), parseInt(t.dataset.fu, 10)),
          'set-tsumo': (t) => handleSetTsumo(t.dataset.value === 'true'),
          'set-winner': (t) => handleSetWinner(parseInt(t.dataset.index, 10)),
          'set-loser': (t) => { loserIndex = parseInt(t.dataset.index, 10); render(); },
          'toggle-player-riichi': (t) => handleTogglePlayerRiichi(parseInt(t.dataset.index, 10)),
          'clear-hand': () => clearHand(),
          'set-active-area': (t) => { activeTileArea = t.dataset.area; render(); },
          'set-meld-mode': (t) => { pendingMeldType = t.dataset.type; activeTileArea = 'meld'; render(); },
          'remove-meld': (t) => removeMeld(parseInt(t.dataset.index, 10)),
          'clear-melds': () => clearMelds(),
          'tile-click': (t) => handleTileClick(t.dataset.tile),
          'remove-tile': (t) => removeTile(parseInt(t.dataset.index, 10)),
          'clear-wintile': () => { winTile = null; render(); },
          'toggle-analysis-mode': (t) => handleToggleAnalysisMode(t.dataset.mode),
          'toggle-manual-yaku': (t) => handleToggleManualYaku(t.dataset.yakuId),
          'remove-manual-yaku': (t) => { manualYaku = manualYaku.filter(id => id !== t.dataset.yakuId); render(); },
          'set-manual-fu': (t) => { manualFu = parseInt(t.dataset.fu, 10); render(); },
          'set-expert-han': (t) => { expertHan = parseInt(t.dataset.han, 10); render(); },
          'set-expert-fu': (t) => { expertFu = parseInt(t.dataset.fu, 10); render(); },
          'toggle-riichi': () => handleToggleRiichi(),
          'toggle-ippatsu': () => { isIppatsu = !isIppatsu; render(); },
          'toggle-double-riichi': () => handleToggleDoubleRiichi(),
          'toggle-tenhou': () => handleToggleTenhou(),
          'toggle-chiihou': () => handleToggleChiihou(),
          'toggle-renhou': () => handleToggleRenhou(),
          'toggle-haitei': () => handleToggleHaitei(),
          'toggle-houtei': () => handleToggleHoutei(),
          'toggle-rinshan': () => handleToggleRinshan(),
          'toggle-chankan': () => handleToggleChankan(),
          'toggle-yaku-section': () => { isYakuExpanded = !isYakuExpanded; render(); },
          'change-dora': (t) => handleChangeDora(t.dataset.type, parseInt(t.dataset.amount, 10), parseInt(t.dataset.max, 10) || 12),
          'export-record': () => exportGameRecord()
        };
        
        // ç»Ÿä¸€çš„ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨
        const clickHandler = (e) => {
          const target = e.target.closest('[data-action]');
          if (!target) return;
          
          const action = target.dataset.action;
          const handler = actionHandlers[action];
          
          if (handler) {
            handler(target);
          }
        };
        
        // ä¿å­˜äº‹ä»¶å¤„ç†å™¨å¼•ç”¨ï¼Œä¾¿äºä¸‹æ¬¡ç§»é™¤
        root._clickHandler = clickHandler;
        root.addEventListener('click', clickHandler);
        
        // å¤„ç† input äº‹ä»¶
        const inputHandler = (e) => {
          const target = e.target;
          
          // ç©å®¶åç§°è¾“å…¥
          if (target.id && target.id.startsWith('player-name-')) {
            const idx = parseInt(target.id.split('-')[2], 10);
            if (!isNaN(idx) && players[idx]) {
              players[idx].name = target.value;
            }
            return;
          }
          
          // å¤šäººå’Œç‰Œç•ªæ•°è¾“å…¥
          if (target.dataset.action === 'input-multi-winner-han') {
            const winnerIdx = parseInt(target.dataset.winner, 10);
            const han = parseInt(target.value) || 1;
            if (multiWinHanFu[winnerIdx]) {
              multiWinHanFu[winnerIdx].han = han;
              render();
            }
            return;
          }
          
          // å¤šäººå’Œç‰Œç¬¦æ•°è¾“å…¥
          if (target.dataset.action === 'input-multi-winner-fu') {
            const winnerIdx = parseInt(target.dataset.winner, 10);
            const fu = parseInt(target.value) || 30;
            if (multiWinHanFu[winnerIdx]) {
              multiWinHanFu[winnerIdx].fu = fu;
              render();
            }
            return;
          }
          
          // è€æ‰‹æ¨¡å¼ç•ªæ•°è¾“å…¥
          if (target.dataset.action === 'input-expert-han') {
            const value = parseInt(target.value, 10);
            if (!isNaN(value) && value >= 1 && value <= 99) {
              expertHan = value;
              render();
            }
            return;
          }
          
          // è€æ‰‹æ¨¡å¼ç¬¦æ•°è¾“å…¥
          if (target.dataset.action === 'input-expert-fu') {
            const value = parseInt(target.value, 10);
            if (!isNaN(value) && value >= 20 && value <= 110) {
              expertFu = value;
              render();
            }
            return;
          }
        };
        
        // å¤„ç† change äº‹ä»¶
        const changeHandler = (e) => {
          const target = e.target;
          
          // æ‰‹åŠ¨æ¨¡å¼å‰¯éœ²çŠ¶æ€åˆ‡æ¢
          if (target.dataset.action === 'toggle-manual-furo') {
            isManualFuro = target.checked;
            render();
          }
        };
        
        if (root._inputHandler) {
          root.removeEventListener('input', root._inputHandler);
        }
        root._inputHandler = inputHandler;
        root.addEventListener('input', inputHandler);
        
        if (root._changeHandler) {
          root.removeEventListener('change', root._changeHandler);
        }
        root._changeHandler = changeHandler;
        root.addEventListener('change', changeHandler);
      };
      
      // è¾…åŠ©å‡½æ•°ï¼šå¤„ç†å„ç§æ“ä½œ
      const handleSelectRoundType = (type) => {
        if (type === 'draw') {
          showDrawDialog = true;
          multiWinType = null;
        } else if (type === 'single-win') {
          winnerIndices = [];
          multiWinType = null;
          showScoreInput = true;
        } else if (type === 'multi-win') {
          winnerIndices = [];
          multiWinType = 'multi';
          multiWinScores = [0, 0, 0, 0];
          multiWinners = [];
          multiWinLoser = null;
          multiWinHanFu = {};
          showScoreInput = true;
        }
        render();
      };
      
      const handleToggleNagashiManganPlayer = (index) => {
        if (nagashiManganPlayers.includes(index)) {
          nagashiManganPlayers = nagashiManganPlayers.filter(i => i !== index);
        } else {
          nagashiManganPlayers = [...nagashiManganPlayers, index];
        }
        render();
      };
      
      const handleToggleTenpai = (index) => {
        if (tenpaiedPlayers.includes(index)) {
          tenpaiedPlayers = tenpaiedPlayers.filter(i => i !== index);
          drawRiichiPlayers = drawRiichiPlayers.filter(i => i !== index);
        } else {
          tenpaiedPlayers = [...tenpaiedPlayers, index];
        }
        render();
      };
      
      const handleToggleDrawRiichi = (index) => {
        if (players[index].isRiichi) return;
        if (!tenpaiedPlayers.includes(index)) return;
        
        if (drawRiichiPlayers.includes(index)) {
          drawRiichiPlayers = drawRiichiPlayers.filter(i => i !== index);
        } else {
          drawRiichiPlayers = [...drawRiichiPlayers, index];
        }
        render();
      };
      
      const handleToggleMultiWinner = (index) => {
        const idx = multiWinners.indexOf(index);
        
        if (idx > -1) {
          multiWinners = multiWinners.filter(i => i !== index);
          delete multiWinHanFu[index];
        } else {
          if (multiWinners.length < 3) {
            multiWinners = [...multiWinners, index];
            multiWinHanFu[index] = { han: 1, fu: 30 };
          }
        }
        
        if (multiWinLoser === index) {
          multiWinLoser = null;
        }
        
        render();
      };
      
      const handleSetMultiWinnerHan = (winnerIdx, han) => {
        if (multiWinHanFu[winnerIdx]) {
          multiWinHanFu[winnerIdx].han = han;
          render();
        }
      };
      
      const handleSetMultiWinnerFu = (winnerIdx, fu) => {
        if (multiWinHanFu[winnerIdx]) {
          multiWinHanFu[winnerIdx].fu = fu;
          render();
        }
      };
      
      const handleSetTsumo = (value) => {
        isTsumo = value;
        if (isTsumo) {
          loserIndex = null;
          isHoutei = false;
          isChankan = false;
          isRenhou = false;
        } else {
          isTenhou = false;
          isChiihou = false;
          isHaitei = false;
          isRinshan = false;
        }
        render();
      };
      
      const handleSetWinner = (index) => {
        winnerIndex = index;
        if (winnerIndex === loserIndex) loserIndex = null;
        
        const hasMinFuro = hasMinimalFuro();
        isMenzen = !hasMinFuro;
        
        if (winnerIndex !== null && players[winnerIndex].isRiichi && !hasMinFuro) {
          isRiichi = true;
          isDoubleRiichi = false;
        } else {
          isRiichi = false;
          isDoubleRiichi = false;
        }
        
        // æ¸…ç©ºå¬ç‰Œç¼“å­˜
        cachedTenpaiState = null;
        
        render();
      };
      
      const handleTogglePlayerRiichi = (index) => {
        const wasRiichi = players[index].isRiichi;
        const hasMinFuro = hasMinimalFuro();
        const isWinner = index === winnerIndex;
        
        if (isWinner && hasMinFuro && !wasRiichi) {
          return;
        }
        
        players[index].isRiichi = !players[index].isRiichi;
        
        if (!wasRiichi && players[index].isRiichi) {
          players[index].score -= 1000;
          gameState.riichiSticks += 1;
        } else if (wasRiichi && !players[index].isRiichi) {
          players[index].score += 1000;
          gameState.riichiSticks = Math.max(0, gameState.riichiSticks - 1);
        }
        
        if (isWinner) {
          isMenzen = !hasMinFuro;
          
          if (!hasMinFuro && players[index].isRiichi) {
            isRiichi = true;
            isDoubleRiichi = false;
          } else {
            isRiichi = false;
            isDoubleRiichi = false;
          }
        }
        
        render();
      };
      
      const handleTileClick = (tile) => {
        if (activeTileArea === 'hand') {
          const requiredCount = getRequiredHandTileCount();
          if (selectedTiles.length < requiredCount) {
            addTile(tile);
          } else {
            winTile = tile;
            activeTileArea = 'win';
            render();
          }
        } else if (activeTileArea === 'meld') {
          if (pendingMeldType) {
            addMeld(pendingMeldType, tile);
          }
        } else if (activeTileArea === 'win') {
          winTile = tile;
          render();
        }
      };
      
      const handleToggleAnalysisMode = (mode) => {
        isManualMode = mode === 'manual';
        isExpertMode = mode === 'expert';
        if (!isManualMode) {
          manualYaku = [];
          isManualFuro = false;
        }
        if (!isExpertMode) {
          expertHan = 1;
          expertFu = 30;
        }
        render();
      };
      
      const handleToggleManualYaku = (yakuId) => {
        if (manualYaku.includes(yakuId)) {
          manualYaku = manualYaku.filter(id => id !== yakuId);
        } else {
          manualYaku.push(yakuId);
        }
        render();
      };
      
      const handleToggleRiichi = () => {
        if (winnerIndex !== null && players[winnerIndex].isRiichi) {
          if (isRiichi) {
            isRiichi = false;
            isDoubleRiichi = true;
          } else if (isDoubleRiichi) {
            isRiichi = true;
            isDoubleRiichi = false;
          } else {
            isRiichi = true;
            isDoubleRiichi = false;
          }
        }
        render();
      };
      
      const handleToggleDoubleRiichi = () => {
        if (winnerIndex !== null && players[winnerIndex].isRiichi) {
          if (isDoubleRiichi) {
            isDoubleRiichi = false;
            isRiichi = true;
          } else if (isRiichi) {
            isDoubleRiichi = true;
            isRiichi = false;
          } else {
            isDoubleRiichi = true;
            isRiichi = false;
          }
        }
        render();
      };
      
      // é€šç”¨çŠ¶å†µå½¹åˆ‡æ¢å‡½æ•°
      const handleToggleYaku = (yakuType) => {
        const yakuStates = {
          tenhou: { var: 'isTenhou', exclusive: ['isChiihou', 'isRenhou'], setTsumo: true, needMenzen: true },
          chiihou: { var: 'isChiihou', exclusive: ['isTenhou', 'isRenhou'], setTsumo: true, needMenzen: true },
          renhou: { var: 'isRenhou', exclusive: ['isTenhou', 'isChiihou'], setTsumo: false, needMenzen: true },
          haitei: { var: 'isHaitei', exclusive: ['isHoutei'], setTsumo: true, needMenzen: false },
          houtei: { var: 'isHoutei', exclusive: ['isHaitei'], setTsumo: false, needMenzen: false },
          rinshan: { var: 'isRinshan', exclusive: ['isChankan'], setTsumo: true, needMenzen: false },
          chankan: { var: 'isChankan', exclusive: ['isRinshan'], setTsumo: false, needMenzen: false }
        };

        const config = yakuStates[yakuType];
        if (!config) return;
        
        if (config.needMenzen && !calculateIsMenzen()) return;

        switch(config.var) {
          case 'isTenhou': isTenhou = !isTenhou; break;
          case 'isChiihou': isChiihou = !isChiihou; break;
          case 'isRenhou': isRenhou = !isRenhou; break;
          case 'isHaitei': isHaitei = !isHaitei; break;
          case 'isHoutei': isHoutei = !isHoutei; break;
          case 'isRinshan': isRinshan = !isRinshan; break;
          case 'isChankan': isChankan = !isChankan; break;
        }

        const isActive = eval(config.var);
        
        if (isActive) {
          config.exclusive.forEach(exclusiveVar => {
            switch(exclusiveVar) {
              case 'isTenhou': isTenhou = false; break;
              case 'isChiihou': isChiihou = false; break;
              case 'isRenhou': isRenhou = false; break;
              case 'isHaitei': isHaitei = false; break;
              case 'isHoutei': isHoutei = false; break;
              case 'isChankan': isChankan = false; break;
            }
          });
          
          if (config.setTsumo !== undefined) {
            isTsumo = config.setTsumo;
          }
        }
        
        render();
      };
      
      const handleToggleTenhou = () => handleToggleYaku('tenhou');
      const handleToggleChiihou = () => handleToggleYaku('chiihou');
      const handleToggleRenhou = () => handleToggleYaku('renhou');
      const handleToggleHaitei = () => handleToggleYaku('haitei');
      const handleToggleHoutei = () => handleToggleYaku('houtei');
      const handleToggleRinshan = () => handleToggleYaku('rinshan');
      const handleToggleChankan = () => handleToggleYaku('chankan');
      
      const handleChangeDora = (type, amount, max) => {
        if (type === 'uraDora') {
          if (isManualMode || isExpertMode) {
            max = 12;
          } else {
            max = (isRiichi || isDoubleRiichi) ? 12 : 0;
          }
        }
        
        if (type === 'redDora') {
          const redDoraInfo = calculateRedDoraInfo();
          max = redDoraInfo.maxRedDora;
        }
        
        if (type === 'dora') dora = Math.max(0, Math.min(max, dora + amount));
        if (type === 'uraDora') uraDora = Math.max(0, Math.min(max, uraDora + amount));
        if (type === 'redDora') redDora = Math.max(0, Math.min(max, redDora + amount));
        render();
      };

      // ===================================================================
      // 7. INITIAL RENDER
      // ===================================================================
      
      // åˆå§‹åŒ–å‡½æ•°
      const initialize = () => {
        // å°è¯•ä» localStorage åŠ è½½ä¿å­˜çš„æ¸¸æˆçŠ¶æ€
        const hasLoadedState = loadGameState();
        
        // if (hasLoadedState) {
        //   console.log('âœ… å·²æ¢å¤ä¸Šæ¬¡æ¸¸æˆè¿›åº¦');
        // } else {
        //   console.log('ğŸ†• å¼€å§‹æ–°æ¸¸æˆ');
        // }
        
        render();
      };
      
      // ç­‰å¾… Lucide åº“åŠ è½½å®Œæˆåå†åˆå§‹åŒ–
      if (typeof lucide !== 'undefined') {
        // Lucide å·²åŠ è½½ï¼Œç›´æ¥åˆå§‹åŒ–
        initialize();
      } else {
        // Lucide è¿˜æœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½å®Œæˆ
        window.addEventListener('load', initialize);
      }

    });
  </script>

</body>
</html>