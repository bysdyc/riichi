# 刷新保留对局数据功能 💾

## 实现日期: 2025年10月28日

---

## 🎯 功能说明

添加了**自动保存**功能,使得浏览器刷新后当前对局数据仍然保留,可以继续游戏。

---

## ✨ 主要特性

### 1. 自动保存 🔄
- **保存时机**: 每次游戏状态变化时自动保存
- **保存位置**: 浏览器 localStorage (本地存储)
- **保存内容**: 完整的游戏状态,包括:
  - 游戏设置 (东风战/半庄战/全庄战)
  - 玩家信息 (姓名、分数、风位、立直状态)
  - 游戏状态 (风位、局数、本场数、立直棒)
  - 对局历史记录
  - 当前输入状态 (和牌、流局等界面)
  - 所有临时状态 (役种选择、番符等)

### 2. 自动恢复 🔄
- **恢复时机**: 页面加载/刷新时自动检测并恢复
- **恢复内容**: 完整恢复到上次保存的状态
- **恢复提示**: 控制台显示恢复状态

### 3. 智能提示 💡
- **开始界面**: 如果有保存的进度,显示蓝色提示框
  - "继续游戏" 按钮: 恢复并继续上次游戏
  - "清除进度" 按钮: 删除保存的数据,开始新游戏
- **游戏界面**: 显示"自动保存已开启"绿色提示

### 4. 手动清除 🗑️
- **重置游戏**: 点击"重置"按钮自动清除保存的数据
- **清除进度**: 开始界面可手动清除保存的进度

---

## 🔧 技术实现

### 核心函数

#### 1. saveGameState()
```javascript
// 保存游戏状态到 localStorage
const saveGameState = () => {
  try {
    const state = {
      gameSettings,
      isGameOver,
      players,
      gameState,
      currentDealerIndex,
      roundHistory,
      // ... 所有其他状态
      savedAt: new Date().toISOString()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (error) {
    console.error('保存游戏状态失败:', error);
  }
};
```

#### 2. loadGameState()
```javascript
// 从 localStorage 加载游戏状态
const loadGameState = () => {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return false;

    const state = JSON.parse(saved);
    
    // 恢复所有状态
    gameSettings = state.gameSettings;
    players = state.players || players;
    gameState = state.gameState || gameState;
    // ... 恢复所有其他状态
    
    console.log('游戏状态已恢复 (保存时间:', state.savedAt, ')');
    return true;
  } catch (error) {
    console.error('加载游戏状态失败:', error);
    return false;
  }
};
```

#### 3. clearGameState()
```javascript
// 清除保存的游戏状态
const clearGameState = () => {
  try {
    localStorage.removeItem(STORAGE_KEY);
    console.log('游戏状态已清除');
  } catch (error) {
    console.error('清除游戏状态失败:', error);
  }
};
```

### 集成点

#### 1. 自动保存 (render 函数)
```javascript
const render = () => {
  // ... 渲染界面
  
  // 自动保存游戏状态 (仅在游戏已开始时)
  if (gameSettings) {
    saveGameState();
  }
};
```

#### 2. 自动恢复 (初始化)
```javascript
// 尝试从 localStorage 加载保存的游戏状态
const hasLoadedState = loadGameState();

if (hasLoadedState) {
  console.log('✅ 已恢复上次游戏进度');
} else {
  console.log('🆕 开始新游戏');
}

render();
```

#### 3. 清除保存 (重置游戏)
```javascript
const resetGame = () => {
  // 清除保存的游戏状态
  clearGameState();
  
  // 重置所有状态
  gameSettings = null;
  players = [...];
  // ...
  
  render();
};
```

---

## 📋 保存的数据结构

```javascript
{
  // 游戏设置
  "gameSettings": {
    "type": "hanchan",  // tonpuu | hanchan | yonchan
    "tobu": true        // 是否开启击飞
  },
  
  // 游戏状态
  "gameState": {
    "wind": "south",    // 场风: east | south | west | north
    "round": 3,         // 局数: 1-4
    "honba": 1,         // 本场数
    "riichiSticks": 2   // 立直棒数量
  },
  
  // 玩家数据
  "players": [
    {
      "id": 1,
      "name": "东家",
      "score": 28000,
      "wind": "東",
      "isRiichi": false
    },
    // ... 其他3位玩家
  ],
  
  // 庄家索引
  "currentDealerIndex": 2,
  
  // 对局历史
  "roundHistory": [
    {
      "round": "东1局 0本场",
      "dealer": "东家",
      "winner": "南家",
      "type": "荣和",
      "yaku": "立直 平和 断幺九 (宝2+里1+赤0)",
      "han": 4,
      "fu": 30,
      "score": 7900,
      // ...
    }
    // ... 更多历史记录
  ],
  
  // UI状态
  "showScoreInput": false,
  "showHistory": false,
  "showRoundTypeDialog": false,
  "showDrawDialog": false,
  
  // 和牌状态
  "winnerIndex": null,
  "winnerIndices": [],
  "loserIndex": null,
  "isTsumo": true,
  
  // 役种分析状态
  "isManualMode": false,
  "isExpertMode": false,
  "manualYaku": [],
  "expertHan": 1,
  "expertFu": 30,
  
  // 宝牌
  "dora": 0,
  "uraDora": 0,
  "redDora": 0,
  
  // 多人和牌状态
  "multiWinType": null,
  "multiWinnerDetails": {},
  
  // 流局状态
  "tenpaiedPlayers": [],
  "drawRiichiPlayers": [],
  "isStartingHandDraw": false,
  
  // 保存时间戳
  "savedAt": "2025-10-28T10:30:45.123Z"
}
```

---

## 🎮 使用场景

### 场景1: 正常游戏过程中刷新

```
1. 正在进行半庄战,南3局2本场
2. 不小心点击了浏览器刷新 (F5)
3. 页面重新加载
4. ✅ 自动恢复到南3局2本场
5. 所有玩家分数、立直状态都保留
6. 可以继续游戏
```

### 场景2: 输入和牌数据时关闭浏览器

```
1. 正在输入和牌信息:
   - 已选择和牌者: 东家
   - 已选择役种: 立直、平和、断幺九
   - 已设置宝牌: Dora 2, 里Dora 1
2. 浏览器意外关闭
3. 重新打开页面
4. ✅ 所有输入的数据都保留
5. 点击"确认结算"即可继续
```

### 场景3: 多天进行一局游戏

```
1. 周一开始一局全庄战
2. 打到西2局,关闭浏览器
3. 周三再次打开页面
4. ✅ 看到"发现保存的进度"提示
5. 点击"继续游戏"
6. 从西2局继续游戏
```

### 场景4: 想要重新开始

```
1. 开始界面看到"发现保存的进度"
2. 不想继续,想重新开始
3. 点击"清除进度"按钮
4. 确认对话框 → 确定
5. ✅ 保存的数据被清除
6. 可以开始新游戏
```

---

## ⚠️ 注意事项

### 1. 浏览器兼容性
- **支持**: 所有现代浏览器 (Chrome, Firefox, Safari, Edge)
- **localStorage 大小限制**: 通常 5-10MB (足够存储游戏数据)
- **隐私模式**: 部分浏览器的隐私模式可能禁用 localStorage

### 2. 数据安全
- ✅ 数据仅保存在本地浏览器,不上传到服务器
- ✅ 更换浏览器或清除浏览器数据会丢失
- ⚠️ 不同浏览器之间数据不共享
- ⚠️ 清除浏览器缓存可能会删除保存的数据

### 3. 多标签页
- ⚠️ 在多个标签页同时打开可能导致数据覆盖
- 建议: 仅在一个标签页中进行游戏

### 4. 长期保存
- ✅ 数据会永久保存,除非手动清除或清除浏览器数据
- ✅ 关机、重启都不会丢失数据
- ⚠️ 更换电脑需要重新开始

---

## 🔍 调试信息

### 控制台输出

**页面加载时 (有保存数据)**:
```
游戏状态已恢复 (保存时间: 2025-10-28T10:30:45.123Z)
✅ 已恢复上次游戏进度
```

**页面加载时 (无保存数据)**:
```
🆕 开始新游戏
```

**清除进度时**:
```
游戏状态已清除
```

**保存失败时**:
```
保存游戏状态失败: [错误信息]
```

---

## 📊 代码统计

- **新增函数**: 3个 (saveGameState, loadGameState, clearGameState)
- **修改函数**: 3个 (render, resetGame, getStartScreenHTML)
- **新增事件监听**: 2个 (continue-game, clear-saved-game)
- **总计代码**: ~150行

---

## ✅ 测试建议

### 测试1: 基本刷新
1. 开始一局游戏,进行几局
2. 按 F5 刷新页面
3. 验证游戏状态是否恢复

### 测试2: 输入状态保留
1. 打开和牌界面,输入一些数据
2. 刷新页面
3. 验证输入的数据是否保留

### 测试3: 历史记录保留
1. 完成几局,查看历史记录
2. 关闭浏览器,重新打开
3. 验证历史记录是否完整

### 测试4: 清除功能
1. 有保存数据时,点击"清除进度"
2. 验证提示框是否出现
3. 确认后验证数据是否被清除

### 测试5: 重置功能
1. 游戏中点击"重置"
2. 刷新页面
3. 验证是否回到开始界面(无保存数据提示)

---

## 🎉 总结

### 优势
✅ **无需手动保存**: 全自动,零操作  
✅ **防止数据丢失**: 刷新、关闭都不怕  
✅ **跨会话保存**: 可以跨天继续游戏  
✅ **完整状态保存**: 包括所有临时输入  
✅ **用户友好**: 清晰的提示和操作

### 用户体验提升
- 不再担心误点刷新
- 可以随时暂停,随时继续
- 长时间游戏更加安全
- 输入数据不会丢失

---

**实现人员**: GitHub Copilot  
**实现日期**: 2025年10月28日  
**实现状态**: ✅ 完成  
**测试状态**: 待测试
