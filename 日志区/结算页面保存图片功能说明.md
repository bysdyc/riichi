# 结算页面保存图片功能说明

## 功能概述
在游戏结束的结算页面新增"保存图片"功能，允许用户将对局结果保存为图片分享。

## 实现内容

### 1. UI 改动
**文件：** `components/game-over-dialog/index.wxml`

- 在对话框底部操作区新增"保存图片"按钮
- 添加隐藏的 Canvas 2D 画布（`#gameOverCanvas`）用于图片生成
- 按钮布局：查看历史 | 保存图片 | 关闭

### 2. 功能实现
**文件：** `components/game-over-dialog/index.js`

#### 新增方法：

**`onSaveImage()`**
- 触发图片生成流程
- 显示"生成图片中..."加载提示
- 初始化 Canvas 2D 画布
- 调用绘制方法生成图片
- 保存到相册

**`calculateImageHeight()`**
- 根据内容动态计算图片高度
- 包含：标题区、排名列表、对局统计、详细数据、底部信息
- 最大高度限制：3000px

**`drawContent(ctx, x, y, maxWidth)`**
- 绘制完整的结算内容
- 包含以下部分：
  - 🎊 对局结束（标题）
  - 最终排名（显示奖牌、玩家名、分数、分差）
  - 对局统计（类型、总局数、最终场次、本场数）
  - 详细数据（每个玩家的和牌、放铳、立直次数）
  - 底部时间戳

**`roundRect(ctx, x, y, width, height, radius)`**
- 绘制圆角矩形的辅助方法
- 用于绘制卡片背景

**`saveImageToAlbum(tempFilePath)`**
- 保存图片到相册
- 处理权限授权请求
- 显示成功/失败提示

### 3. 图片样式设计

#### 画布规格
- 宽度：750px
- 高度：根据内容动态计算（最大 3000px）
- DPI：使用设备像素比（pixelRatio）

#### 视觉效果
- 背景色：#f5f5f5（浅灰）
- 卡片背景：白色带阴影（10px 模糊，2px 偏移）
- 圆角：10px
- 内边距：20px

#### 内容布局
1. **标题区**
   - 字体：36px 粗体
   - 颜色：#1a1a1a
   - 图标：🎊

2. **排名列表**
   - 奖牌：🥇 🥈 🥉 4️⃣
   - 玩家名：26px 粗体
   - 分数：28px 粗体
   - 分差：24px，绿色（正）/ 红色（负）

3. **对局统计**
   - 标题：28px 粗体
   - 内容：24px，灰色（#666666）

4. **详细数据**
   - 玩家名：26px 粗体
   - 统计数字：22px，灰色（#888888）

5. **底部时间**
   - 字体：20px
   - 颜色：#999999

## 使用流程

1. 用户完成对局，触发结算页面
2. 点击"保存图片"按钮
3. 系统生成图片（显示加载动画）
4. 自动保存到相册
5. 显示"已保存到相册"提示

## 权限处理

- 首次保存需要用户授权"保存到相册"权限
- 如果用户拒绝授权，弹窗引导用户去设置页面授权
- 授权后可正常保存

## 技术要点

1. **Canvas 2D API**：使用新版 Canvas 2D 接口，性能更好
2. **高 DPI 适配**：使用设备像素比进行缩放，确保清晰度
3. **隐藏画布**：Canvas 通过 CSS 定位到屏幕外，不影响 UI
4. **动态高度**：根据实际内容计算图片高度，避免空白或截断
5. **权限管理**：妥善处理相册权限的授权流程

## 注意事项

1. 画布位置设置为 `position: fixed; left: -9999px`，确保不可见
2. 图片生成是异步操作，需要显示加载提示
3. 文本绘制需要手动计算位置和间距
4. 需要在 `project.config.json` 中配置相册权限（已配置）

## 后续优化建议

1. 可增加"分享给朋友"功能（类似导出预览页面）
2. 可添加图片样式选项（如主题切换）
3. 可添加二维码或水印

---

**修改日期：** 2025年10月31日
**状态：** ✅ 已完成
