# 副露区删除功能与立直限制说明

## 功能1：针对某一组副露进行删除 ✅

### 功能描述
用户可以单独删除副露区中的任意一组副露，而不影响其他副露组。

### 实现方式

#### UI展示
每个副露组都有一个独立的删除按钮（×）：

```html
<div class="inline-flex items-center bg-white rounded-lg border-2 border-indigo-300 p-1">
  <div class="flex gap-0.5 mr-1">
    <!-- 显示副露的牌 -->
    <span class="px-1.5 py-0.5 text-xs font-bold">1万</span>
    <span class="px-1.5 py-0.5 text-xs font-bold">2万</span>
    <span class="px-1.5 py-0.5 text-xs font-bold">3万</span>
  </div>
  <span class="text-xs text-indigo-600 mr-1">顺</span>
  <button
    data-action="remove-meld"
    data-index="0"
    class="text-red-500 hover:text-red-700 p-0.5"
  >
    <i data-lucide="x" class="w-3 h-3"></i>
  </button>
</div>
```

#### 删除逻辑

```javascript
const removeMeld = (index) => {
  melds = melds.filter((_, i) => i !== index);
  
  // 如果删除所有副露，可以恢复门前状态
  if (melds.length === 0 || melds.every(m => m.type === 'ankan')) {
    isMenzen = true;
  }
  
  render();
};
```

#### 事件绑定

```javascript
document.querySelectorAll('[data-action="remove-meld"]').forEach(btn => {
  btn.addEventListener('click', () => removeMeld(parseInt(btn.dataset.index, 10)));
});
```

### 删除后的影响

1. **手牌上限调整**
   - 删除副露后，手牌上限会相应增加
   - 例如：删除1个刻子（3张）→ 手牌上限 +3

2. **门前状态恢复**
   - 如果删除后没有明副露（顺子/刻子/明杠）
   - 只剩暗杠或没有副露时，自动恢复门前状态

3. **立直状态**
   - 如果恢复门前状态，立直按钮会重新启用
   - 但已经立直的状态不会自动恢复

### 使用示例

#### 场景1：删除单个副露
```
初始状态：
- 副露：[顺子1-2-3万, 刻子东东东]
- 手牌上限：7张 (13 - 6)

点击删除"顺子1-2-3万"后：
- 副露：[刻子东东东]
- 手牌上限：10张 (13 - 3)
- 门前状态：否（还有明刻）
```

#### 场景2：删除所有明副露
```
初始状态：
- 副露：[刻子东东东]
- 手牌上限：10张
- 门前状态：否

点击删除"刻子东东东"后：
- 副露：[]
- 手牌上限：13张
- 门前状态：是 ✓
- 立直按钮：启用 ✓
```

#### 场景3：只剩暗杠
```
初始状态：
- 副露：[明杠1万, 暗杠东]
- 手牌上限：7张 (15 - 8)
- 门前状态：否

删除"明杠1万"后：
- 副露：[暗杠东]
- 手牌上限：10张 (14 - 4)
- 门前状态：是 ✓（暗杠不影响门前）
- 立直按钮：启用 ✓
```

---

## 功能2：有副露时不能立直 ✅

### 功能描述
当副露区存在明副露（顺子/刻子/明杠）时，禁止玩家立直。这符合日本麻将的基本规则：立直必须门前清。

### 实现方式

#### 1. 状况役立直按钮禁用

```html
<button
  data-action="toggle-riichi"
  ${!isMenzen || melds.some(m => m.type === 'shuntsu' || m.type === 'pon' || m.type === 'minkan') || ... ? 'disabled' : ''}
  class="... ${... ? 'opacity-50 cursor-not-allowed' : ''}"
>
  立直 (+1番) ${melds.some(...) ? '(有副露)' : ''}
</button>
```

**禁用条件：**
- `!isMenzen`：不是门前清
- `melds.some(m => m.type === 'shuntsu' || m.type === 'pon' || m.type === 'minkan')`：有明副露

**UI反馈：**
- 按钮变灰（`opacity-50`）
- 鼠标悬停显示"不可点击"（`cursor-not-allowed`）
- 显示"(有副露)"提示

#### 2. 双立直按钮同步禁用

```html
<button
  data-action="toggle-double-riichi"
  ${!isMenzen || melds.some(m => m.type === 'shuntsu' || m.type === 'pon' || m.type === 'minkan') || ... ? 'disabled' : ''}
  class="... ${... ? 'opacity-50 cursor-not-allowed' : ''}"
>
  双立直 (+2番) ${melds.some(...) ? '(有副露)' : ''}
</button>
```

#### 3. 玩家立直按钮禁用与提示

```html
<label class="block text-sm font-bold mb-2">
  立直玩家 (和牌前扣除1000点，和牌者获得所有立直棒)
  ${melds.some(...) ? '<span class="text-red-600 text-xs">（有明副露，不可立直）</span>' : ''}
</label>

<div class="grid grid-cols-4 gap-2">
  ${players.map((player, idx) => {
    const hasMingMeld = melds.some(m => m.type === 'shuntsu' || m.type === 'pon' || m.type === 'minkan');
    return `
    <button
      data-action="toggle-player-riichi"
      data-index="${idx}"
      ${hasMingMeld && !player.isRiichi ? 'disabled' : ''}
      class="... ${hasMingMeld && !player.isRiichi ? 'opacity-50 cursor-not-allowed' : ''}"
    >
      ${player.wind}${player.isRiichi ? ' 立' : ''}
    </button>
  `}).join('')}
</div>
```

**特殊处理：**
- 已经立直的玩家可以取消立直（即使有副露）
- 未立直的玩家在有明副露时不能新立直

#### 4. 事件处理层面的二次验证

```javascript
document.querySelectorAll('[data-action="toggle-player-riichi"]').forEach(btn => {
  btn.addEventListener('click', () => {
    const index = parseInt(btn.dataset.index, 10);
    const wasRiichi = players[index].isRiichi;
    
    // 检查是否有明副露（只在设置立直时检查）
    if (!wasRiichi && melds.some(m => m.type === 'shuntsu' || m.type === 'pon' || m.type === 'minkan')) {
      alert('有明副露时不能立直！');
      return;
    }
    
    // ... 立直逻辑
  });
});
```

**双重保护：**
1. UI层面：按钮禁用，防止误点击
2. 事件层面：即使被点击也会弹出警告并阻止

### 副露类型对立直的影响

| 副露类型 | 是否影响门前 | 是否禁止立直 | 说明 |
|---------|------------|------------|------|
| 顺子 (shuntsu) | ✓ 是 | ✓ 是 | 吃牌，破坏门前 |
| 刻子 (pon) | ✓ 是 | ✓ 是 | 碰牌，破坏门前 |
| 明杠 (minkan) | ✓ 是 | ✓ 是 | 明杠，破坏门前 |
| 暗杠 (ankan) | ✗ 否 | ✗ 否 | 暗杠，保持门前 |

### 使用场景

#### 场景1：先副露后尝试立直
```
操作步骤：
1. 添加1个顺子（1-2-3万）
2. 点击"立直"按钮

结果：
- 立直按钮显示灰色
- 悬停显示"不可点击"
- 按钮文字显示"立直 (+1番) (有副露)"
- 无法点击
```

#### 场景2：先立直后副露
```
操作步骤：
1. 点击某玩家的立直按钮（扣除1000点）
2. 尝试添加副露

结果：
- 副露可以正常添加
- 添加明副露后，isMenzen 自动设为 false
- 立直按钮变灰，显示"(有副露)"
- 但玩家的立直状态保持不变（已经立直了）

说明：这是合理的，因为玩家可能在立直后自摸杠（暗杠）
```

#### 场景3：暗杠不影响立直
```
操作步骤：
1. 添加1个暗杠（东东东东）
2. 点击"立直"按钮

结果：
- 立直按钮正常可用 ✓
- 可以正常立直
- 因为暗杠不破坏门前状态
```

#### 场景4：删除副露后可立直
```
操作步骤：
1. 有1个明刻（东东东）
2. 立直按钮禁用
3. 删除这个明刻
4. 立直按钮重新启用 ✓

结果：
- 副露区清空
- isMenzen = true
- 立直按钮可用
```

### UI视觉反馈

#### 1. 立直按钮状态
```
正常状态：
┌──────────────┐
│ 立直 (+1番)  │  ← 蓝色，可点击
└──────────────┘

有副露状态：
┌──────────────────┐
│ 立直(+1番)(有副露) │  ← 灰色，禁用
└──────────────────┘
```

#### 2. 玩家立直按钮
```
正常状态：
┌────┐ ┌────┐ ┌────┐ ┌────┐
│ 東 │ │ 南 │ │ 西 │ │ 北 │  ← 灰色，可点击
└────┘ └────┘ └────┘ └────┘

有副露状态：
立直玩家 (和牌前扣除1000点，和牌者获得所有立直棒) (有明副露，不可立直)  ← 红色提示
┌────┐ ┌────┐ ┌────┐ ┌────┐
│ 東 │ │ 南 │ │ 西 │ │ 北 │  ← 灰色，禁用，不可点击
└────┘ └────┘ └────┘ └────┘

已立直状态：
┌────┐ ┌────┐ ┌────┐ ┌────┐
│東 立│ │ 南 │ │ 西 │ │ 北 │  ← 黄色（已立直），可点击取消
└────┘ └────┘ └────┘ └────┘
```

### 错误提示

当用户尝试在有明副露时立直，会看到：

```
┌─────────────────────────────┐
│  ⚠️  有明副露时不能立直！      │
│                              │
│          [ 确定 ]             │
└─────────────────────────────┘
```

### 测试清单

#### 基础功能测试
- [ ] 添加顺子后，立直按钮禁用
- [ ] 添加刻子后，立直按钮禁用
- [ ] 添加明杠后，立直按钮禁用
- [ ] 添加暗杠后，立直按钮仍可用
- [ ] 删除明副露后，立直按钮启用

#### 玩家立直测试
- [ ] 有明副露时，玩家立直按钮禁用
- [ ] 点击禁用的立直按钮显示警告
- [ ] 已立直的玩家可以取消立直
- [ ] 暗杠不影响玩家立直

#### 组合测试
- [ ] 顺子+刻子：立直禁用
- [ ] 暗杠+明杠：立直禁用（因为有明杠）
- [ ] 只有暗杠：立直可用
- [ ] 删除所有明副露：立直恢复

#### 状态同步测试
- [ ] 添加明副露时，isMenzen 自动设为 false
- [ ] isMenzen = false 时，立直禁用
- [ ] 删除明副露后，isMenzen 恢复 true
- [ ] 双立直按钮与立直按钮同步禁用

#### UI测试
- [ ] 立直按钮显示"(有副露)"提示
- [ ] 玩家立直区显示红色提示文字
- [ ] 禁用的按钮显示灰色
- [ ] 鼠标悬停显示"不可点击"样式

### 注意事项

1. **已立直玩家**
   - 已经立直的玩家不受副露影响
   - 可以继续添加暗杠
   - 可以取消立直状态

2. **门前状态**
   - 暗杠不影响门前状态
   - 明副露（顺子/刻子/明杠）破坏门前
   - 删除所有明副露可恢复门前

3. **双重验证**
   - UI层面禁用（用户友好）
   - 事件层面验证（安全保障）

4. **与其他功能的联动**
   - 立直禁用时，一发也自动禁用
   - 双立直与立直互斥
   - 立直需要玩家已经在立直列表中

### 后续优化建议

1. **视觉优化**
   - 使用工具提示（tooltip）显示禁用原因
   - 添加图标提示（如🔒表示禁用）

2. **用户引导**
   - 首次遇到时显示帮助提示
   - 添加"为什么不能立直？"的说明链接

3. **智能提示**
   - 当用户添加明副露时，自动提示"已取消门前状态，不可立直"
   - 删除明副露时提示"已恢复门前状态，可以立直"

4. **规则验证**
   - 在听牌分析中也考虑副露对立直的影响
   - 自动检测不合法的立直状态组合
