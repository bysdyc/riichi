# 弹窗和交互优化说明

## 修改日期
2025年10月31日

## 优化需求

### 1. 三个模式弹窗的标题在滑动时固定

#### 问题
当弹窗内容较多需要滚动时，标题也会跟随滚动消失，用户不清楚当前在哪个弹窗中。

#### 解决方案
将标题从 `scroll-view` 内移出，设置为固定位置。

#### 实现细节

**单人和牌弹窗 (index.wxml)**
```xml
<view class="panel-shell" catchtap="noop">
  <!-- 标题固定在外层 -->
  <view class="panel-header panel-header-fixed">
    <text class="panel-title">单人和牌结算</text>
    <button bindtap="onCloseSingleWin">×</button>
  </view>
  <!-- 内容可滚动 -->
  <scroll-view class="panel-scroll" scroll-y="true">
    <view class="result-panel card">
      <!-- 内容区域 -->
    </view>
  </scroll-view>
</view>
```

**多人和牌弹窗** - 同样的结构

**流局对话框 (draw-dialog/index.wxml)**
```xml
<view class="dialog-card" catchtap="noop">
  <!-- 标题固定 -->
  <view class="dialog-header dialog-header-fixed">
    <text class="dialog-title">流局结算</text>
    <button bindtap="onCancel">×</button>
  </view>
  <!-- 内容可滚动 -->
  <scroll-view class="dialog-scroll dialog-scroll-with-header">
    <!-- 内容区域 -->
  </scroll-view>
</view>
```

**CSS 样式 (index.wxss)**
```css
.panel-shell {
  display: flex;
  flex-direction: column;  /* 垂直布局 */
}

.panel-header-fixed {
  position: sticky;
  top: 0;
  z-index: 100;
  background: #ffffff;
  border-radius: 18rpx 18rpx 0 0;
  box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.08);
  flex-shrink: 0;  /* 不收缩 */
}

.panel-scroll {
  flex: 1;  /* 占据剩余空间 */
  overflow-y: auto;  /* 内容可滚动 */
}
```

### 2. 不能对宝牌增删

#### 问题
用户可以通过 +/- 按钮修改宝牌数量，但宝牌应该是自动计算的，不应该允许手动修改。

#### 解决方案
移除宝牌计数器的 +/- 按钮，只显示当前值和最大值。

#### 实现细节

**组件模板 (dora-counter/index.wxml)**
```xml
<view class="dora-counter">
  <text class="label">{{label}}</text>
  <view class="controls">
    <!-- 移除了 +/- 按钮，只显示数值 -->
    <view class="value-badge value-badge-readonly">
      <text class="value">{{value}}</text>
      <text class="max-hint" wx:if="{{max > 0}}">/ {{max}}</text>
      <text class="max-hint" wx:elif="{{max === 0}}">已锁定</text>
    </view>
  </view>
</view>
```

**样式优化 (dora-counter/index.wxss)**
```css
.value-badge-readonly {
  min-width: 140rpx;
  flex: 1;
  /* 使用渐变色表示只读状态 */
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 2rpx solid #0ea5e9;
}
```

**视觉效果**
- 显示格式：`3 / 12`（当前值 / 最大值）
- 锁定状态：`0 已锁定`（立直前里宝牌不可用）
- 渐变蓝色背景，表示只读状态
- 居中显示，占满整行

### 3. 关闭弹窗时保留已输入内容

#### 问题
用户在弹窗中输入了一些数据后，不小心点击了关闭或返回按钮，所有输入的数据都会丢失，需要重新输入。

#### 解决方案
关闭弹窗时只隐藏界面，不清空数据；只在开始新的结算或确认结算后才清空数据。

#### 实现细节

**关闭函数 (index.js)**

修改前：
```javascript
onCloseSingleWin() {
  this.setData({
    showSingleWinPanel: false,
    // 清空所有数据...
    singleWinHandTiles: [],
    singleWinWinTile: null,
    // ...
  });
}
```

修改后：
```javascript
onCloseSingleWin() {
  // 只关闭弹窗，保留已输入的数据
  this.setData({ 
    showSingleWinPanel: false 
  });
}

onCloseMultiWin() {
  // 只关闭弹窗，保留已输入的数据
  this.setData({ 
    showMultiWinPanel: false 
  });
}

onDrawCancel() {
  // 只关闭对话框，保留已输入的数据
  this.setData({ 
    showDrawDialog: false 
  });
}
```

**数据清空时机**

数据会在以下两种情况下清空：

1. **开始新的结算** (`onStartSingleWin()`, `onStartMultiWin()`, `onStartDraw()`)
   - 重置所有表单数据为默认值
   - 适用于开始新一轮结算

2. **确认结算完成** (`onSingleWinConfirm()`, `onMultiWinConfirm()`, `onDrawConfirm()`)
   - 保存结算记录
   - 更新玩家分数
   - 进入下一局
   - 重置所有表单数据

#### 用户体验改进

**场景1：误操作关闭**
- 用户输入了大量数据
- 不小心点击了关闭按钮
- 重新打开弹窗时，数据还在 ✅

**场景2：临时查看历史**
- 用户正在输入结算数据
- 想查看历史记录
- 关闭弹窗查看历史后
- 重新打开，数据保留 ✅

**场景3：多次调整**
- 用户第一次输入可能有误
- 关闭后发现需要修改
- 重新打开可以继续编辑 ✅

**场景4：正常流程**
- 点击"开始结算"按钮
- 输入完整数据
- 点击"确认结算"
- 数据保存，表单重置为下一局 ✅

## 技术要点

### 1. CSS Position Sticky
使用 `position: sticky` 实现标题固定，比 `position: fixed` 更优雅：
- 在容器内固定
- 不脱离文档流
- 自动处理边界

### 2. Flexbox 布局
使用 flex 布局实现标题固定 + 内容滚动：
```css
.panel-shell {
  display: flex;
  flex-direction: column;
}
.panel-header-fixed {
  flex-shrink: 0;  /* 固定高度 */
}
.panel-scroll {
  flex: 1;  /* 占据剩余空间 */
  overflow-y: auto;
}
```

### 3. 状态管理
- **UI 状态**：只控制显示/隐藏（`showSingleWinPanel`）
- **数据状态**：独立管理，不随 UI 状态清空
- **清空时机**：明确定义在开始和确认两个节点

## 用户反馈

### 标题固定
- ✅ 滚动时始终知道当前在哪个弹窗
- ✅ 关闭按钮始终可见，方便退出
- ✅ 视觉层次更清晰

### 宝牌只读
- ✅ 避免误操作修改宝牌数量
- ✅ 清晰显示当前值和最大值
- ✅ 渐变色表示只读状态

### 数据保留
- ✅ 不担心误操作丢失数据
- ✅ 可以随时查看历史或暂停
- ✅ 支持多次编辑调整
- ✅ 减少重复输入的烦恼

## 兼容性

- ✅ 微信小程序
- ✅ iOS 和 Android
- ✅ 各种屏幕尺寸
- ✅ 不同内容长度

## 总结

这三个优化都是从用户体验出发：
1. **标题固定** - 让用户始终知道自己在哪里
2. **宝牌只读** - 防止误操作，数据更准确
3. **数据保留** - 容错性更好，操作更灵活

所有改动都是微调，不影响现有功能，只是让交互更加友好和合理。
