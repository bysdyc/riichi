# 多人和牌界面改进说明 🎴

## 改进概述

将两人和牌和三人和牌的界面改为与单人和牌界面保持一致,提供更直观的番符输入方式,而非之前的手动分数输入。

---

## 📋 改进对比

### 改进前 (旧版本)

**界面特点:**
- ❌ 手动输入每位玩家的分数变化
- ❌ 需要自己计算点数分配
- ❌ 容易输入错误
- ❌ 总分必须为0,容易出错
- ❌ 无法记录具体役种和番符
- ❌ 历史记录信息不完整

**操作流程:**
```
1. 选择"二人和牌"或"三人和牌"
2. 手动输入每位玩家的分数变化:
   东家: +8000
   南家: +8000
   西家: -16000
   北家: 0
3. 检查总和是否为0
4. 确认
```

---

### 改进后 (新版本)

**界面特点:**
- ✅ 与单人和牌界面统一
- ✅ 自动计算点数分配
- ✅ 输入番符,系统计算
- ✅ 支持自摸/荣和选择
- ✅ 支持立直玩家选择
- ✅ 支持宝牌设置
- ✅ 实时分数预览
- ✅ 历史记录完整

**操作流程:**
```
1. 选择"二人和牌"或"三人和牌"
2. 选择和牌类型(自摸/荣和)
3. 选择和牌者(2人或3人)
4. 如果是荣和,选择放铳者
5. 选择立直玩家(可选)
6. 为每位和牌者输入番数和符数
7. 设置宝牌(可选)
8. 查看分数预览
9. 确认和牌
```

---

## 🎯 新界面结构

### 1. 和牌类型选择
```
[ 自摸 (ツモ) ] [ 荣和 (ロン) ]
     ✓
```
- **自摸**: 极少见,每位和牌者分别自摸
- **荣和**: 常见,多人点炮

### 2. 和牌者选择
```
[ 東 ] [ 南 ] [ 西 ] [ 北 ]
  ✓     ✓
  
已选择: 2 / 2  (二人和牌)
已选择: 3 / 3  (三人和牌)
```

### 3. 放铳者选择 (荣和时)
```
[ 東 ] [ 南 ] [ 西 ] [ 北 ]
           ✓
```
- 和牌者不能选为放铳者
- 放铳者支付所有和牌者的点数

### 4. 立直玩家选择
```
[ 東 ] [ 南 立 ] [ 西 ] [ 北 ]
```
- 点击切换立直状态
- 立直玩家已在之前扣除1000点
- 和牌者平分立直棒

### 5. 番符输入 (核心改进)
```
⚡ 快速输入模式

和牌者 1: 東 - 东家
  番数: [1]   符数: [30]

和牌者 2: 南 - 南家
  番数: [3]   符数: [40]
```
- 每位和牌者独立设置番符
- 支持不同番符组合
- 自动计算总点数

### 6. 宝牌设置
```
Dora:    [-] 0 [+]
里Dora:  [-] 0 [+]
赤Dora:  [-] 0 [+]
```

### 7. 分数预览 (新增)
```
分数计算预览:
東 东家:  +8000
南 南家:  +8000  
西 西家:  -16000
北 北家:  0
```
- 实时显示分数变化
- 自动包含立直棒分配
- 验证计算正确性

---

## 💡 使用示例

### 示例1: 二人点炮 (常见)

**场景:**
- 西家点炮
- 东家和南家同时荣和
- 东家: 3番40符
- 南家: 2番40符
- 场上1根立直棒

**操作步骤:**
1. 选择"二人和牌"
2. 选择"荣和 (ロン)"
3. 点击"東"和"南"为和牌者
4. 点击"西"为放铳者
5. 输入番符:
   - 东家: 3番 40符 → 5200点
   - 南家: 2番 40符 → 2600点
6. 查看预览:
   - 東: +5700点 (5200 + 500立直棒)
   - 南: +3100点 (2600 + 500立直棒)
   - 西: -7800点
   - 北: 0点
7. 确认和牌

**历史记录:**
```
南1局 0本场 | 南家 | 二人荣和
和牌者: 东家 & 南家
役种: 東(3番40符) & 南(2番40符) (宝0+里0+赤0)
点数: 7800点
放铳者: 西家
立直棒: 1000点
```

---

### 示例2: 三人点炮 (罕见)

**场景:**
- 北家点炮
- 东家、南家、西家同时荣和
- 东家: 满贯 (5番40符)
- 南家: 跳满 (6番40符)
- 西家: 倍满 (8番40符)

**操作步骤:**
1. 选择"三人和牌"
2. 选择"荣和 (ロン)"
3. 点击"東"、"南"、"西"为和牌者
4. 点击"北"为放铳者
5. 输入番符:
   - 东家: 5番 40符 → 12000点
   - 南家: 6番 40符 → 18000点
   - 西家: 8番 30符 → 16000点
6. 查看预览:
   - 東: +12000点
   - 南: +18000点
   - 西: +16000点
   - 北: -46000点
7. 确认和牌

---

### 示例3: 二人自摸 (极罕见)

**场景:**
- 东家和南家同时自摸(四杠散了等特殊情况)
- 东家: 3番30符
- 南家: 2番30符

**操作步骤:**
1. 选择"二人和牌"
2. 选择"自摸 (ツモ)"
3. 点击"東"和"南"为和牌者
4. 输入番符:
   - 东家: 3番 30符
   - 南家: 2番 30符
5. 系统自动计算每人向两位和牌者的支付
6. 确认和牌

---

## 🔧 技术实现

### 新增状态变量
```javascript
let multiWinnerDetails = {}; 
// 格式: {
//   winnerIndex: { han: 番数, fu: 符数 }
// }
// 例如: {
//   0: { han: 3, fu: 40 },  // 东家 3番40符
//   1: { han: 2, fu: 40 }   // 南家 2番40符
// }
```

### handleMultiWin 函数重构

**改进前:**
```javascript
// 只检查分数总和是否为0
const totalChange = multiWinScores.reduce((sum, score) => sum + score, 0);
if (totalChange !== 0) {
  alert(`分数总和必须为0！`);
  return;
}
```

**改进后:**
```javascript
// 1. 验证和牌者数量
if (winnerIndices.length !== expectedWinners) {
  alert(`请选择${expectedWinners}位和牌者！`);
  return;
}

// 2. 验证番符信息
for (const wIdx of winnerIndices) {
  if (!multiWinnerDetails[wIdx]) {
    alert(`请为 ${players[wIdx].wind} 输入番数和符数！`);
    return;
  }
}

// 3. 自动计算点数
winnerIndices.forEach(wIdx => {
  const detail = multiWinnerDetails[wIdx];
  const totalHan = detail.han + dora + redDora + uraDora;
  const scoreData = calculateScore(totalHan, detail.fu, ...);
  // 应用分数变化
});
```

### 分数计算逻辑

**自摸模式:**
```javascript
if (isTsumo) {
  // 每位和牌者分别自摸
  winnerScores.forEach(ws => {
    if (isDealerWin) {
      scoreChanges[wIdx] += scoreData.total;
      // 其他玩家各支付 scoreData.each
    } else {
      scoreChanges[wIdx] += scoreData.total;
      scoreChanges[dealerIndex] -= scoreData.dealer;
      // 其他玩家各支付 scoreData.nonDealer
    }
  });
}
```

**荣和模式:**
```javascript
else {
  // 放铳者支付所有和牌者
  winnerScores.forEach(ws => {
    scoreChanges[ws.winnerIndex] += ws.baseScore;
    scoreChanges[loserIndex] -= ws.baseScore;
  });
}
```

### 立直棒分配
```javascript
const riichiBonus = gameState.riichiSticks * 1000;
const bonusPerWinner = Math.floor(riichiBonus / winnerIndices.length);

winnerIndices.forEach(idx => {
  scoreChanges[idx] += bonusPerWinner;
});
```

---

## 📊 历史记录改进

### 改进前
```
南1局 0本场 | 南家 | 二人和牌
和牌者: 东家 & 南家
役种: -
番数: 0
符数: 0
点数: 15800
放铳者: -
```

### 改进后
```
南1局 0本场 | 南家 | 二人荣和
和牌者: 东家 & 南家
役种: 東(5番40符) & 南(3番40符) (宝1+里0+赤0)
番数: 8 (总和)
符数: 0 (多人不统一)
点数: 15800
放铳者: 西家
立直棒: 1000点
```

---

## ✅ 改进优势

### 1. 用户体验
- ✅ 界面统一,学习成本低
- ✅ 输入简单,只需番符
- ✅ 自动计算,不易出错
- ✅ 实时预览,所见即所得

### 2. 功能完整性
- ✅ 支持自摸/荣和
- ✅ 支持立直玩家
- ✅ 支持宝牌设置
- ✅ 完整的历史记录

### 3. 准确性
- ✅ 自动计算点数
- ✅ 自动分配立直棒
- ✅ 自动验证输入
- ✅ 符合日本麻将规则

### 4. 可维护性
- ✅ 代码复用(与单人和牌共享逻辑)
- ✅ 统一的事件处理
- ✅ 清晰的数据结构

---

## 🎮 使用建议

### 何时使用多人和牌

**二人和牌:**
- 两人同时点炮和牌(最常见)
- 双倍役满同时和牌
- 特殊规则下的双重和牌

**三人和牌:**
- 三人同时点炮和牌(罕见)
- 三倍役满同时和牌
- 特殊赛制规则

### 注意事项

1. **番符设置**: 每位和牌者独立设置,可以不同
2. **宝牌处理**: 宝牌对所有和牌者生效
3. **立直棒**: 平均分配给所有和牌者
4. **本场费**: 包含在点数计算中
5. **连庄判定**: 只要有庄家和牌即连庄

---

## 📝 测试清单

### 基础功能测试
- [ ] 选择二人和牌
- [ ] 选择三人和牌
- [ ] 切换自摸/荣和
- [ ] 选择和牌者(数量正确)
- [ ] 选择放铳者(荣和时)
- [ ] 输入番符(每位和牌者)
- [ ] 设置宝牌
- [ ] 查看分数预览
- [ ] 确认和牌

### 边界测试
- [ ] 和牌者数量不足时禁用确认按钮
- [ ] 未输入番符时提示
- [ ] 荣和未选放铳者时提示
- [ ] 和牌者不能选为放铳者

### 计算验证
- [ ] 二人点炮点数正确
- [ ] 三人点炮点数正确
- [ ] 立直棒平均分配
- [ ] 本场费正确计算
- [ ] 宝牌正确添加

---

## 🎉 总结

通过这次改进,多人和牌界面实现了:

1. **统一性**: 与单人和牌界面完全一致
2. **易用性**: 输入番符即可,无需计算分数
3. **准确性**: 自动计算,避免人为错误
4. **完整性**: 支持所有必要功能
5. **可维护性**: 代码复用,结构清晰

现在用户可以用同样的方式处理单人和多人和牌,大大提升了使用体验!

---

**更新版本**: v1.5  
**更新日期**: 2025年10月28日  
**改进类型**: 界面重构 + 功能增强  
**影响范围**: 二人和牌、三人和牌界面及逻辑
