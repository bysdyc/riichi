# 副露区听牌分析修复说明

## 🐛 问题描述

**现象：** 有副露的情况下，听牌分析区显示错误

## 🔍 问题根因

### 核心问题：门前状态(isMenzen)计算错误

在 `updateDetailedTenpaiWaits()` 和 `getCurrentAnalysis()` 函数中，直接使用了全局变量 `isMenzen` 来判断门前状态。

**问题场景：**
1. 用户添加了副露（例如：顺子 1-2-3万）
2. `addMeld()` 正确地设置了 `isMenzen = false`
3. 但是，如果用户之后删除了所有副露，`isMenzen` 会重新变为 `true`
4. 听牌分析时，使用的是这个全局状态，而不是**当前副露区的实际状态**

### 错误逻辑

```javascript
// ❌ 错误：直接使用全局状态
const context = {
  isTsumo,
  isMenzen,  // 这个值可能与实际副露状态不符
  isRiichi,
  // ...
};
```

**导致的问题：**
- 即使有副露，也可能被当作门前来计算役种
- 门清役种（平和、一杯口、立直等）可能被错误地识别
- 番数计算错误（例如三色同顺应该是1番，但可能被算成2番）
- 符数计算错误（副露的面子符数不同）

## ✅ 解决方案

### 修复1: `updateDetailedTenpaiWaits()` 函数

**原代码：**
```javascript
const context = {
  isTsumo: isTsumo,
  isMenzen,  // ❌ 直接使用全局状态
  isRiichi,
  isDoubleRiichi,
  // ...
};
```

**修复后：**
```javascript
// 计算实际的门前状态：只有没有明副露（顺子/刻子/明杠）时才是门前
const actualIsMenzen = melds.length === 0 || melds.every(m => m.type === 'ankan');

const context = {
  isTsumo: isTsumo,
  isMenzen: actualIsMenzen,  // ✅ 使用实际的门前状态
  isRiichi: actualIsMenzen ? isRiichi : false,  // ✅ 有明副露时不能立直
  isDoubleRiichi: actualIsMenzen ? isDoubleRiichi : false,
  // ...
};
```

**关键点：**
- `actualIsMenzen` 根据**当前副露数组**动态计算
- 暗杠(ankan)不破坏门前状态
- 顺子(shuntsu)、刻子(pon)、明杠(minkan)会破坏门前状态
- 如果有明副露，立直状态也应该强制为 false

### 修复2: `getCurrentAnalysis()` 函数

同样的修复逻辑应用到 `getCurrentAnalysis()` 函数：

**原代码：**
```javascript
const context = {
  isTsumo,
  isMenzen,  // ❌ 直接使用全局状态
  isRiichi,
  // ...
};
```

**修复后：**
```javascript
// 计算实际的门前状态：只有没有明副露（顺子/刻子/明杠）时才是门前
const actualIsMenzen = melds.length === 0 || melds.every(m => m.type === 'ankan');

const context = {
  isTsumo,
  isMenzen: actualIsMenzen,  // ✅ 使用实际的门前状态
  isRiichi: actualIsMenzen ? isRiichi : false,  // ✅ 有明副露时不能立直
  isDoubleRiichi: actualIsMenzen ? isDoubleRiichi : false,
  // ...
};
```

## 🧪 测试验证

### 测试1: 有顺子副露的听牌分析

**设置：**
- 副露：顺子 1-2-3万
- 手牌：4-5-6万, 7-8-9万, 東東, 中中中（10张）

**期望结果：**
- ✅ `actualIsMenzen = false`（有顺子副露）
- ✅ 听牌分析中不会出现平和（平和需要门清）
- ✅ 三色同顺如果出现，应该是1番（副露版本）

### 测试2: 只有暗杠的听牌分析

**设置：**
- 副露：暗杠 1万×4
- 手牌：2-3-4万, 5-6-7饼, 8-9饼, 东东（10张）

**期望结果：**
- ✅ `actualIsMenzen = true`（暗杠不破坏门前）
- ✅ 可以识别平和、一杯口等门清役种
- ✅ 如果有立直状态，应该被保留

### 测试3: 混合副露的听牌分析

**设置：**
- 副露1：暗杠 1万×4
- 副露2：刻子 東東東（明刻）
- 手牌：2-3-4万, 5-6-7饼, 中中（7张）

**期望结果：**
- ✅ `actualIsMenzen = false`（有明刻）
- ✅ 立直状态被强制为 false
- ✅ 不会识别门清役种

### 测试4: 删除所有副露后

**操作步骤：**
1. 添加副露：顺子 1-2-3万
2. 观察听牌分析（应该是非门清）
3. 删除副露
4. 观察听牌分析（应该变成门清）

**期望结果：**
- ✅ 第2步：`actualIsMenzen = false`
- ✅ 第4步：`actualIsMenzen = true`
- ✅ 役种和番数随着门前状态正确切换

## 📊 影响范围

### 直接影响

1. **听牌分析区** (`updateDetailedTenpaiWaits`)
   - 待牌的役种识别
   - 待牌的番数计算
   - 待牌的符数计算
   - 待牌的点数计算

2. **胡牌分析** (`getCurrentAnalysis`)
   - 役种识别
   - 番数计算
   - 符数计算
   - 点数计算

### 影响的役种

#### 门清专属役种（有明副露时不应出现）
- ❌ 平和 (pinfu)
- ❌ 一杯口 (iipeeko)
- ❌ 二杯口 (ryanpeikou)
- ❌ 立直 (riichi)
- ❌ 双立直 (double_riichi)
- ❌ 门前清自摸和 (mentsumo)

#### 番数会降低的役种
- 三色同顺: 门清2番 → 副露1番
- 一气通贯: 门清2番 → 副露1番
- 混全带幺九: 门清2番 → 副露1番
- 纯全带幺九: 门清3番 → 副露2番
- 混一色: 门清3番 → 副露2番
- 清一色: 门清6番 → 副露5番

## 🎯 修复效果

### 修复前
```
副露：顺子 1-2-3万
手牌：1-2-3饼, 1-2-3索, 东东东, 中中
听：中

错误结果：
- 役种：三色同顺(2番) + 役牌·东(1番) + 役牌·中(1番) = 4番  ❌
- 可能错误识别为门清役种
```

### 修复后
```
副露：顺子 1-2-3万
手牌：1-2-3饼, 1-2-3索, 东东东, 中中
听：中

正确结果：
- isMenzen = false（有顺子副露）
- 役种：三色同顺(1番,副露) + 役牌·东(1番) + 役牌·中(1番) = 3番  ✅
- 不会出现门清役种
```

## ✨ 技术要点

### 门前状态判断逻辑

```javascript
const actualIsMenzen = melds.length === 0 || melds.every(m => m.type === 'ankan');
```

**解释：**
- `melds.length === 0`：没有任何副露，是门前
- `melds.every(m => m.type === 'ankan')`：所有副露都是暗杠，也是门前
- 逻辑或(`||`)：两个条件满足任一即可

**副露类型：**
- `shuntsu`：顺子 → 破坏门前 ❌
- `pon`：刻子 → 破坏门前 ❌
- `minkan`：明杠 → 破坏门前 ❌
- `ankan`：暗杠 → **不破坏门前** ✅

### 立直状态联动

```javascript
isRiichi: actualIsMenzen ? isRiichi : false
```

**逻辑：**
- 如果是门前(`actualIsMenzen = true`)，使用实际的立直状态
- 如果有明副露(`actualIsMenzen = false`)，强制立直为 false
- 这确保了有明副露时不会错误地计算立直役

## 📝 总结

本次修复解决了副露区最关键的一个 bug：**门前状态判断错误**

**核心改进：**
1. ✅ 不再依赖全局状态 `isMenzen`
2. ✅ 根据当前副露数组动态计算实际门前状态
3. ✅ 正确处理暗杠不破坏门前的特殊规则
4. ✅ 立直状态与门前状态正确联动
5. ✅ 役种识别、番数计算、符数计算全部正确

**影响函数：**
- `updateDetailedTenpaiWaits()` - 听牌分析
- `getCurrentAnalysis()` - 胡牌分析

**测试建议：**
- 各种副露组合（顺子、刻子、杠）
- 暗杠 vs 明杠
- 副露后的役种和番数
- 添加/删除副露后状态切换
