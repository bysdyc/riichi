# 副露与立直关系修复说明

## 🎯 核心概念澄清

### 问题描述
之前的实现中，**任何玩家添加副露后，所有玩家都不能立直**，这是错误的。

### 正确逻辑
1. **副露是针对当前胡牌分析的**，不是玩家的全局状态
2. **立直是玩家的状态**，记录在 `players[i].isRiichi` 中
3. **任何玩家都可以立直**，不受副露区影响
4. **但在胡牌分析时**，如果和牌者有明副露，则不能计算立直役

## 🔧 修复内容

### 修复1: 移除玩家立直时的副露检查 ❌→✅

**原代码（错误）：**
```javascript
document.querySelectorAll('[data-action="toggle-player-riichi"]').forEach(btn => {
  btn.addEventListener('click', () => {
    const index = parseInt(btn.dataset.index, 10);
    const wasRiichi = players[index].isRiichi;
    
    // ❌ 错误：全局检查副露，导致任何人有副露，所有人都不能立直
    if (!wasRiichi && melds.some(m => m.type === 'shuntsu' || m.type === 'pon' || m.type === 'minkan')) {
      alert('有明副露时不能立直！');
      return;
    }
    
    players[index].isRiichi = !players[index].isRiichi;
    // ...
  });
});
```

**修复后（正确）：**
```javascript
document.querySelectorAll('[data-action="toggle-player-riichi"]').forEach(btn => {
  btn.addEventListener('click', () => {
    const index = parseInt(btn.dataset.index, 10);
    const wasRiichi = players[index].isRiichi;
    
    // ✅ 正确：不在这里检查副露，因为副露是针对胡牌分析的
    // 玩家可以立直，但如果他胡牌时有副露，立直役会在分析时被忽略
    
    players[index].isRiichi = !players[index].isRiichi;
    
    // 立直时立即扣除1000点并增加立直棒
    if (!wasRiichi && players[index].isRiichi) {
      players[index].score -= 1000;
      gameState.riichiSticks += 1;
    } 
    // ...
  });
});
```

### 修复2: 添加副露时不取消立直状态

**原代码（错误）：**
```javascript
const addMeld = (type, firstTile) => {
  // ... 添加副露逻辑
  
  melds.push({ type, tiles });
  
  // ❌ 错误：添加副露时全局取消立直
  if (type === 'shuntsu' || type === 'pon' || type === 'minkan') {
    isMenzen = false;
    isRiichi = false;        // ❌ 错误
    isDoubleRiichi = false;  // ❌ 错误
  }
  
  render();
};
```

**修复后（正确）：**
```javascript
const addMeld = (type, firstTile) => {
  // ... 添加副露逻辑
  
  melds.push({ type, tiles });
  
  // ✅ 正确：只设置门前状态，不取消立直
  if (type === 'shuntsu' || type === 'pon' || type === 'minkan') {
    isMenzen = false;
    // 注意：不在这里取消立直，因为立直是玩家级别的状态
    // 是否能算立直役会在分析时根据和牌者是否有明副露来判断
  }
  
  render();
};
```

### 修复3: 胡牌分析时动态判断立直役（已完成）

在 `updateDetailedTenpaiWaits()` 和 `getCurrentAnalysis()` 中：

```javascript
// 计算实际的门前状态：只有没有明副露时才是门前
const actualIsMenzen = melds.length === 0 || melds.every(m => m.type === 'ankan');

const context = {
  isTsumo,
  isMenzen: actualIsMenzen,
  isRiichi: actualIsMenzen ? isRiichi : false,  // ✅ 有明副露时强制立直为false
  isDoubleRiichi: actualIsMenzen ? isDoubleRiichi : false,
  // ...
};
```

## 📊 场景说明

### 场景1: A玩家立直，B玩家副露胡牌

**操作：**
1. 点击A玩家的立直按钮（`players[0].isRiichi = true`）
2. 添加副露到副露区（例如：顺子 1-2-3万）
3. 选择B玩家为和牌者（`winnerIndex = 1`）
4. 输入手牌和和牌，点击确认

**期望结果：**
- ✅ A玩家立直状态保持（`players[0].isRiichi = true`）
- ✅ B玩家没有立直役（因为副露区有明副露）
- ✅ 计算B的点数时不包含立直役

### 场景2: A玩家立直并胡牌，手牌无副露

**操作：**
1. 点击A玩家的立直按钮（`players[0].isRiichi = true`）
2. 副露区为空（`melds = []`）
3. 选择A玩家为和牌者（`winnerIndex = 0`）
4. 输入手牌和和牌，点击确认

**期望结果：**
- ✅ A玩家立直状态保持（`players[0].isRiichi = true`）
- ✅ `actualIsMenzen = true`（无副露）
- ✅ 计算时 `context.isRiichi = true`
- ✅ 立直役被正确计算（+1番）

### 场景3: A玩家立直并胡牌，但手牌有副露

**操作：**
1. 点击A玩家的立直按钮（`players[0].isRiichi = true`）
2. 添加副露到副露区（例如：刻子 東東東）
3. 选择A玩家为和牌者（`winnerIndex = 0`）
4. 输入手牌和和牌，点击确认

**期望结果：**
- ✅ A玩家立直状态保持（`players[0].isRiichi = true`）
- ✅ `actualIsMenzen = false`（有明副露）
- ✅ 计算时 `context.isRiichi = false`（强制为false）
- ✅ **立直役不被计算**
- ⚠️ 这种情况在实际游戏中不会发生（立直后不能副露），但系统允许记录

### 场景4: A玩家立直，暗杠后胡牌

**操作：**
1. 点击A玩家的立直按钮（`players[0].isRiichi = true`）
2. 添加暗杠到副露区（`{ type: 'ankan', tiles: [...] }`）
3. 选择A玩家为和牌者（`winnerIndex = 0`）
4. 输入手牌和和牌，点击确认

**期望结果：**
- ✅ A玩家立直状态保持（`players[0].isRiichi = true`）
- ✅ `actualIsMenzen = true`（暗杠不破坏门前）
- ✅ 计算时 `context.isRiichi = true`
- ✅ 立直役被正确计算（+1番）

## 🎯 设计理念

### 数据结构分离

1. **玩家状态（players）**
   - `players[i].isRiichi`：玩家是否立直（全局状态）
   - `players[i].score`：玩家点数
   - 这些是跨局保持的状态

2. **当前局分析（全局变量）**
   - `melds`：当前分析的手牌的副露
   - `selectedTiles`：当前分析的手牌
   - `winTile`：当前的和牌
   - `winnerIndex`：当前的和牌者
   - 这些是针对当前这一局的分析数据

3. **分离的好处**
   - 玩家立直状态不受副露区影响
   - 副露区只影响当前胡牌的分析
   - 可以灵活记录各种情况（包括理论上不可能的组合）

### 分析时的动态判断

```javascript
// 在分析时，根据实际情况动态计算
const actualIsMenzen = melds.length === 0 || melds.every(m => m.type === 'ankan');

const context = {
  isMenzen: actualIsMenzen,
  isRiichi: actualIsMenzen ? isRiichi : false,  // 关键：动态判断
  // ...
};
```

**优点：**
- 灵活：允许用户先标记立直，再添加副露
- 准确：分析时根据实际副露情况决定是否计算立直役
- 容错：即使用户操作顺序不对，也能得到正确结果

## 🔍 验证要点

### 测试1: 立直按钮可用性
- ✅ 任何玩家都可以随时点击立直按钮
- ✅ 不受副露区内容影响

### 测试2: 立直役计算
- ✅ 无副露时，立直役正常计算
- ✅ 有明副露时，立直役被忽略
- ✅ 只有暗杠时，立直役正常计算

### 测试3: 听牌分析
- ✅ 无副露时，显示立直相关役种
- ✅ 有明副露时，不显示立直相关役种
- ✅ 番数和点数计算正确

### 测试4: 多玩家场景
- ✅ A玩家立直，B玩家副露胡牌，各自独立
- ✅ A玩家的立直状态不受B的副露影响

## ⚠️ 注意事项

### 实际规则 vs 系统记录

**实际麻将规则：**
- 立直后不能副露（包括暗杠，除非是加杠）
- 立直后只能自摸胡，不能荣和别人的牌

**系统设计：**
- 允许用户灵活组合，因为这是**记录工具**而不是**游戏引擎**
- 用户可能需要记录特殊情况或复盘
- 系统在分析时会自动修正逻辑冲突（如有副露时忽略立直役）

### UI提示

建议添加提示信息：
- 当有明副露时，在立直役旁边显示"（已忽略，因为有副露）"
- 或者在分析结果中说明"检测到立直状态，但因有明副露已忽略"

## 📝 总结

本次修复的核心改进：

1. **解耦玩家立直状态与副露区**
   - 立直是玩家级别的，副露是分析级别的
   - 两者独立，互不干扰

2. **动态判断立直役的有效性**
   - 在分析时检查副露情况
   - 有明副露时强制 `isRiichi = false`

3. **保持系统灵活性**
   - 允许用户自由组合
   - 系统自动处理逻辑冲突

4. **修复的问题**
   - ❌ 之前：任何人有副露，所有人不能立直
   - ✅ 现在：任何人都能立直，分析时根据副露情况决定是否计算立直役
