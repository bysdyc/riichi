# 微信小程序版《日本麻将记录器》开发手册

> 目标：在微信小程序中完整复刻现有 Web 版 `dmvan.html` 的界面与交互逻辑，保持功能等价，不做简化。

---

## 1. 项目基础信息
- **平台**：微信小程序（基础库 ≥ 2.32，支持自定义组件、虚拟化列表等能力）
- **设计语言**：遵循 Web 版视觉，使用自定义 WXSS 主题；若需原子化样式，可引入 `tailwindcss-miniprogram`（需构建配置支持）
- **图标资源**：`lucide-react` 不可直接使用，改为引入 iconfont 字体或精简 SVG sprite
- **字体**：使用系统默认；如需定制需确认版权并放于 `assets/fonts`
- **适配**：默认竖屏，小程序页面宽度 750rpx

---

## 2. 仓库结构规划
```
project-root/
├─ app.js / app.json / app.wxss
├─ sitemap.json
├─ miniprogram_npm/              # 若使用第三方依赖（例如 tailwind runtime）
├─ utils/
│   ├─ mahjongCore.js            # 核心计算逻辑，等价于 Web 中的大段 JS
│   ├─ storage.js                # 本地存储封装（wx.*StorageSync）
│   ├─ constants.js              # 牌面、役种、常量表
│   ├─ score.js                  # 计分、分配封装
│   └─ formatter.js              # 导出、格式化文本
├─ components/
│   ├─ tile-picker/              # 统一麻将牌选择面板
│   ├─ meld-panel/               # 副露展示与操作
│   ├─ dora-counter/             # 宝牌计数器
│   ├─ toast-layer/              # 自定义 Toast
│   ├─ history-card/             # 单局历史项
│   ├─ multi-win-config/
│   └─ draw-dialog/
└─ pages/
    ├─ landing/                  # 开局设置（含继续游戏）
    ├─ game/                     # 主对局页面（复刻主 UI）
    ├─ history/                  # 历史记录列表
    └─ export-preview/           # 导出/分享文本预览
```

---

## 3. 数据与状态设计
### 3.1 全局状态（App 或自建 Store）
- `gameSettings`: { type: 'tonpuu'|'hanchan'|'yonchan', tobu: boolean }
- `players`: 数组，含 `id/name/score/wind/isRiichi`
- `gameState`: { wind, round, honba, riichiSticks }
- `currentDealerIndex`
- `roundHistory`: 与 Web 保持一致（含 scoreChanges、handData 等）
- `isGameOver`
- `timestamp(s)`：用于导出、日志

> 建议使用 **自定义轻量 store**（封装在 `utils/store.js`）+ `Behavior` 共享，因微信小程序不原生支持 React 式全局状态。

### 3.2 页面局部状态
1. **登陆页 (`landing`)**
   - `hasSavedGame`
   - `selectedType`
   - `tobuChecked`
2. **主页面 (`game`)**
   - UI 控制：`showScoreInput`, `showHistory`, `showDrawDialog`, `multiWinType`
   - 和牌过程相关：`winnerIndex`, `loserIndex`, `isTsumo`, `selectedTiles`, `melds`, `winTile`
   - 状况役：`isMenzen`, `isRiichi`, `isIppatsu`, `…`
   - 手动/老手模式：`isManualMode`, `manualYaku`, `manualFu`, `isExpertMode`, `expertHan`
   - 多人和牌：`multiWinners`, `multiWinLoser`, `multiWinHanFu`
   - 流局：`tenpaiedPlayers`, `drawRiichiPlayers`, `nagashiManganPlayers`, `isStartingHandDraw`
   - UI 辅助：`activeTileArea`, `pendingMeldType`, `isYakuExpanded`, `toast`
3. **历史页 (`history`)**
   - `sortedHistory`（倒序显示）
   - `expandedIndex`
4. **导出页 (`export-preview`)**
   - `exportText`
   - `shareOptions`

### 3.3 Storage 映射
- 替换 `localStorage` -> `wx.getStorageSync / wx.setStorageSync`
- KEY 保持 `mahjong_game_state`
- 提供 `StorageService.saveGame(state)` / `loadGame()` / `clearGame()` 封装
- 支持并发读写时机：结算结束后写入；页面 onShow 时尝试读取

---

## 4. 页面与组件详细规划

### 4.1 `landing` 页面
- 功能：选择对局类型、击飞规则、加载存档
- UI：使用垂直卡片 + 渐变背景（WXSS 重新实现）
- 逻辑：
  - onLoad: 检查 `hasSavedGame`
  - 继续游戏：读取存档 -> setGlobalState -> redirectTo `/pages/game/index`
  - 新游戏：初始化全局状态 -> redirect
  - 清除进度：调用 Storage 清除 + Toast

### 4.2 `game` 页面
分区布局同 Web：
1. **头部信息**：局数、场风、本场、立直棒、按钮（历史/重置）
   - 使用自定义组件 `<header-info>`（可选）
2. **玩家面板**:
   - 4 栏，支持输入姓名、显示分数、庄家高亮、立直状态
   - 输入使用 `input` 组件 + 双向绑定
3. **结果选择区**：三个主按钮 -> 更新 `showScoreInput` / `showDrawDialog`
4. **流局弹窗**（使用自定义组件 `draw-dialog`）
   - 完整复现听牌、流局满贯、立直棒逻辑
5. **结算面板**：
   - 模式切换（自动/手动/老手）
   - 自摸/荣和、和牌者/放铳者选择
   - 立直玩家选择（同步 players 状态）
   - **麻将牌选择器组件**：
     - 支持 `hand`/`meld`/`win` 模式
     - 针对副露：先选类型，再点牌；内部校验 4 张限制
     - 选满后自动切换区块（Toast 提示）
   - 宝牌计数器组件（支持上限控制）
   - 状况役折叠面板
   - 手动/老手模式面板
   - 实时分析区：
     - 调用 `mahjongCore.analyzeHand` 返回 `yaku/han/fu`
     - 调用 `score.calculate()` 得到点数与分配
     - 多人和牌时切换至 `multi-win-config` 组件
6. **操作按钮**：取消 / 确认结算
7. **Toast**：优先使用 `wx.showToast`；如需自定义动画 -> `toast-layer` 组件

### 4.3 `history` 页面
- 列表使用 `scroll-view`
- 子项用 `history-card` 组件，含：局数、庄家、和牌类型、和牌者、役种、番符、点数、牌谱详情（手牌+副露+状况）
- 支持 `details` 展开替代：使用 `fold` 状态控制
- 须呈现 `scoreChanges` 及每局后总分
- 提供导出按钮 -> navigateTo `export-preview`

### 4.4 `export-preview` 页面
- 文本内容由 `formatter.buildExportText(state)` 生成
- 提供：
  1. 复制到剪贴板（`wx.setClipboardData`）
  2. 保存到文件（受限；可提示用户复制，或接入「分享到文件传输助手」）
  3. 返回主页面
- 若后续需要生成 `.txt` 文件，可结合云函数或 `wx.env.USER_DATA_PATH`

### 4.5 自定义组件要点
| 组件 | 功能重点 | 事件接口 |
| --- | --- | --- |
| `tile-picker` | 复用同一套牌面按钮，支持 `mode=hand/meld/win`、`pendingMeldType`、4 张校验 | `onSelect(tile)` |
| `meld-panel` | 展示副露列表，支持删除、清空、类型提示 | `onRemove(index)`|
| `dora-counter` | 通用计数器，带上限与禁用 | `onChange(type, value)`|
| `multi-win-config` | 多家和牌配置，计算 preview | `onConfirm(data)`|
| `draw-dialog` | 流局 UI，管理听牌、流局满贯、立直棒 | `onCancel()` / `onConfirm(result)`|
| `toast-layer` | 自定义动画 Toast（若系统 Toast 不满足） | `show(message)`|

---

## 5. 核心逻辑模块拆解
### 5.1 `utils/constants.js`
- 牌面映射（display/internal）
- 役种列表 `allYakuList`
- 常量：`yaochuuhai`, `terminals`, `honors`

### 5.2 `utils/mahjongCore.js`
> 原 HTML 中大部分麻将算法移植到此模块，封装为纯函数，便于单元测试。
- `getTileCounts(tiles)`
- `checkKokushi`, `checkChiitoitsu`
- `findMelds`, `findStandardCombinations`, `findPartialCombinations`
- `calculateYaku(combo, winTile, context)`
- `calculateFu(combo, winTile, context)`
- `analyzeHand(handTiles, winTile, externalMelds, context)`
- `findTenpaiWaits(hand13, melds)`
- `checkYakuConflicts(selectedYakuIds)`
- `calculateManualHan(manualYaku, isManualFuro, dora, uraDora, redDora)`

### 5.3 `utils/score.js`
- `calculateScore(han, fu, isDealer, honba, isTsumo)`
- `getScoreDistribution(analysis, scoreData, players, winnerIndex, loserIndex, isTsumo, currentDealerIndex, riichiSticks)`
- `calculateMultiWinScores(multiWinners, multiWinLoser, multiWinHanFu, currentDealerIndex, honba)`

### 5.4 `utils/storage.js`
- `saveGame(state)`
- `loadGame()`
- `clearGame()`
- 错误捕获、降级提示

### 5.5 `utils/formatter.js`
- `buildExportText(state)`：与 Web 导出一致（注意换行、时间格式）
- 若需分享数据结构，可返回 JSON

---

## 6. 业务流程映射

### 6.1 对局初始化
1. Landing 页面选择类型 -> 初始化 `players`, `gameState`
2. 调用 `Storage.saveGame`
3. 跳转主页面，`onLoad` 读取全局 store

### 6.2 和牌结算
1. 填写和牌数据（手牌、副露、状况、宝牌）
2. 点击「确认结算」
   - 自动模式：
     - `mahjongCore.analyzeHand`
     - 无结果 -> Toast 错误
   - 手动模式：
     - 检查冲突 -> 计算番数
   - 老手模式：直接使用输入值
3. 获取 `analysis` -> `score.calculateScore`
4. 更新 `players` 分数、`roundHistory`
5. 根据 `gameSettings` 执行 `goToNextRound`
6. 调用 `Storage.saveGame`
7. 重置局部状态

### 6.3 多人和牌
- 进入 `multiWin` 流程 -> 组件收集番符 -> `calculateMultiWinScores`
- 校验分数平衡 -> 写入 `roundHistory`
- 进入 `goToNextRound`

### 6.4 流局
- `draw-dialog` 收集听牌/流局满贯/立直信息
- `score` 模块计算罚符、流局满贯点数
- 更新 `players` / `roundHistory`
- 判断庄家是否连庄 -> `goToNextRound`
- 保存

### 6.5 历史/导出
- 历史页从全局 state 读取
- 导出页调用 `formatter` 生成文本，可复制

---

## 7. UI 与样式实现建议
1. **色彩与渐变**：WXSS 中使用 `linear-gradient`，或通过自定义 class 复刻 Tailwind 渐变
2. **栅格**：使用 `flex` + `wrap` 实现 Tailwind 原栅格；必要时定义 `grid` 工具类
3. **按钮状态**：提供 `active`/`disabled` 样式，并使用 `dataset` + `bindtap`
4. **Toast**：优先 `wx.showToast`，若需多样式在组件中模拟（使用 `animation` + `cover-view`）
5. **滚动区域**：历史列表用 `scroll-view`，保持性能
6. **可访问性**：为按钮设置 aria-like 文案（通过 `aria-label` 属性支持）

---

## 8. 构建与工具链
- 使用微信开发者工具导入项目
- 若采用 Tailwind：需 Node 构建脚本，将生成的 `tailwind.wxss` 导入各页面
- 推荐在根目录配置 `package.json`，可用 `npm` 构建小程序自定义组件库
- 配置 ESLint（基于 `eslint-config-tencent`）+ Prettier，统一 WXSS/JS 格式
- 单元测试：
  - 核心逻辑模块可使用 `miniprogram-simulate` 或 Node 环境下运行 Jest（纯函数）

---

## 9. 里程碑规划
1. **M1 – 项目搭建 (1-2 天)**
   - 初始化小程序项目结构
   - 搭建 tailwind/自定义样式方案
   - 封装 Storage 服务
2. **M2 – 核心逻辑下沉 (3-4 天)**
   - 迁移 `constants`, `mahjongCore`, `score`
   - 补充单元测试，确保与 Web 结果一致
3. **M3 – 页面骨架与全局状态 (2-3 天)**
   - 完成 landing / game / history 页面框架
   - 实现全局 store + 页面间通信
4. **M4 – 组件实现 (5-6 天)**
   - Tile picker、Meld panel、Dora counter、Toast、Multi-win、Draw dialog
   - 集成到主页面，保证交互与限制
5. **M5 – 业务流程整合 (4-5 天)**
   - 单人和牌流程闭环
   - 多人和牌、流局流程
   - 手动模式、老手模式、宝牌逻辑
6. **M6 – 历史与导出 (2-3 天)**
   - 历史页、导出文本、复制功能
7. **M7 – 测试与打磨 (3-4 天)**
   - 真机调试，性能优化（监听 setData 粒度）
   - UI 调整、动效
   - 文案、异常提示
8. **M8 – 上线准备 (1-2 天)**
   - 填写小程序信息、截图
   - 测试账号、体验版发布

> 总计约 3-4 周（以单人开发、保证质量为前提）。

---

## 10. 风险与对策
| 风险 | 描述 | 对策 |
| --- | --- | --- |
| 性能瓶颈 | 主页面状态字段众多，`setData` 频繁 | 组件内局部管理；合理拆分 `setData`；使用节流/防抖 |
| 样式还原 | Tailwind 样式需重写 | 在 WXSS 中预设常用工具类；必要时引入 tailwind 小程序方案 |
| 图标替换 | lucide 图标需替换资源 | 自建 iconfont；常用图标导出为 svg -> base64 |
| 导出限制 | 小程序不能直接保存 txt | 提供复制、分享方案；文档说明 |
| 算法一致性 | 复制逻辑易产生回归 | 迁移后编写 Jest 用例，对比原结果 |
| 状态同步 | 多页面共享数据复杂 | 建立统一 store；封装 `getApp().globalData` + 发布订阅 |

---

## 11. 测试清单（关键用例）
1. **对局流程**
   - 东风战→所有局数推进、连庄、击飞结束
   - 半庄/全庄风场切换
2. **和牌类型**
   - 自摸/荣和、庄家/闲家、宝牌、役满
   - 多人和牌分配校验
3. **流局场景**
   - 普通流局听牌分、开局流局、本场数变化
   - 流局满贯多家
4. **手动/老手模式**
   - 冲突提示、番符计算、与自动模式结果对比
5. **副露与宝牌限制**
   - 面子类型合法性、超过 4 张提示
6. **历史记录**
   - 逐局分数变化正确
   - 导出文本完整
7. **存档**
   - 自动保存、继续游戏恢复
   - 清除存档后重置
8. **UI 交互**
   - Toast、按钮状态、输入框、切换模式
   - 真机触控流畅度

---

## 12. 后续扩展建议
- 支持多平台云同步（借助小程序云开发）
- 增加数据统计（平均点数、立直率）
- 导出 JSON / CSV
- 引入分享功能（生成海报）
- 自定义皮肤/语言

---

> 本手册为后续开发的执行指南，可在开发过程中细化为迭代任务与具体工单。
