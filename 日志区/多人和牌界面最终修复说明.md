# 多人和牌界面最终修复说明

## 修复内容

根据用户反馈,对多人和牌功能进行了以下三项修复:

### 1. 移除自摸选项

**问题**: 多人和牌(三家和)不存在自摸的情况,原界面错误地提供了自摸/荣和切换选项。

**修复**:
- ✅ 移除了"选择和牌类型"(自摸/荣和)切换按钮
- ✅ 多人和牌现在**总是荣和**
- ✅ 用户界面标题改为"多人和牌 (荣和)"
- ✅ 步骤编号调整: 1.选择和牌者 → 2.选择放铳者 → 3.设置番符

**代码变更**:
```javascript
// 移除变量
let multiWinIsTsumo = true; // 已删除

// 计算函数简化
const calculateMultiWinScores = () => {
  // 总是使用荣和逻辑
  const scoreData = calculateScore(han, fu, false, isDealer); // false = 荣和
  scores[winnerIdx] += scoreData.total;
  scores[multiWinLoser] -= scoreData.total;
};

// 验证简化
if (multiWinLoser === null) {
  alert('荣和时请选择放铳者!');
}
```

---

### 2. 扩展番数和符数范围

**问题**: 原界面番数最大只到8番,符数最大只到60符,无法输入更高的役满。

**修复**:
- ✅ **番数按钮**: 从 `[1,2,3,4,5,6,7,8]` 扩展到 `[1,2,3,4,5,6,7,8,9,10,11,12,13,26]` (共14个按钮)
- ✅ **符数按钮**: 从 `[20,25,30,40,50,60]` 扩展到 `[20,25,30,40,50,60,70,80,90,100,110]` (共11个按钮)
- ✅ 支持役满(13番)和双倍役满(26番)
- ✅ 保持与老手模式一致的最大限制

**界面布局**:
```html
<!-- 番数: 14个按钮,网格布局4列 -->
<div class="grid grid-cols-4 gap-1 mt-1">
  <button>1</button> <button>2</button> ... <button>13</button> <button>26</button>
</div>

<!-- 符数: 11个按钮,网格布局3列 -->
<div class="grid grid-cols-3 gap-1 mt-1">
  <button>20</button> <button>25</button> ... <button>110</button>
</div>

<!-- 输入框范围 -->
<input type="number" min="1" max="26" step="1">  <!-- 番数 -->
<input type="number" min="20" max="110" step="10"> <!-- 符数 -->
```

---

### 3. 添加单个和牌者的点数预览

**问题**: 原界面只有总分数变化预览,用户无法看到每个和牌者分别获得多少点。

**修复**:
- ✅ 在**每个和牌者**的番符选择器下方添加点数预览框
- ✅ 显示该和牌者的得分(绿色,+xxxx)
- ✅ 显示放铳者的失分(红色,-xxxx)
- ✅ 仅在选择放铳者后才显示预览

**预览格式**:
```
┌──────────────────────┐
│ 点数预览:            │
│ 东: +8000   (绿色)   │
│ 西: -8000   (红色)   │
└──────────────────────┘
```

**代码实现**:
```javascript
${multiWinLoser !== null ? (() => {
  const { han, fu } = data;
  const isDealer = winnerIdx === currentDealerIndex;
  const scoreData = calculateScore(han, fu, false, isDealer);
  const points = scoreData.total;
  
  return `
    <div class="mt-2 p-2 bg-blue-50 rounded">
      <p class="text-xs text-gray-600">点数预览:</p>
      <p class="text-sm font-bold text-green-600">
        ${players[winnerIdx].wind}: +${points}
      </p>
      <p class="text-sm font-bold text-red-600">
        ${players[multiWinLoser].wind}: -${points}
      </p>
    </div>
  `;
})() : ''}
```

---

## 使用流程示例

### 场景: 三家和(东家8000点、南家12000点、西家4000点)

#### 第1步: 选择和牌者
```
☑️ 东  ☑️ 南  ☑️ 西  ☐ 北
```

#### 第2步: 选择放铳者
```
☐ 东  ☐ 南  ☐ 西  ☑️ 北  (北家放铳)
```

#### 第3步: 设置各和牌者的番符

**东家(庄家):**
```
番数: [●4] 符数: [●30]
┌──────────────────────┐
│ 点数预览:            │
│ 东: +12000  (绿色)   │
│ 北: -12000  (红色)   │
└──────────────────────┘
```

**南家:**
```
番数: [●5] 符数: [●30]
┌──────────────────────┐
│ 点数预览:            │
│ 南: +12000  (绿色)   │
│ 北: -12000  (红色)   │
└──────────────────────┘
```

**西家:**
```
番数: [●3] 符数: [●30]
┌──────────────────────┐
│ 点数预览:            │
│ 西: +3900   (绿色)   │
│ 北: -3900   (红色)   │
└──────────────────────┘
```

#### 总分数预览
```
💡 总分数变化预览:
东: +12000  南: +12000  西: +3900  北: -27900
总计: 0 ✅
```

---

## 代码清理

### 移除的变量和代码
```javascript
// 已移除
let multiWinIsTsumo = true;
state.multiWinIsTsumo
multiWinIsTsumo = btn.dataset.value === 'true';
document.querySelectorAll('[data-action="set-multi-tsumo"]') // 事件监听器
```

### 简化的判断条件
```javascript
// 之前
if (!multiWinIsTsumo && multiWinLoser === null) { ... }
if (multiWinners.length > 0 && (multiWinIsTsumo || multiWinLoser !== null)) { ... }

// 现在
if (multiWinLoser === null) { ... }
if (multiWinners.length > 0 && multiWinLoser !== null) { ... }
```

---

## 测试清单

- [x] 多人和牌界面不显示自摸/荣和切换按钮
- [x] 必须选择放铳者才能确认
- [x] 番数按钮包含1-13和26
- [x] 符数按钮包含20-110(10点间隔)
- [x] 输入框范围正确(番1-26,符20-110)
- [x] 每个和牌者下方显示单独的点数预览
- [x] 点数预览仅在选择放铳者后显示
- [x] 总分数预览计算正确(总和为0)
- [x] 历史记录显示放铳者名字(不是"-")
- [x] localStorage不再保存multiWinIsTsumo

---

## 技术细节

### 点数计算
- 使用 `calculateScore(han, fu, false, isDealer)` 计算荣和得分
- `false` 参数表示总是荣和(非自摸)
- 庄家和闲家的点数计算自动区分

### UI反馈
- 绿色文字: 得分方(+xxxx)
- 红色文字: 失分方(-xxxx)
- 蓝色背景: 预览框底色
- 灰色文字: 标签文字

### 数据验证
- 至少选择1个和牌者
- 必须选择1个放铳者
- 每个和牌者必须设置番符
- 总分数必须为0(平衡验证)

---

## 版本信息

- **修复日期**: 2025-01-XX
- **修复版本**: v1.3
- **影响范围**: 多人和牌界面和计算逻辑
- **向后兼容**: 是(旧数据中的multiWinIsTsumo会被忽略)
