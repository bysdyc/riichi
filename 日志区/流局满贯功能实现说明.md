# 流局满贯功能实现说明

## 修改时间
2025年10月29日

## 功能概述

在流局对话框的"普通流局"下方新增了"流局满贯"选项，默认折叠，展开后可以选择达成流局满贯的玩家，并自动计算对应点数。

---

## 什么是流局满贯

### 定义
流局满贯（流し満貫，Nagashi Mangan）是日本麻将中的一种特殊役种：
- 流局时，某玩家所有舍牌均为幺九牌（1、9、字牌）
- 且这些舍牌未被其他玩家鸣牌（吃、碰、杠）
- 视为满贯自摸，从其他三家各获得满贯点数

### 规则要点
1. **成立条件：**
   - 必须在流局时判定
   - 该玩家的所有舍牌都是幺九牌
   - 这些舍牌都未被鸣牌

2. **点数计算：**
   - 庄家流局满贯：每家支付4000点，共获得12000点
   - 闲家流局满贯：庄家支付4000点，其他闲家各支付2000点，共获得8000点

3. **特殊情况：**
   - 多人可同时达成流局满贯
   - 流局满贯可以与听牌罚符同时计算
   - 达成流局满贯的庄家会连庄

---

## 新增功能

### 1. 状态变量

添加了两个新的状态变量：

```javascript
let showNagashiMangan = false;      // 是否展开流局满贯选项
let nagashiManganPlayers = [];      // 流局满贯的玩家索引数组
```

### 2. UI界面

#### 折叠标题按钮
```
┌────────────────────────────────────────────┐
│ ▶️ 流局满贯                    [展开]       │
└────────────────────────────────────────────┘
```

点击后展开：
```
┌────────────────────────────────────────────┐
│ 🔽 流局满贯 (东、南)           [收起]       │
│                                            │
│ 📢 流局满贯说明：                          │
│ • 流局时，某玩家所有舍牌均为幺九牌...      │
│                                            │
│ 选择达成流局满贯的玩家：                   │
│ ┌──────┬──────┬──────┬──────┐           │
│ │  東  │  南  │  西  │  北  │           │
│ │✓满贯 │✓满贯 │未达成│未达成│           │
│ └──────┴──────┴──────┴──────┘           │
│                                            │
│ 💰 点数预览：                              │
│ 东: 各家支付4000点，共获得12000点          │
│ 南: 庄家支付4000点，闲家各支付2000点，     │
│     共获得8000点                           │
└────────────────────────────────────────────┘
```

#### 位置
- 位于"普通流局"/"开局流局"按钮下方
- 在"选择听牌的玩家"上方
- 仅在普通流局模式下显示（开局流局不显示）

### 3. 点数计算逻辑

#### 优先级
流局满贯的点数计算在听牌罚符之前处理：
1. 先计算流局满贯点数
2. 再计算听牌罚符
3. 最后处理立直棒

#### 计算公式

**庄家流局满贯：**
```javascript
每家支付：4000点
总获得：12000点
```

**闲家流局满贯：**
```javascript
庄家支付：4000点
其他闲家各支付：2000点
总获得：8000点
```

#### 代码实现
```javascript
nagashiManganPlayers.forEach(winnerIdx => {
  const isDealer = winnerIdx === currentDealerIndex;
  const eachPay = isDealer ? 4000 : 2000;
  const dealerPay = 4000;
  
  newPlayers.forEach((p, idx) => {
    if (idx !== winnerIdx) {
      if (isDealer) {
        // 庄家流局满贯
        p.score -= eachPay;
        scoreChanges[idx] -= eachPay;
      } else {
        // 闲家流局满贯
        const payment = idx === currentDealerIndex ? dealerPay : eachPay;
        p.score -= payment;
        scoreChanges[idx] -= payment;
      }
    }
  });
  
  // 流局满贯者获得点数
  const totalGain = isDealer ? 12000 : 8000;
  newPlayers[winnerIdx].score += totalGain;
  scoreChanges[winnerIdx] += totalGain;
});
```

### 4. 历史记录

#### 记录格式

**单人流局满贯：**
```
类型：流局 (东 流局满贯)
役种：流局满贯 - 东
番符：5番 0符
```

**多人流局满贯：**
```
类型：流局 (东、南 流局满贯)
役种：流局满贯 - 东、南
番符：5番 0符
```

**流局满贯 + 听牌：**
```
类型：流局 (东 流局满贯)
役种：流局满贯 - 东 | 南、西 听牌
番符：5番 0符
```

#### 代码实现
```javascript
let drawType = '';
let drawYaku = '';

if (nagashiManganPlayers.length > 0) {
  const nagashiNames = nagashiManganPlayers.map(i => players[i].name).join('、');
  drawType = `流局 (${nagashiNames} 流局满贯)`;
  drawYaku = `流局满贯 - ${nagashiNames}`;
  if (tenpaiCount > 0) {
    drawYaku += ` | ${tenpaiedPlayers.map(i => players[i].name).join('、')} 听牌`;
  }
}

const roundData = {
  winner: nagashiManganPlayers.length > 0 ? nagashiManganPlayers.map(i => players[i].name).join('、') : '-',
  type: drawType,
  yaku: drawYaku,
  han: nagashiManganPlayers.length > 0 ? 5 : 0, // 流局满贯视为5番（满贯）
  // ...
};
```

### 5. 连庄判定

修改了连庄判定逻辑，考虑流局满贯：

```javascript
// 流局满贯时：如果流局满贯者包含庄家，则连庄
const isDealerTenpai = isStartingHandDraw 
  ? true 
  : (nagashiManganPlayers.includes(currentDealerIndex) || tenpaiedPlayers.includes(currentDealerIndex));
```

**规则：**
- 开局流局：庄家必定连庄
- 普通流局：庄家听牌或达成流局满贯则连庄
- 流局满贯：达成者包含庄家则连庄

---

## 使用示例

### 示例1：单人流局满贯（庄家）

**场景：**
- 东家（庄家）达成流局满贯
- 其他玩家未听牌

**点数变化：**
```
东家（庄家）：+12000点
南家：-4000点
西家：-4000点
北家：-4000点
```

**操作步骤：**
1. 点击"流局"按钮
2. 确保选择"普通流局"
3. 点击"▶️ 流局满贯"展开
4. 点击"東"按钮选择东家
5. 查看点数预览
6. 点击"确认流局"

### 示例2：单人流局满贯（闲家）

**场景：**
- 南家（闲家）达成流局满贯
- 其他玩家未听牌

**点数变化：**
```
南家：+8000点
东家（庄家）：-4000点
西家：-2000点
北家：-2000点
```

### 示例3：多人流局满贯

**场景：**
- 东家（庄家）和南家同时达成流局满贯
- 西家、北家未听牌

**点数变化：**
```
东家：+12000 - 4000 = +8000点  （获得12000，支付给南家4000）
南家：+8000 - 4000 = +4000点   （获得8000，支付给东家4000）
西家：-4000 - 2000 = -6000点   （支付给东家4000，支付给南家2000）
北家：-4000 - 2000 = -6000点   （支付给东家4000，支付给南家2000）
```

### 示例4：流局满贯 + 听牌罚符

**场景：**
- 东家达成流局满贯
- 南家、西家听牌，北家未听牌

**点数计算：**

1. **流局满贯（东家）：**
   ```
   东家：+12000点
   南家：-4000点
   西家：-4000点
   北家：-4000点
   ```

2. **听牌罚符（2人听牌，1人未听）：**
   ```
   南家：+1500点
   西家：+1500点
   北家：-3000点
   ```

3. **最终变化：**
   ```
   东家：+12000点
   南家：-4000 + 1500 = -2500点
   西家：-4000 + 1500 = -2500点
   北家：-4000 - 3000 = -7000点
   ```

---

## 技术实现细节

### 1. 事件处理器

新增了3个事件处理器：

```javascript
// 1. 流局满贯展开/折叠
document.querySelector('[data-action="toggle-nagashi-mangan"]')?.addEventListener('click', () => {
  showNagashiMangan = !showNagashiMangan;
  render();
});

// 2. 流局满贯玩家选择
document.querySelectorAll('[data-action="toggle-nagashi-mangan-player"]').forEach(btn => {
  btn.addEventListener('click', () => {
    const index = parseInt(btn.dataset.index, 10);
    if (nagashiManganPlayers.includes(index)) {
      nagashiManganPlayers = nagashiManganPlayers.filter(i => i !== index);
    } else {
      nagashiManganPlayers = [...nagashiManganPlayers, index];
    }
    render();
  });
});
```

### 2. 状态重置

在以下情况会重置流局满贯状态：

1. **取消流局：**
```javascript
document.querySelector('[data-action="cancel-draw"]')?.addEventListener('click', () => {
  // ...
  nagashiManganPlayers = [];
  showNagashiMangan = false;
  // ...
});
```

2. **切换到开局流局：**
```javascript
if (isStartingHandDraw) {
  tenpaiedPlayers = [];
  drawRiichiPlayers = [];
  nagashiManganPlayers = [];
  showNagashiMangan = false;
}
```

### 3. UI样式

使用了黄色/橙色渐变主题，与流局满贯的特殊性相匹配：

```css
bg-gradient-to-r from-yellow-50 to-orange-50
border-2 border-yellow-300
text-yellow-800
bg-yellow-500 text-white  /* 选中状态 */
```

---

## 兼容性说明

### 完全兼容
- ✅ 不影响普通流局功能
- ✅ 不影响开局流局功能
- ✅ 不影响听牌罚符计算
- ✅ 不影响立直棒处理
- ✅ 可以与听牌罚符同时计算

### 新增功能
- ✅ 流局满贯玩家选择（支持多人）
- ✅ 实时点数预览
- ✅ 自动计算点数变化
- ✅ 历史记录完整记录
- ✅ 连庄逻辑正确处理

---

## 注意事项

### 1. 实际游戏规则
- 流局满贯在不同规则中可能有差异
- 有些规则不承认流局满贯
- 有些规则要求必须听牌才能达成
- **本系统采用日本麻将标准规则**

### 2. 验证机制
目前系统**不会自动验证**是否真的达成流局满贯条件（即舍牌是否全为幺九牌），需要用户自行判断。这是为了：
- 简化实现
- 保持系统的灵活性
- 信任用户的判断

### 3. 点数上限
虽然理论上可以多人同时达成流局满贯，但实际游戏中：
- 4人同时达成几乎不可能
- 2人同时达成已经非常罕见
- 通常只有1人达成

### 4. 与其他规则的冲突
流局满贯与以下情况**不冲突**：
- ✅ 听牌罚符（可以同时计算）
- ✅ 立直棒（正常处理）
- ✅ 本场（正常增加）

---

## 测试建议

### 基础测试
1. 展开/收起流局满贯选项
2. 选择单个玩家（庄家/闲家）
3. 验证点数预览正确
4. 确认流局，检查点数变化
5. 查看历史记录格式

### 复杂场景测试
1. 多人流局满贯（2-4人）
2. 流局满贯 + 听牌罚符
3. 流局满贯 + 立直棒
4. 庄家流局满贯的连庄
5. 切换流局类型时的状态重置

### 边界情况测试
- 所有玩家都选择流局满贯
- 流局满贯 + 所有人听牌
- 流局满贯 + 所有人立直
- 取消流局后重新打开

---

## 总结

这次更新为日本麻将记录器添加了完整的流局满贯支持，主要特点：

1. **默认折叠设计**：不干扰常规流局操作
2. **完整点数计算**：支持单人/多人流局满贯
3. **实时预览**：选择玩家后立即显示点数变化
4. **历史记录完善**：完整记录流局满贯信息
5. **灵活组合**：可与听牌罚符同时计算

所有功能都保持了代码的简洁性和可维护性，没有引入复杂的验证逻辑，充分信任用户的判断能力。
