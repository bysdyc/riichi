# 副露区功能完整说明

## 功能概述

副露区是日本麻将记录器的重要组成部分，用于记录玩家的副露（吃、碰、杠）情况。副露区与手牌区共用一个牌型选择器，实现了统一的交互体验。

## 核心设计原则

### 1. 牌数限制逻辑

#### 基础规则
- **一种牌不能超过4张**：手牌区 + 副露区 + 和牌的总数不能超过4张
- **手牌总数动态调整**：
  - 无杠子时：手牌区应为13张
  - 有杠子时：手牌区 = 13 + 杠子数量
  - 例如：1个杠子时手牌应为14张，2个杠子时为15张

#### 实现细节
```javascript
// 获取所有牌的使用情况
const getTileUsageCount = (tile) => {
  const handCount = selectedTiles.filter(t => t === tile).length;
  const meldCount = melds.reduce((sum, meld) => {
    return sum + meld.tiles.filter(t => t === tile).length;
  }, 0);
  const winTileCount = (winTile === tile) ? 1 : 0;
  return handCount + meldCount + winTileCount;
};

// 计算应有的手牌总数
const getRequiredHandTileCount = () => {
  const kanCount = melds.filter(m => m.type === 'minkan' || m.type === 'ankan').length;
  return 13 + kanCount;
};
```

### 2. 副露类型

副露区支持四种副露类型：

#### 顺子（Shuntsu）
- **触发条件**：点击"顺子"按钮后选择第一张牌
- **自动补全**：以选择的牌为起始，自动补全连续的三张牌
- **限制**：
  - 字牌不能组成顺子
  - 7以上的数字牌不能作为顺子起始牌
- **示例**：选择"2万"，自动生成"2万3万4万"

#### 刻子（Pon）
- **触发条件**：点击"刻子"按钮后选择任意一张牌
- **自动补全**：自动生成三张相同的牌
- **示例**：选择"东"，自动生成"东东东"

#### 明杠（Minkan）
- **触发条件**：点击"明杠"按钮后选择任意一张牌
- **自动补全**：自动生成四张相同的牌
- **效果**：
  - 增加手牌总数限制（+1张）
  - 取消门前状态
  - 符数计算中加入明杠符数

#### 暗杠（Ankan）
- **触发条件**：点击"暗杠"按钮后选择任意一张牌
- **自动补全**：自动生成四张相同的牌
- **效果**：
  - 增加手牌总数限制（+1张）
  - 不影响门前状态
  - 符数计算中加入暗杠符数（符数更高）

### 3. 门前状态管理

#### 自动取消门前
以下副露会自动取消门前状态：
- 顺子（吃牌）
- 刻子（碰牌）
- 明杠

#### 保持门前
- 暗杠不影响门前状态
- 删除所有明副露后可以恢复门前状态

#### UI反馈
```html
<button data-action="toggle-menzen"
  ${melds.some(m => m.type === 'shuntsu' || m.type === 'pon' || m.type === 'minkan') ? 'disabled' : ''}
  class="...${melds.some(...) ? 'opacity-50 cursor-not-allowed' : ''}"
>
  门清 ${melds.some(...) ? '(有明副露)' : ''}
</button>
```

## 符数计算增强

### 副露符数规则

#### 刻子符数
- **明刻**：
  - 幺九牌：4符
  - 中张牌：2符
- **暗刻**（仅在手牌中）：
  - 幺九牌：8符
  - 中张牌：4符

#### 杠子符数
- **明杠**：
  - 幺九牌：16符
  - 中张牌：8符
- **暗杠**：
  - 幺九牌：32符
  - 中张牌：16符

#### 顺子
- 不加符

### 符数计算实现

```javascript
const calculateFu = (combo, winTile, context) => {
  const { isTsumo, isMenzen, playerWind, roundWind, isPinfu, melds: externalMelds } = context;
  
  if (isPinfu) return isTsumo ? 20 : 30;
  
  let fu = 20; // 底符
  
  if (isMenzen && !isTsumo) fu += 10; // 门清荣和
  if (isTsumo) fu += 2; // 自摸
  
  // ... 雀头符数 ...
  
  // 手牌中的刻子
  combo.melds.forEach(m => {
    if (m.type === 'pon') {
      const tile = m.tiles[0];
      let ponFu = yaochuuhai.includes(tile) ? 4 : 2;
      if (isMenzen && (isTsumo || tile !== winTile)) {
        ponFu *= 2; // 暗刻
      }
      fu += ponFu;
    }
  });

  // 副露区的符数
  if (externalMelds && externalMelds.length > 0) {
    externalMelds.forEach(m => {
      if (m.type === 'pon') {
        // 明刻
        const tile = displayToInternal[m.tiles[0]];
        const ponFu = yaochuuhai.includes(tile) ? 4 : 2;
        fu += ponFu;
      } else if (m.type === 'minkan') {
        // 明杠
        const tile = displayToInternal[m.tiles[0]];
        const kanFu = yaochuuhai.includes(tile) ? 16 : 8;
        fu += kanFu;
      } else if (m.type === 'ankan') {
        // 暗杠
        const tile = displayToInternal[m.tiles[0]];
        const kanFu = yaochuuhai.includes(tile) ? 32 : 16;
        fu += kanFu;
      }
    });
  }

  // ... 待牌符数 ...
  
  return Math.ceil(fu / 10) * 10;
};
```

## 用户交互流程

### 添加副露组

1. **选择副露类型**
   - 点击"顺子"、"刻子"、"明杠"或"暗杠"按钮
   - 系统进入副露添加模式，并弹出提示

2. **选择牌**
   - 在下方的牌型选择器中点击一张牌
   - 系统自动验证并补全该副露组

3. **验证规则**
   - 检查每张牌是否超过4张限制
   - 检查添加后总牌数是否符合要求
   - 如果不符合，显示错误提示并取消添加

4. **添加成功**
   - 副露组显示在副露区
   - 如果是明副露，自动取消门前状态
   - 如果是杠，手牌总数限制+1

### 删除副露组

1. 点击副露组右侧的"×"按钮
2. 系统删除该副露组
3. 如果删除后没有明副露，可以恢复门前状态

### 清空副露区

1. 点击"清空副露"按钮
2. 删除所有副露组
3. 恢复门前状态

### 一键清除

点击"一键清除"按钮会同时清空：
- 手牌区
- 副露区
- 恢复门前状态

## UI组件设计

### 副露区显示

```html
<div class="mb-4">
  <div class="flex justify-between items-center mb-1">
    <label class="block text-sm font-bold text-indigo-700">
      副露区 (${melds.length}组)
    </label>
    <!-- 清空按钮（仅在有副露时显示） -->
  </div>
  
  <!-- 副露组列表 -->
  <div class="bg-indigo-50 p-3 rounded-lg mb-2">
    <div class="flex flex-wrap gap-2">
      <!-- 每个副露组 -->
      <div class="inline-flex items-center bg-white rounded-lg border-2 border-indigo-300 p-1">
        <div class="flex gap-0.5 mr-1">
          <!-- 牌显示 -->
        </div>
        <span class="text-xs text-indigo-600 mr-1">顺/刻/明杠/暗杠</span>
        <button data-action="remove-meld">×</button>
      </div>
    </div>
  </div>
  
  <!-- 添加副露控制面板 -->
  <div class="p-2 bg-indigo-50 border border-indigo-200 rounded-lg">
    <p class="text-xs font-bold text-indigo-800 mb-2">添加副露组</p>
    <div class="grid grid-cols-4 gap-1 mb-2">
      <button data-action="set-meld-mode" data-type="shuntsu">顺子</button>
      <button data-action="set-meld-mode" data-type="pon">刻子</button>
      <button data-action="set-meld-mode" data-type="minkan">明杠</button>
      <button data-action="set-meld-mode" data-type="ankan">暗杠</button>
    </div>
    <p class="text-xs text-indigo-600 mt-1">
      💡 顺子：选第一张牌自动补全；刻子/杠：选任意一张
    </p>
  </div>
</div>
```

### 手牌区显示

```html
<div class="mb-4">
  <div class="flex justify-between items-center mb-1">
    <label class="block text-sm font-bold">
      手牌 (${selectedTiles.length}/${getRequiredHandTileCount()})
    </label>
    <button data-action="clear-hand">一键清除</button>
  </div>
  <!-- 手牌显示区 -->
  <!-- 听牌分析 -->
  <!-- 牌型选择器 -->
</div>
```

## 状态管理

### 全局状态

```javascript
let selectedTiles = [];  // 手牌区
let melds = [];         // 副露区
let winTile = null;     // 和牌
let isMenzen = true;    // 门前状态
```

### 副露组数据结构

```javascript
{
  type: 'shuntsu' | 'pon' | 'minkan' | 'ankan',
  tiles: ['牌1', '牌2', '牌3'] // 或4张（杠）
}
```

### 本地存储

副露区数据会与其他游戏状态一起保存到localStorage：

```javascript
const saveGameState = () => {
  const state = {
    // ...其他状态
    selectedTiles,
    melds,
    winTile,
    isMenzen,
    // ...
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
};
```

## 错误处理

### 验证机制

1. **牌数超限**
   ```javascript
   if (getTileUsageCount(tile) + 1 > 4) {
     alert(`${tile} 已达到4张上限，无法添加此副露！`);
     return;
   }
   ```

2. **总数超限**
   ```javascript
   const newTotalCount = getCurrentTotalTileCount() + tiles.length;
   const requiredCount = getRequiredHandTileCount() + tiles.length;
   if (newTotalCount > requiredCount) {
     alert(`添加此副露后总牌数将超过限制！请先调整手牌数量。`);
     return;
   }
   ```

3. **顺子限制**
   ```javascript
   if (suit === 'z' || num > 7) {
     alert('字牌不能组成顺子，数字牌7以上不能作为顺子起始牌！');
     return;
   }
   ```

## 测试清单

### 基础功能测试

- [ ] 添加顺子：选择不同的起始牌
- [ ] 添加刻子：选择不同的牌
- [ ] 添加明杠：选择不同的牌
- [ ] 添加暗杠：选择不同的牌
- [ ] 删除单个副露组
- [ ] 清空所有副露
- [ ] 一键清除（手牌+副露）

### 牌数限制测试

- [ ] 手牌+副露+和牌同一种牌不超过4张
- [ ] 无杠时手牌总数为13张
- [ ] 1个杠时手牌总数为14张
- [ ] 2个杠时手牌总数为15张
- [ ] 多个杠的组合情况

### 门前状态测试

- [ ] 添加顺子后门前被取消
- [ ] 添加刻子后门前被取消
- [ ] 添加明杠后门前被取消
- [ ] 添加暗杠后门前保持
- [ ] 删除明副露后门前可恢复
- [ ] UI显示"(有明副露)"提示

### 符数计算测试

- [ ] 明刻子（幺九牌）：4符
- [ ] 明刻子（中张牌）：2符
- [ ] 明杠（幺九牌）：16符
- [ ] 明杠（中张牌）：8符
- [ ] 暗杠（幺九牌）：32符
- [ ] 暗杠（中张牌）：16符
- [ ] 手牌暗刻与副露明刻混合计算
- [ ] 多个副露组合计算

### 听牌分析测试

- [ ] 有副露时的听牌分析
- [ ] 副露后剩余牌的听牌判定
- [ ] 符数正确计算（包含副露符）

### 边界情况测试

- [ ] 尝试添加第5张相同的牌
- [ ] 顺子使用7、8、9作为起始牌
- [ ] 字牌组成顺子的错误提示
- [ ] 手牌满时添加副露的提示
- [ ] 连续添加多个副露
- [ ] 刷新页面后副露区数据恢复

### 集成测试

- [ ] 完整和牌流程（含副露）
- [ ] 多人和牌时的副露处理
- [ ] 手动模式下的副露记录
- [ ] 老手模式下的符数输入
- [ ] 对局记录导出包含副露信息

## 注意事项

1. **性能考虑**：每次添加/删除副露后都会触发render()，对于大量副露情况需要注意性能

2. **用户体验**：
   - 提供清晰的错误提示
   - 添加副露前弹出提示说明
   - 使用不同颜色区分副露类型

3. **数据一致性**：
   - 副露区与手牌区数据完全独立
   - 通过getTileUsageCount统一管理牌数
   - 门前状态自动同步

4. **扩展性**：
   - 副露组数据结构支持未来扩展（如记录副露来源）
   - 符数计算函数模块化，便于调整规则

## 后续优化建议

1. **视觉优化**
   - 副露组使用不同背景色区分类型
   - 添加动画效果提升交互体验
   - 移动端适配优化

2. **功能增强**
   - 记录副露来源（上家/对家/下家）
   - 支持副露组排序/调整
   - 副露历史记录

3. **验证增强**
   - 更详细的错误提示
   - 实时显示可添加的副露类型
   - 智能推荐副露组合

4. **数据分析**
   - 统计副露使用频率
   - 分析副露对胜率的影响
   - 生成副露习惯报告
