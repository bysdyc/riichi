# 副露区功能实现说明

## 📋 概述

为日本麻将记录器添加了完整的副露区（鸣牌区）功能，使符数计算更加准确和完整。

## ✨ 新增功能

### 1. 副露类型支持

系统现在支持5种副露类型：

| 副露类型 | 说明 | 牌数 | 是否明副露 | 符数计算 |
|---------|------|------|-----------|---------|
| **吃 (chi)** | 同花色顺子（如1-2-3万） | 3张 | ✅ 是 | 0符 |
| **碰 (pon)** | 3张相同牌（如中中中） | 3张 | ✅ 是 | 老头牌4符，中张牌2符 |
| **明杠 (minkan)** | 4张相同牌，明杠 | 4张 | ✅ 是 | 老头牌16符，中张牌8符 |
| **暗杠 (ankan)** | 4张相同牌，暗杠 | 4张 | ❌ 否 | 老头牌32符，中张牌16符 |
| **加杠 (kakan)** | 在已碰的基础上加杠 | 4张 | ✅ 是 | 老头牌16符，中张牌8符 |

### 2. 副露区界面

#### 显示区域
- 显示所有已添加的副露
- 每个副露显示：类型、牌面、删除按钮
- 明副露（橙色边框）和暗副露（绿色边框）区分显示
- 副露计数器显示当前副露数量

#### 操作功能
- **添加副露**：点击对应按钮打开选牌对话框
- **删除副露**：点击副露右侧的删除按钮
- **清空副露**：一键清除所有副露

### 3. 添加副露对话框

交互式对话框，支持：
- 实时显示已选牌（当前选择/需要选择）
- 分类显示可选牌（万子/饼子/索子/字牌）
- 达到要求数量后自动禁用其他牌
- 实时验证副露合法性
- 错误提示（如花色不匹配、数字不连续等）

### 4. 副露验证逻辑

#### 吃（chi）验证
```javascript
- 必须是3张牌
- 必须是数牌（万/饼/索）
- 必须是同花色
- 必须是连续数字（如1-2-3）
```

#### 碰（pon）验证
```javascript
- 必须是3张相同的牌
```

#### 杠（minkan/ankan/kakan）验证
```javascript
- 必须是4张相同的牌
```

### 5. 符数计算增强

#### 新增 extraMelds 参数
`calculateFu` 函数现在接受 `extraMelds` 参数，用于处理副露区的面子符数。

#### 符数计算规则

**顺子（吃）**：
- 0符（不加符）

**刻子（碰）**：
- 明刻：老头牌 4符，中张牌 2符
- 暗刻：老头牌 8符，中张牌 4符

**杠子**：
- 明杠：老头牌 16符，中张牌 8符
- 暗杠：老头牌 32符，中张牌 16符
- 加杠：视为明杠（老头牌 16符，中张牌 8符）

**老头牌定义**：
- 数牌的1和9（1万、9万、1饼、9饼、1索、9索）
- 所有字牌（东南西北白发中）

### 6. 门清状态管理

- 添加明副露（吃/碰/明杠/加杠）时，自动设置 `isMenzen = false`
- 添加暗杠时，不影响门清状态
- 删除副露后，自动检查是否还有明副露
- 如果没有明副露，自动恢复 `isMenzen = true`

## 🔧 技术实现

### 状态变量

```javascript
let melds = []; // 副露数组
// 每个副露对象结构：
{
  type: 'chi' | 'pon' | 'minkan' | 'ankan' | 'kakan',
  tiles: ['1万', '2万', '3万'],  // 牌面数组
  isOpen: true | false            // 是否明副露
}
```

### 核心函数

1. **addMeld(type, tiles)** - 添加副露
2. **removeMeld(index)** - 删除副露
3. **clearMelds()** - 清空副露
4. **showAddMeldDialog(meldType)** - 显示添加副露对话框
5. **calculateFu(..., { extraMelds })** - 增强的符数计算

### 数据持久化

副露数据已集成到 localStorage 存储系统：
- 保存时自动存储 `melds` 数组
- 加载时自动恢复副露数据
- 重置游戏时自动清空副露

## 📊 使用示例

### 示例1：基本和牌（带碰）

**手牌**：1万2万3万4万5万6万 东东（7张）
**副露**：碰（中中中）
**和牌**：7万

**符数计算**：
- 底符：20符
- 碰（中中中）：4符（字牌明刻）
- 门清荣和：0符（因为有碰，不是门清）
- 总计：24符 → 进位到 30符

### 示例2：多副露和牌

**手牌**：1万2万3万 白白（5张）
**副露**：
- 吃（4饼5饼6饼）
- 碰（9索9索9索）
**和牌**：白

**符数计算**：
- 底符：20符
- 吃（4饼5饼6饼）：0符
- 碰（9索9索9索）：4符（老头牌明刻）
- 雀头（白白）：2符（三元牌）
- 单骑：2符
- 总计：28符 → 进位到 30符

### 示例3：暗杠和牌

**手牌**：2万3万4万 东东东（7张）
**副露**：暗杠（发发发发）
**和牌**：1万

**符数计算**：
- 底符：20符
- 暗杠（发发发发）：16符（字牌暗杠）
- 刻子（东东东）：8符（字牌暗刻，门清状态）
- 门清荣和：10符（暗杠不影响门清）
- 边张：2符
- 总计：56符 → 进位到 60符

## ✅ 验证要点

### 符数计算严格性

1. **刻子区分**：
   - 正确区分明刻和暗刻
   - 正确区分老头牌和中张牌

2. **杠子区分**：
   - 明杠、暗杠、加杠符数不同
   - 暗杠不影响门清状态

3. **门清判断**：
   - 有明副露时不能算门清役
   - 有明副露时不加门清荣和10符
   - 暗杠不破坏门清

4. **符数进位**：
   - 所有符数按10符进位
   - 特殊情况（平和）：自摸20符，荣和30符

### UI/UX考虑

1. **直观显示**：明副露和暗副露用不同颜色区分
2. **操作便捷**：快速添加、删除副露
3. **错误提示**：实时验证并提示错误原因
4. **防误操作**：确认对话框，可撤销操作

## 🎯 改进建议

### 已实现的功能
- ✅ 完整的副露类型支持
- ✅ 准确的符数计算
- ✅ 门清状态自动管理
- ✅ 数据持久化
- ✅ 用户友好的界面

### 未来可能的增强
- 🔄 副露牌自动从手牌中扣除（避免重复计算）
- 🔄 副露顺序调整（拖拽排序）
- 🔄 副露来源标记（从哪家鸣的牌）
- 🔄 副露历史记录
- 🔄 副露快捷键支持

## 🐛 注意事项

1. **副露与手牌独立**：
   - 当前副露区的牌不会自动从手牌中扣除
   - 用户需要手动确保手牌+副露的牌数合理（通常手牌13张）

2. **七对子限制**：
   - 七对子不能有副露
   - 系统会在役种检测时自动处理

3. **国士无双限制**：
   - 国士无双不能有副露
   - 系统会在役种检测时自动处理

4. **符数下限**：
   - 荣和最少30符（除平和20符）
   - 自摸最少20符

## 📝 代码变更总结

### 新增变量
- `melds` - 副露数组

### 修改函数
- `calculateFu()` - 增加 extraMelds 参数处理
- `saveGameState()` - 保存副露数据
- `loadGameState()` - 加载副露数据
- `resetGame()` - 清空副露数据

### 新增函数
- `addMeld(type, tiles)`
- `removeMeld(index)`
- `clearMelds()`
- `showAddMeldDialog(meldType)`

### UI变更
- 新增副露区显示区域
- 新增添加副露按钮组
- 新增副露对话框
- 新增副露删除按钮

---

**版本**：v4.1
**更新日期**：2025-10-28
**状态**：✅ 已完成并测试
