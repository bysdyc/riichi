# 四杠子役种与多倍役满支持说明

## 修改时间
2025年10月29日

## 改进内容

### 1. 添加四杠子役种检测

#### 问题描述
之前代码中有四杠子的注释，但实际功能未实现：
```javascript
// 四杠子 (役满) - 需要扩展面子类型支持杠子
// 注: 当前简化版未实现明杠/暗杠区分，此处预留
```

实际上副露系统已经支持明杠（minkan）和暗杠（ankan），只是没有实现检测逻辑。

#### 解决方案
添加四杠子的检测逻辑：

```javascript
// 四杠子 (役满)
const kanCount = melds.filter(m => m.type === 'minkan' || m.type === 'ankan').length;
if (kanCount === 4) {
    yaku.push('四杠子'); han += 13;
}
```

#### 实现细节

**检测逻辑：**
1. 统计副露区（melds）中的所有杠子数量
2. 包括明杠（minkan）和暗杠（ankan）
3. 当杠子总数等于4时，判定为四杠子役满
4. 加13番（1倍役满）

**位置：**
- 放在四暗刻检测之后
- 在 `if (han >= 13) return { yaku, han };` 之前
- 确保与其他役满正确叠加

**副露类型支持：**
- `'shuntsu'` - 顺子（吃）
- `'pon'` - 刻子（碰）
- `'minkan'` - 明杠（大明杠、加杠）
- `'ankan'` - 暗杠

#### 使用示例

添加4个杠子到副露区：
1. 点击"🎴 副露区"激活
2. 选择"明杠"或"暗杠"
3. 点击麻将牌（例如：1m）自动生成4张
4. 重复4次
5. 和牌时自动识别为"四杠子"役满

---

### 2. 支持多倍复合役满

#### 问题描述
之前的分数计算逻辑只支持到双倍役满（26番）：

```javascript
// 旧代码
if (han >= 13) { 
  base = (han >= 26 ? 2 : 1) * (isDealer ? 48000 : 32000); 
  isMangan = true; 
}
```

这意味着：
- 26番 = 双倍役满 ✓
- 39番 = 仍然按双倍役满计算 ✗（错误）
- 52番及以上 = 仍然按双倍役满计算 ✗（错误）

#### 解决方案
修改分数计算逻辑，支持任意倍数的役满：

```javascript
// 新代码
if (han >= 13) { 
  const yakumanMultiplier = Math.floor(han / 13); // 计算役满倍数
  base = yakumanMultiplier * (isDealer ? 48000 : 32000); 
  isMangan = true; 
}
```

#### 支持的倍数

| 番数范围 | 役满倍数 | 庄家基本点 | 非庄基本点 | 名称 |
|---------|---------|-----------|-----------|------|
| 13-25番 | 1倍 | 48000 | 32000 | 役满 |
| 26-38番 | 2倍 | 96000 | 64000 | 双倍役满 |
| 39-51番 | 3倍 | 144000 | 96000 | 三倍役满 |
| 52-64番 | 4倍 | 192000 | 128000 | 四倍役满 |
| 65-77番 | 5倍 | 240000 | 160000 | 五倍役满 |
| 78-90番 | 6倍 | 288000 | 192000 | 六倍役满 |
| ...以此类推 | | | | |

#### 计算公式

```javascript
役满倍数 = Math.floor(番数 / 13)
基本点 = 役满倍数 × (庄家 ? 48000 : 32000)
```

**示例：**
- 13番 → Math.floor(13/13) = 1倍 → 48000
- 26番 → Math.floor(26/13) = 2倍 → 96000
- 39番 → Math.floor(39/13) = 3倍 → 144000
- 52番 → Math.floor(52/13) = 4倍 → 192000

---

### 3. 添加役满等级显示辅助函数

为了方便在多处显示役满等级，添加了统一的辅助函数：

```javascript
// 获取役满等级名称
const getYakumanLevelName = (han) => {
  if (han >= 78) return ' (六倍役满)';
  if (han >= 65) return ' (五倍役满)';
  if (han >= 52) return ' (四倍役满)';
  if (han >= 39) return ' (三倍役满)';
  if (han >= 26) return ' (双倍役满)';
  if (han >= 13) return ' (役满)';
  if (han >= 11) return ' (三倍满)';
  if (han >= 8) return ' (倍满)';
  if (han >= 6) return ' (跳满)';
  if (han >= 5) return ' (满贯)';
  return '';
};
```

**使用位置：**
1. 多人和牌界面的番符显示
2. 老手模式的当前设置显示
3. 其他所有需要显示役满等级的地方

**替换前：**
```javascript
${data.han >= 26 ? ' (双倍役满)' : data.han >= 13 ? ' (役满)' : data.han >= 11 ? ' (三倍满)' : ...}
```

**替换后：**
```javascript
${getYakumanLevelName(data.han)}
```

---

### 4. 扩展老手模式番数选择范围

#### 修改内容

**番数快捷按钮：**
- 之前：`[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 26]`
- 现在：`[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 26, 39, 52]`

新增：
- 39番（三倍役满）
- 52番（四倍役满）

**自定义番数输入框：**
- 之前：max="99"
- 现在：max="130"
- 提示文字：从"自定义番数"改为"自定义番数（最高130）"

#### 理论最高番数

虽然实际游戏中几乎不可能达到，但理论上可以叠加到非常高的番数：
- 大四喜（26番）+ 字一色（13番）+ 四杠子（13番）+ ... = 理论可超过100番
- 设置上限130番是为了避免溢出，同时保留足够的可扩展性

---

## 可能的多倍役满组合

### 双倍役满（26番）
单个役种：
- **大四喜**（26番）
- **纯正九莲宝灯**（26番）
- **四暗刻单骑**（26番）

### 三倍役满（39番）
理论组合示例：
- 大四喜（26番）+ 字一色（13番）= 39番
- 纯正九莲宝灯（26番）+ 天和（13番）= 39番

### 四倍役满（52番）
理论组合示例：
- 大四喜（26番）+ 字一色（13番）+ 四杠子（13番）= 52番

### 更高倍数
虽然在实际游戏中几乎不可能，但系统现在支持任意倍数的役满计算。

---

## 实际点数示例

### 一倍役满（13番）
**庄家自摸：**
- 基本点：48000
- 每家：16000
- 总共：48000点

**非庄荣和：**
- 基本点：32000
- 放铳者：32000
- 总共：32000点

### 双倍役满（26番）
**庄家自摸：**
- 基本点：96000
- 每家：32000
- 总共：96000点

**非庄荣和：**
- 基本点：64000
- 放铳者：64000
- 总共：64000点

### 三倍役满（39番）
**庄家自摸：**
- 基本点：144000
- 每家：48000
- 总共：144000点

**非庄荣和：**
- 基本点：96000
- 放铳者：96000
- 总共：96000点

### 四倍役满（52番）
**庄家自摸：**
- 基本点：192000
- 每家：64000
- 总共：192000点

**非庄荣和：**
- 基本点：128000
- 放铳者：128000
- 总共：128000点

---

## 代码修改总结

### 文件修改位置

1. **役种检测（analyzeHand 函数）**
   - 添加四杠子检测逻辑
   - 位置：约第560行

2. **分数计算（calculateScore 函数）**
   - 修改役满倍数计算逻辑
   - 位置：约第1390行

3. **辅助函数（全局）**
   - 添加 getYakumanLevelName 函数
   - 位置：约第1368行

4. **UI显示（render 函数）**
   - 替换所有役满等级显示
   - 位置：多处

5. **老手模式UI**
   - 扩展番数选择按钮
   - 提高自定义番数上限
   - 位置：约第3170行

---

## 测试建议

### 四杠子测试
1. 添加4个杠子（明杠或暗杠均可）
2. 选择手牌和和牌
3. 验证显示"四杠子 (役满)"
4. 验证点数计算正确（基本点48000/32000）

### 多倍役满测试
使用老手模式快速测试：
1. 切换到老手模式
2. 选择番数：13、26、39、52等
3. 验证显示：役满、双倍役满、三倍役满、四倍役满
4. 验证点数计算：每13番增加一倍

### 边界值测试
- 12番：倍满（不是役满）
- 13番：役满
- 25番：役满（不是双倍）
- 26番：双倍役满
- 38番：双倍役满（不是三倍）
- 39番：三倍役满
- 130番：理论最高（六倍役满以上）

---

## 兼容性说明

### 向后兼容
- ✅ 所有现有役种计算不受影响
- ✅ 原有双倍役满（大四喜、纯正九莲、四暗刻单骑）正常工作
- ✅ 原有点数计算逻辑完全兼容
- ✅ 老手模式原有功能保持不变

### 新增功能
- ✅ 四杠子自动识别
- ✅ 三倍及以上役满正确计算
- ✅ 老手模式支持更高番数
- ✅ 统一的役满等级显示

---

## 注意事项

### 实际游戏规则
不同麻将规则对役满的处理不同：
- **日本麻将**：通常支持役满叠加
- **中国麻将**：通常取最高役满，不叠加
- **本系统**：支持日本麻将规则的役满叠加

### 理论 vs 实际
虽然系统支持最高130番，但实际游戏中：
- 单倍役满（13番）已经很稀有
- 双倍役满（26番）极为罕见
- 三倍及以上（39番+）几乎不可能出现

支持高倍役满主要是为了：
1. 系统完整性
2. 理论完备性
3. 特殊场景（如教学、演示）

---

## 总结

这次更新主要解决了两个问题：
1. **补全缺失的役种**：添加了四杠子的实现
2. **修复计算上限**：支持三倍及以上的复合役满

所有修改都保持了代码的简洁性和可维护性，没有引入复杂的新逻辑，只是补全和扩展了现有功能。
