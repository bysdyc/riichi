# 手牌上限计算修复说明

## 问题描述

1. **杠子计算错误**: `calculateMaxHandTiles` 函数将暗杠按减4张计算,但实际上杠子会补牌,应该减3张
2. **副露添加未检查**: 添加副露时没有检查是否会导致现有手牌超出新的上限

## 修复内容

### 1. 修正 `calculateMaxHandTiles` 函数

**修改前**:
```javascript
if (type === 'shuntsu' || type === 'pon' || type === 'minkan') {
  maxTiles -= 3;
} else if (type === 'ankan') {
  maxTiles -= 4;  // ❌ 错误: 没有考虑补牌
}
```

**修改后**:
```javascript
if (type === 'shuntsu' || type === 'pon') {
  maxTiles -= 3;
} else if (type === 'minkan' || type === 'ankan') {
  // ✅ 正确: 杠子4张副露 - 1张补牌 = 减3
  maxTiles -= 3;
}
```

### 2. 副露添加前检查手牌上限

在 `handleMeldTileSelection` 函数中添加检查:

```javascript
// 计算添加副露后的最大手牌数
const nextMelds = [...this.data.singleWinMelds, meld];
const maxHandTiles = this.calculateMaxHandTiles(nextMelds);

// 检查当前手牌数是否超出新的上限
const currentHandCount = this.data.singleWinHandTiles.length;
if (currentHandCount > maxHandTiles) {
  const excessTiles = currentHandCount - maxHandTiles;
  this.showToast(`添加副露后手牌超出上限,请先移除 ${excessTiles} 张手牌`);
  return;
}
```

## 计算示例

### 场景1: 无副露
- 基础: 13张
- 副露: 0组
- **最大手牌**: 13张

### 场景2: 1组顺子
- 基础: 13张
- 顺子: -3张
- **最大手牌**: 10张

### 场景3: 1组明杠
- 基础: 13张
- 明杠: -3张 (4张副露 - 1张补牌)
- **最大手牌**: 10张 ✅

### 场景4: 2组杠子
- 基础: 13张
- 明杠: -3张
- 暗杠: -3张
- **最大手牌**: 7张 ✅

### 场景5: 4组副露
- 基础: 13张
- 顺子: -3张
- 刻子: -3张
- 明杠: -3张
- 暗杠: -3张
- **最大手牌**: 1张 ✅

## 相关函数

### `getRequiredHandTileCount(handTiles, externalMelds)`
此函数计算"需要"的手牌数量(已有正确逻辑):
```javascript
const totalExternalTiles = melds.reduce((sum, meld) => sum + meld.tiles.length, 0);
const kanCount = melds.filter(meld => KAN_TYPES.has(meld.type)).length;
const required = 13 + kanCount - totalExternalTiles;
```

示例: 1个明杠(4张牌)
- `required = 13 + 1 - 4 = 10` ✅

### `calculateMaxHandTiles(melds)`
此函数计算"最多能有"的手牌数量(已修复):
```javascript
let maxTiles = 13;
melds.forEach(meld => {
  if (type === 'shuntsu' || type === 'pon') {
    maxTiles -= 3;
  } else if (type === 'minkan' || type === 'ankan') {
    maxTiles -= 3;  // 4张副露 - 1张补牌
  }
});
```

## 用户体验改进

1. **杠子正确计算**: 添加杠子后,手牌上限正确显示为 10张(而不是9张)
2. **防止超限**: 当手牌有13张时,无法添加副露,提示需要先移除手牌
3. **清晰提示**: 明确告知用户需要移除多少张手牌才能添加副露

## 测试用例

- ✅ 无副露: 最大13张
- ✅ 1顺子: 最大10张
- ✅ 1刻子: 最大10张
- ✅ 1明杠: 最大10张
- ✅ 1暗杠: 最大10张
- ✅ 4副露: 最大1张
- ✅ 手牌13张时添加副露: 提示先移除手牌
