# 历史记录多人和牌支持改进说明

## 改进概述

为历史记录功能添加了完整的多人和牌支持,包括数据记录、界面显示和导出功能。

---

## 1. 数据记录增强

### 新增字段
在多人和牌的 `roundData` 中添加以下专用字段:

```javascript
{
  // ... 原有字段 ...
  
  // 多人和牌专用字段
  isMultiWin: true,              // 标记为多人和牌
  multiWinCount: 2,              // 和牌人数(2或3)
  winnersDetails: [              // 每个和牌者的详细信息
    {
      name: "玩家A",
      wind: "东",
      han: 4,
      fu: 30,
      score: 12000,
      isDealer: true
    },
    {
      name: "玩家B",
      wind: "南",
      han: 5,
      fu: 30,
      score: 12000,
      isDealer: false
    }
  ]
}
```

### 数据收集逻辑
```javascript
// 为每个和牌者收集详细信息
const winnersDetails = multiWinners.map(winnerIdx => {
  const data = multiWinHanFu[winnerIdx] || { han: 0, fu: 0 };
  const isDealer = winnerIdx === currentDealerIndex;
  const scoreData = calculateScore(data.han, data.fu, false, isDealer);
  return {
    name: players[winnerIdx].name,
    wind: players[winnerIdx].wind,
    han: data.han,
    fu: data.fu,
    score: scoreData ? scoreData.total : 0,
    isDealer: isDealer
  };
});
```

---

## 2. 界面显示改进

### 多人和牌标签
```html
<span class="px-3 py-1 rounded-full text-sm font-bold bg-purple-200 text-purple-800">
  多人和牌
</span>
```
- **颜色**: 紫色背景 (`bg-purple-200`)
- **区别**: 与普通和牌(蓝色)、自摸(绿色)、流局(灰色)区分

### 详细信息卡片
```
┌─────────────────────────────────────────┐
│ 🎉 2家和牌  放铳者: 西 玩家C           │
├─────────────────────────────────────────┤
│ ┌─────────────────────────────────────┐ │
│ │ 东 玩家A [庄]    4番 30符  +12,000 │ │
│ └─────────────────────────────────────┘ │
│ ┌─────────────────────────────────────┐ │
│ │ 南 玩家B         5番 30符  +12,000 │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│ 总计得分: 24,000 点                     │
│ 💰 立直棒: +1,000 (平均分配)           │
└─────────────────────────────────────────┘
```

### 界面元素
1. **标题栏**: 显示和牌人数和放铳者
2. **和牌者列表**: 每人一张卡片,包含:
   - 风位 + 姓名
   - 庄家标记(黄色徽章)
   - 番符数值
   - 得分(绿色)
3. **总计区域**: 汇总得分和立直棒

---

## 3. 导出功能增强

### 文本格式输出

#### 多人和牌示例:
```
【第 5 局】
  局数: 东1局 0本场
  庄家: 玩家A
  类型: 多人和牌
  🎉 2家和牌 (三家和)
  放铳者: 玩家C
  --- 和牌者详情 ---
    1. 东 玩家A [庄]
       番符: 4番30符
       得点: +12,000 点
    2. 南 玩家B
       番符: 5番30符
       得点: +12,000 点
  ------------------
  总得分: 24,000 点
  立直棒: +1,000 点 (平均分配)
  分数变化:
    玩家A: +12,500
    玩家B: +12,500
    玩家C: -25,000
    玩家D: +0
  当前分数:
    玩家A: 37,500
    玩家B: 37,500
    玩家C: 0
    玩家D: 25,000
```

#### 普通和牌示例:
```
【第 1 局】
  局数: 东1局 0本场
  庄家: 玩家A
  类型: 荣和
  和牌者: 玩家B
  放铳者: 玩家C
  役种: 立直, 一发, 平和
  番符: 3番30符
  得点: 5,800 点
  ...
```

### 关键改进
- ✅ 多人和牌使用专用格式
- ✅ 显示每个和牌者的详细信息
- ✅ 标注庄家身份
- ✅ 注明立直棒分配方式
- ✅ 保持向后兼容(普通和牌不受影响)

---

## 4. 视觉设计

### 颜色方案
| 元素 | 颜色 | 用途 |
|------|------|------|
| 背景 | `bg-purple-50` | 多人和牌卡片底色 |
| 边框 | `border-purple-200` | 卡片边框 |
| 标签 | `bg-purple-200 text-purple-800` | 类型标签 |
| 标题 | `text-purple-700` | 和牌人数标题 |
| 得分 | `text-emerald-700` | 正向得分 |
| 失分 | `text-red-600` | 放铳者失分 |
| 庄家 | `bg-yellow-200 text-yellow-800` | 庄家徽章 |

### 图标使用
- 🎉 - 多人和牌标题
- 💰 - 立直棒奖励
- [庄] - 庄家徽章

---

## 5. 数据完整性

### 必填字段验证
```javascript
// 多人和牌必须包含:
✅ isMultiWin: true
✅ multiWinCount: 2 或 3
✅ winnersDetails: 非空数组
✅ loser: 放铳者姓名

// 每个 winnerDetail 必须包含:
✅ name: 姓名
✅ wind: 风位
✅ han: 番数
✅ fu: 符数
✅ score: 得分
✅ isDealer: 是否庄家
```

### 向后兼容
- 旧版本记录(无 `isMultiWin` 字段)仍按普通和牌显示
- 不影响已有历史记录的读取
- 自动判断显示格式

---

## 6. 使用示例

### 场景: 三家和
**东1局 0本场,东家(玩家A)和南家(玩家B)同时荣和西家(玩家C)**

#### 历史记录显示:
```
╔═══════════════════════════════════════════╗
║ 东1局 0本场        庄家: 玩家A  [多人和牌]║
╠═══════════════════════════════════════════╣
║ 🎉 2家和牌  放铳者: 西 玩家C              ║
║ ┌───────────────────────────────────────┐ ║
║ │ 东 玩家A [庄]    4番 30符   +12,000  │ ║
║ └───────────────────────────────────────┘ ║
║ ┌───────────────────────────────────────┐ ║
║ │ 南 玩家B         3番 30符    +5,800  │ ║
║ └───────────────────────────────────────┘ ║
║ ─────────────────────────────────────── ║
║ 总计得分: 17,800 点                       ║
║ 💰 立直棒: +1,000 (平均分配)             ║
╠═══════════════════════════════════════════╣
║ 分数变化:                                 ║
║ 玩家A: +12,500   玩家B: +6,300            ║
║ 玩家C: -18,800   玩家D: +0                ║
╚═══════════════════════════════════════════╝
```

#### 导出文本:
```
【第 1 局】
  局数: 东1局 0本场
  庄家: 玩家A
  类型: 多人和牌
  🎉 2家和牌 (三家和)
  放铳者: 玩家C
  --- 和牌者详情 ---
    1. 东 玩家A [庄]
       番符: 4番30符
       得点: +12,000 点
    2. 南 玩家B
       番符: 3番30符
       得点: +5,800 点
  ------------------
  总得分: 17,800 点
  立直棒: +1,000 点 (平均分配)
  分数变化:
    玩家A: +12,500
    玩家B: +6,300
    玩家C: -18,800
    玩家D: +0
```

---

## 7. 技术细节

### 条件渲染逻辑
```javascript
${round.isMultiWin ? `
  <!-- 多人和牌专用显示 -->
  <div class="mb-3 p-3 bg-purple-50 rounded-lg border-2 border-purple-200">
    ${round.winnersDetails.map(winner => `...`).join('')}
  </div>
` : `
  <!-- 普通和牌显示 -->
  <div class="mb-2">...</div>
`}
```

### 数据查询
```javascript
// 检查是否为多人和牌
if (round.isMultiWin && round.winnersDetails) {
  // 使用多人和牌格式
  round.winnersDetails.forEach(winner => {
    // 处理每个和牌者
  });
}
```

---

## 8. 测试清单

- [x] 2家和牌正确显示
- [x] 3家和牌正确显示
- [x] 庄家标记正确显示
- [x] 番符数值正确显示
- [x] 得分计算正确
- [x] 立直棒分配正确
- [x] 放铳者标注正确
- [x] 总分数汇总正确
- [x] 分数变化显示正确
- [x] 导出文本格式正确
- [x] 普通和牌不受影响
- [x] 流局记录不受影响
- [x] 历史记录排序正确
- [x] 旧版数据兼容

---

## 9. 未来改进方向

### 可选功能
1. **统计分析**: 
   - 统计多人和牌发生频率
   - 分析哪些玩家最容易放铳给多家

2. **图表展示**:
   - 多人和牌占比饼图
   - 各玩家多人和牌胜率

3. **筛选功能**:
   - 只显示多人和牌记录
   - 按和牌类型筛选

4. **详细分析**:
   - 多人和牌的平均得分
   - 最高得分的三家和记录

---

## 版本信息

- **更新日期**: 2025-01-XX
- **版本**: v1.4
- **影响范围**: 历史记录显示、导出功能
- **向后兼容**: 是
- **数据迁移**: 不需要(自动识别格式)
