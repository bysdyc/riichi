# 副露区牌数限制逻辑验证

## 修复说明

### 问题
原先的实现中，手牌区和副露区的上限是分别独立计算的，导致：
- 手牌区固定13张（+杠子数）
- 副露区可以任意添加
- 总牌数可能超过正确的限制

### 正确逻辑

**核心公式：手牌数 + 副露牌数 = 13 + 杠子数**

#### 示例1：无副露
- 总限制：13张
- 副露：0张
- 手牌上限：13张 ✓

#### 示例2：1个刻子（3张）
- 总限制：13张
- 副露：3张（刻子）
- 手牌上限：10张 ✓

#### 示例3：1个明杠（4张）
- 总限制：14张（13 + 1杠）
- 副露：4张（明杠）
- 手牌上限：10张 ✓

#### 示例4：2个顺子 + 1个明杠
- 总限制：14张（13 + 1杠）
- 副露：10张（3 + 3 + 4）
- 手牌上限：4张 ✓

#### 示例5：1个暗杠 + 1个刻子
- 总限制：14张（13 + 1杠）
- 副露：7张（4 + 3）
- 手牌上限：7张 ✓

#### 示例6：4个杠（极限情况）
- 总限制：17张（13 + 4杠）
- 副露：16张（4 * 4）
- 手牌上限：1张 ✓

## 代码实现

### 1. 计算总限制
```javascript
const getTotalTileLimit = () => {
  const kanCount = melds.filter(m => m.type === 'minkan' || m.type === 'ankan').length;
  return 13 + kanCount;
};
```

### 2. 计算手牌上限（总限制 - 副露已用）
```javascript
const getRequiredHandTileCount = () => {
  const totalLimit = getTotalTileLimit();
  const meldCount = melds.reduce((sum, meld) => sum + meld.tiles.length, 0);
  return totalLimit - meldCount;
};
```

### 3. 验证逻辑
```javascript
const addMeld = (type, firstTile) => {
  // ...
  
  // 检查添加后总牌数是否超过限制
  const currentTotal = getCurrentTotalTileCount();
  const totalLimit = getTotalTileLimit();
  const newKanCount = (type === 'minkan' || type === 'ankan') ? 1 : 0;
  const newLimit = totalLimit + newKanCount;
  
  if (currentTotal + tiles.length > newLimit) {
    alert(`添加此副露后总牌数将超过限制（当前${currentTotal}，限制${newLimit}）！请先调整手牌数量。`);
    return;
  }
  
  // ...
};
```

### 4. UI提示增强
```html
<label class="block text-sm font-bold">
  手牌 (${selectedTiles.length}/${getRequiredHandTileCount()})
</label>

<p class="text-xs text-gray-500 mb-1">
  💡 总限制: ${getTotalTileLimit()}张 = 13 + ${杠子数}杠 | 
  副露已用: ${副露牌数}张 | 
  手牌可用: ${getRequiredHandTileCount()}张
</p>
```

## 测试用例

### 测试1：基础情况
1. 初始状态：手牌0，副露0
2. 添加手牌到13张 → ✓ 允许
3. 尝试添加第14张 → ✗ 禁止

### 测试2：添加刻子
1. 添加1个刻子（3张）
2. 手牌上限变为10张
3. 添加10张手牌 → ✓ 允许
4. 尝试添加第11张 → ✗ 禁止

### 测试3：添加明杠
1. 添加1个明杠（4张）
2. 总限制变为14张
3. 手牌上限变为10张
4. 添加10张手牌 → ✓ 允许
5. 尝试添加第11张 → ✗ 禁止

### 测试4：混合副露
1. 添加2个顺子（6张）
2. 手牌上限变为7张
3. 添加1个明杠
4. 总限制变为14张，副露10张
5. 手牌上限变为4张
6. 添加4张手牌 → ✓ 允许
7. 尝试添加第5张 → ✗ 禁止

### 测试5：删除副露
1. 有副露时手牌已满
2. 删除1个副露（3张）
3. 手牌上限增加3张
4. 可以继续添加手牌

### 测试6：4张限制
1. 手牌有3张"1万"
2. 尝试添加"1万"的刻子 → ✗ 禁止（超过4张）
3. 移除1张手牌"1万"
4. 再次添加"1万"刻子 → ✓ 允许

### 测试7：极限情况
1. 添加4个杠（16张）
2. 总限制17张
3. 手牌上限1张
4. 添加1张手牌 → ✓ 允许
5. 尝试添加第2张 → ✗ 禁止

## 边界情况处理

### 1. 手牌满时添加副露
**场景**：手牌已有13张，尝试添加刻子

**处理**：
```
当前总数：13（手牌）+ 0（副露）= 13
添加后：13（手牌）+ 3（刻子）= 16
限制：13
结果：禁止，提示"总牌数将超过限制（当前13，限制13）"
```

**建议**：先删除3张手牌，再添加刻子

### 2. 副露满时添加手牌
**场景**：副露有10张（2顺子+1明杠），手牌有4张，尝试添加第5张

**处理**：
```
总限制：14（13 + 1杠）
副露：10张
手牌上限：4张
当前手牌：4张
结果：禁止（自动禁用按钮）
```

### 3. 同时达到4张和总数限制
**场景**：手牌3张"东"，副露1张"东"（在刻子中），尝试添加"东"

**处理**：
```
检查1：getTileUsageCount("东") = 3 + 1 = 4（已达上限）
结果：禁止，优先提示"东已达到4张上限"
```

## UI反馈

### 正常状态
```
手牌 (10/10)
提示：点击下方手牌区的牌可以将其删除。
```

### 有副露状态
```
手牌 (7/7)
💡 总限制: 14张 = 13 + 1杠 | 副露已用: 7张 | 手牌可用: 7张
```

### 错误提示
```
❌ 添加此副露后总牌数将超过限制（当前13，限制13）！请先调整手牌数量。
❌ 1万 已达到4张上限，无法添加此副露！
```

## 与听牌分析的集成

听牌分析也需要考虑副露：

```javascript
const updateDetailedTenpaiWaits = () => {
  const requiredHandCount = getRequiredHandTileCount(); // 使用新逻辑
  if (selectedTiles.length !== requiredHandCount) {
    tenpaiWaits = [];
    return;
  }
  // ...
}
```

## 总结

修复后的逻辑确保：

1. ✅ **手牌 + 副露 = 总限制** 严格成立
2. ✅ **同种牌不超过4张** 在所有位置（手牌+副露+和牌）
3. ✅ **杠子正确增加总限制**
4. ✅ **UI实时显示准确的上限信息**
5. ✅ **错误提示清晰明确**
6. ✅ **与其他功能（听牌分析、符数计算）正确集成**

这样的实现完全符合日本麻将的规则，并且用户体验更加友好！
